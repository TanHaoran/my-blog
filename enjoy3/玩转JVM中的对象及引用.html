<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>玩转JVM中的对象及引用 | 林山夕风</title>
    <meta name="description" content="林山夕风的博客,md文档,技术博客">
    <meta name="generator" content="VuePress 1.3.0">
    <link rel="icon" href="/my-blog/avatar.jpg">
  <script>
                var _hmt = _hmt || [];
                (function() {
                    var hm = document.createElement("script");
                    hm.src = "https://hm.baidu.com/hm.js?68e7a949df184c1e4c82b115461e51e0";
                    var s = document.getElementsByTagName("script")[0];
                    s.parentNode.insertBefore(hm, s);
                })();
            </script>
    
    <link rel="preload" href="/my-blog/assets/css/0.styles.67b6080f.css" as="style"><link rel="preload" href="/my-blog/assets/js/app.11c55fdf.js" as="script"><link rel="preload" href="/my-blog/assets/js/2.f643b0a2.js" as="script"><link rel="preload" href="/my-blog/assets/js/45.7656da3c.js" as="script"><link rel="preload" href="/my-blog/assets/js/4.fd36f240.js" as="script"><link rel="preload" href="/my-blog/assets/js/5.628d6842.js" as="script"><link rel="prefetch" href="/my-blog/assets/js/10.f4eaa613.js"><link rel="prefetch" href="/my-blog/assets/js/100.07e38629.js"><link rel="prefetch" href="/my-blog/assets/js/101.dcfe2bf2.js"><link rel="prefetch" href="/my-blog/assets/js/102.209999b3.js"><link rel="prefetch" href="/my-blog/assets/js/103.a9a85d34.js"><link rel="prefetch" href="/my-blog/assets/js/104.fdefe1dc.js"><link rel="prefetch" href="/my-blog/assets/js/105.e4b5d0af.js"><link rel="prefetch" href="/my-blog/assets/js/106.cf83f84b.js"><link rel="prefetch" href="/my-blog/assets/js/107.848b42d5.js"><link rel="prefetch" href="/my-blog/assets/js/108.351fb64c.js"><link rel="prefetch" href="/my-blog/assets/js/109.4b9111f6.js"><link rel="prefetch" href="/my-blog/assets/js/11.5d5723d1.js"><link rel="prefetch" href="/my-blog/assets/js/110.7f24fb6a.js"><link rel="prefetch" href="/my-blog/assets/js/111.28300395.js"><link rel="prefetch" href="/my-blog/assets/js/112.839af357.js"><link rel="prefetch" href="/my-blog/assets/js/113.67de001a.js"><link rel="prefetch" href="/my-blog/assets/js/114.408ea2f6.js"><link rel="prefetch" href="/my-blog/assets/js/115.34a1d81a.js"><link rel="prefetch" href="/my-blog/assets/js/116.f510ca2c.js"><link rel="prefetch" href="/my-blog/assets/js/117.24ddf316.js"><link rel="prefetch" href="/my-blog/assets/js/12.06fcb150.js"><link rel="prefetch" href="/my-blog/assets/js/13.c441de9d.js"><link rel="prefetch" href="/my-blog/assets/js/14.ca26e948.js"><link rel="prefetch" href="/my-blog/assets/js/15.e7761bd0.js"><link rel="prefetch" href="/my-blog/assets/js/16.5be4d33f.js"><link rel="prefetch" href="/my-blog/assets/js/17.4426a95c.js"><link rel="prefetch" href="/my-blog/assets/js/18.7d974f8d.js"><link rel="prefetch" href="/my-blog/assets/js/19.775995bc.js"><link rel="prefetch" href="/my-blog/assets/js/20.71c35e12.js"><link rel="prefetch" href="/my-blog/assets/js/21.741a18a7.js"><link rel="prefetch" href="/my-blog/assets/js/22.819a7e85.js"><link rel="prefetch" href="/my-blog/assets/js/23.f9133433.js"><link rel="prefetch" href="/my-blog/assets/js/24.86a7d541.js"><link rel="prefetch" href="/my-blog/assets/js/25.0aa2d6ab.js"><link rel="prefetch" href="/my-blog/assets/js/26.3e55392e.js"><link rel="prefetch" href="/my-blog/assets/js/27.ae2e0581.js"><link rel="prefetch" href="/my-blog/assets/js/28.aaa62b88.js"><link rel="prefetch" href="/my-blog/assets/js/29.55007ae9.js"><link rel="prefetch" href="/my-blog/assets/js/3.57915124.js"><link rel="prefetch" href="/my-blog/assets/js/30.63aac023.js"><link rel="prefetch" href="/my-blog/assets/js/31.d5607214.js"><link rel="prefetch" href="/my-blog/assets/js/32.a7ae912b.js"><link rel="prefetch" href="/my-blog/assets/js/33.58fcbfa4.js"><link rel="prefetch" href="/my-blog/assets/js/34.8538d781.js"><link rel="prefetch" href="/my-blog/assets/js/35.14a82428.js"><link rel="prefetch" href="/my-blog/assets/js/36.2ad806dd.js"><link rel="prefetch" href="/my-blog/assets/js/37.207a29ce.js"><link rel="prefetch" href="/my-blog/assets/js/38.57c0d12e.js"><link rel="prefetch" href="/my-blog/assets/js/39.83aff8a9.js"><link rel="prefetch" href="/my-blog/assets/js/40.bcbcfd03.js"><link rel="prefetch" href="/my-blog/assets/js/41.d0a94dfd.js"><link rel="prefetch" href="/my-blog/assets/js/42.f6011b50.js"><link rel="prefetch" href="/my-blog/assets/js/43.efd29b4c.js"><link rel="prefetch" href="/my-blog/assets/js/44.e5c9709c.js"><link rel="prefetch" href="/my-blog/assets/js/46.0f46c833.js"><link rel="prefetch" href="/my-blog/assets/js/47.40ce4540.js"><link rel="prefetch" href="/my-blog/assets/js/48.3db9c583.js"><link rel="prefetch" href="/my-blog/assets/js/49.53285ac3.js"><link rel="prefetch" href="/my-blog/assets/js/50.4db56f99.js"><link rel="prefetch" href="/my-blog/assets/js/51.188f8c4f.js"><link rel="prefetch" href="/my-blog/assets/js/52.95be221e.js"><link rel="prefetch" href="/my-blog/assets/js/53.276e1791.js"><link rel="prefetch" href="/my-blog/assets/js/54.2fd73796.js"><link rel="prefetch" href="/my-blog/assets/js/55.c90a5bd8.js"><link rel="prefetch" href="/my-blog/assets/js/56.406f89df.js"><link rel="prefetch" href="/my-blog/assets/js/57.811f05ab.js"><link rel="prefetch" href="/my-blog/assets/js/58.e2896a54.js"><link rel="prefetch" href="/my-blog/assets/js/59.e5f3be54.js"><link rel="prefetch" href="/my-blog/assets/js/6.8ba90f8e.js"><link rel="prefetch" href="/my-blog/assets/js/60.e4b67c15.js"><link rel="prefetch" href="/my-blog/assets/js/61.7b772903.js"><link rel="prefetch" href="/my-blog/assets/js/62.bbe4352b.js"><link rel="prefetch" href="/my-blog/assets/js/63.e350ef3b.js"><link rel="prefetch" href="/my-blog/assets/js/64.7b6ca2f6.js"><link rel="prefetch" href="/my-blog/assets/js/65.76baf7fa.js"><link rel="prefetch" href="/my-blog/assets/js/66.ff801cea.js"><link rel="prefetch" href="/my-blog/assets/js/67.ee30cd5b.js"><link rel="prefetch" href="/my-blog/assets/js/68.0f4c1ce2.js"><link rel="prefetch" href="/my-blog/assets/js/69.111ce4de.js"><link rel="prefetch" href="/my-blog/assets/js/7.55078740.js"><link rel="prefetch" href="/my-blog/assets/js/70.46f8b5e8.js"><link rel="prefetch" href="/my-blog/assets/js/71.675e279c.js"><link rel="prefetch" href="/my-blog/assets/js/72.c419d947.js"><link rel="prefetch" href="/my-blog/assets/js/73.6eb4799a.js"><link rel="prefetch" href="/my-blog/assets/js/74.18229d2e.js"><link rel="prefetch" href="/my-blog/assets/js/75.46c8298d.js"><link rel="prefetch" href="/my-blog/assets/js/76.c966d3c5.js"><link rel="prefetch" href="/my-blog/assets/js/77.b31efc9c.js"><link rel="prefetch" href="/my-blog/assets/js/78.f7e57735.js"><link rel="prefetch" href="/my-blog/assets/js/79.e056b5a5.js"><link rel="prefetch" href="/my-blog/assets/js/8.ddecccf2.js"><link rel="prefetch" href="/my-blog/assets/js/80.0fc539d1.js"><link rel="prefetch" href="/my-blog/assets/js/81.2b7f0d10.js"><link rel="prefetch" href="/my-blog/assets/js/82.d3e4b716.js"><link rel="prefetch" href="/my-blog/assets/js/83.3073a1d2.js"><link rel="prefetch" href="/my-blog/assets/js/84.d231aeff.js"><link rel="prefetch" href="/my-blog/assets/js/85.7daed020.js"><link rel="prefetch" href="/my-blog/assets/js/86.0c8d8d8e.js"><link rel="prefetch" href="/my-blog/assets/js/87.c4ba5f03.js"><link rel="prefetch" href="/my-blog/assets/js/88.9a4e0ef6.js"><link rel="prefetch" href="/my-blog/assets/js/89.b7bca56b.js"><link rel="prefetch" href="/my-blog/assets/js/9.7463f385.js"><link rel="prefetch" href="/my-blog/assets/js/90.49ec4345.js"><link rel="prefetch" href="/my-blog/assets/js/91.84cb7a66.js"><link rel="prefetch" href="/my-blog/assets/js/92.cb5ea946.js"><link rel="prefetch" href="/my-blog/assets/js/93.05e2ac79.js"><link rel="prefetch" href="/my-blog/assets/js/94.e60969c0.js"><link rel="prefetch" href="/my-blog/assets/js/95.688af442.js"><link rel="prefetch" href="/my-blog/assets/js/96.aba3a873.js"><link rel="prefetch" href="/my-blog/assets/js/97.ca8196eb.js"><link rel="prefetch" href="/my-blog/assets/js/98.071b3a0f.js"><link rel="prefetch" href="/my-blog/assets/js/99.eca50447.js">
    <link rel="stylesheet" href="/my-blog/assets/css/0.styles.67b6080f.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/my-blog/" class="home-link router-link-active"><!----> <span class="site-name">林山夕风</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/my-blog/" class="nav-link">
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="基础教程" class="dropdown-title"><span class="title">基础教程</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/my-blog/frontend/" class="nav-link">
  前端
</a></li><li class="dropdown-item"><!----> <a href="/my-blog/backend/" class="nav-link">
  后端
</a></li><li class="dropdown-item"><!----> <a href="/my-blog/enjoy3/" class="nav-link router-link-active">
  进阶
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据结构与算法" class="dropdown-title"><span class="title">数据结构与算法</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/my-blog/structure/" class="nav-link">
  数据结构
</a></li><li class="dropdown-item"><!----> <a href="/my-blog/algorithm/" class="nav-link">
  算法
</a></li></ul></div></div><div class="nav-item"><a href="/my-blog/leetcode/" class="nav-link">
  LeetCode题解
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="设计思想" class="dropdown-title"><span class="title">设计思想</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/my-blog/principle/" class="nav-link">
  设计原则
</a></li><li class="dropdown-item"><!----> <a href="/my-blog/pattern/" class="nav-link">
  设计模式
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="读书笔记" class="dropdown-title"><span class="title">读书笔记</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/my-blog/thinking_in_java/" class="nav-link">
  Java编程思想
</a></li><li class="dropdown-item"><!----> <a href="/my-blog/refactoring_improving_the_design_of_existing_code/" class="nav-link">
  重构改善既有代码的设计
</a></li></ul></div></div><div class="nav-item"><a href="/my-blog/project/" class="nav-link">
  项目实战
</a></div><div class="nav-item"><a href="/my-blog/article/" class="nav-link">
  零散文章
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="代码管理" class="dropdown-title"><span class="title">代码管理</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://gitee.com/doomthr" target="_blank" rel="noopener noreferrer" class="nav-link external">
  码云
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://github.com/TanHaoran" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/my-blog/" class="nav-link">
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="基础教程" class="dropdown-title"><span class="title">基础教程</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/my-blog/frontend/" class="nav-link">
  前端
</a></li><li class="dropdown-item"><!----> <a href="/my-blog/backend/" class="nav-link">
  后端
</a></li><li class="dropdown-item"><!----> <a href="/my-blog/enjoy3/" class="nav-link router-link-active">
  进阶
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据结构与算法" class="dropdown-title"><span class="title">数据结构与算法</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/my-blog/structure/" class="nav-link">
  数据结构
</a></li><li class="dropdown-item"><!----> <a href="/my-blog/algorithm/" class="nav-link">
  算法
</a></li></ul></div></div><div class="nav-item"><a href="/my-blog/leetcode/" class="nav-link">
  LeetCode题解
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="设计思想" class="dropdown-title"><span class="title">设计思想</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/my-blog/principle/" class="nav-link">
  设计原则
</a></li><li class="dropdown-item"><!----> <a href="/my-blog/pattern/" class="nav-link">
  设计模式
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="读书笔记" class="dropdown-title"><span class="title">读书笔记</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/my-blog/thinking_in_java/" class="nav-link">
  Java编程思想
</a></li><li class="dropdown-item"><!----> <a href="/my-blog/refactoring_improving_the_design_of_existing_code/" class="nav-link">
  重构改善既有代码的设计
</a></li></ul></div></div><div class="nav-item"><a href="/my-blog/project/" class="nav-link">
  项目实战
</a></div><div class="nav-item"><a href="/my-blog/article/" class="nav-link">
  零散文章
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="代码管理" class="dropdown-title"><span class="title">代码管理</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://gitee.com/doomthr" target="_blank" rel="noopener noreferrer" class="nav-link external">
  码云
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://github.com/TanHaoran" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>进阶</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/my-blog/enjoy3/虚拟机的前世今生和Java内存区域.html" class="sidebar-link">虚拟机的前世今生和Java内存区域</a></li><li><a href="/my-blog/enjoy3/深入理解JVM的内存区域.html" class="sidebar-link">深入理解JVM的内存区域</a></li><li><a href="/my-blog/enjoy3/玩转JVM中的对象及引用.html" class="active sidebar-link">玩转JVM中的对象及引用</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/my-blog/enjoy3/玩转JVM中的对象及引用.html#一、jvm-中对象的创建过程" class="sidebar-link">一、JVM 中对象的创建过程</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/my-blog/enjoy3/玩转JVM中的对象及引用.html#_1、对象的内存分配" class="sidebar-link">1、对象的内存分配</a></li><li class="sidebar-sub-header"><a href="/my-blog/enjoy3/玩转JVM中的对象及引用.html#_2、对象的内存布局" class="sidebar-link">2、对象的内存布局</a></li><li class="sidebar-sub-header"><a href="/my-blog/enjoy3/玩转JVM中的对象及引用.html#_4、对象的访问定位" class="sidebar-link">4、对象的访问定位</a></li><li class="sidebar-sub-header"><a href="/my-blog/enjoy3/玩转JVM中的对象及引用.html#_5、判断对象的存活" class="sidebar-link">5、判断对象的存活</a></li><li class="sidebar-sub-header"><a href="/my-blog/enjoy3/玩转JVM中的对象及引用.html#_5、finalize-方法" class="sidebar-link">5、Finalize() 方法</a></li></ul></li><li class="sidebar-sub-header"><a href="/my-blog/enjoy3/玩转JVM中的对象及引用.html#二、各种引用" class="sidebar-link">二、各种引用</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/my-blog/enjoy3/玩转JVM中的对象及引用.html#_1、强引用" class="sidebar-link">1、强引用</a></li><li class="sidebar-sub-header"><a href="/my-blog/enjoy3/玩转JVM中的对象及引用.html#_2、软引用-softreference" class="sidebar-link">2、软引用 SoftReference</a></li><li class="sidebar-sub-header"><a href="/my-blog/enjoy3/玩转JVM中的对象及引用.html#_3、弱引用-weakreference" class="sidebar-link">3、弱引用 WeakReference</a></li><li class="sidebar-sub-header"><a href="/my-blog/enjoy3/玩转JVM中的对象及引用.html#_4、虚引用-phantomreference" class="sidebar-link">4、虚引用 PhantomReference</a></li></ul></li><li class="sidebar-sub-header"><a href="/my-blog/enjoy3/玩转JVM中的对象及引用.html#三、对象的分配策略" class="sidebar-link">三、对象的分配策略</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/my-blog/enjoy3/玩转JVM中的对象及引用.html#_1、栈上分配" class="sidebar-link">1、栈上分配</a></li><li class="sidebar-sub-header"><a href="/my-blog/enjoy3/玩转JVM中的对象及引用.html#_2、对象优先在eden-区分配" class="sidebar-link">2、对象优先在Eden 区分配</a></li><li class="sidebar-sub-header"><a href="/my-blog/enjoy3/玩转JVM中的对象及引用.html#_3、大对象直接进入老年代" class="sidebar-link">3、大对象直接进入老年代</a></li><li class="sidebar-sub-header"><a href="/my-blog/enjoy3/玩转JVM中的对象及引用.html#_4、长期存活对象进入老年区" class="sidebar-link">4、长期存活对象进入老年区</a></li><li class="sidebar-sub-header"><a href="/my-blog/enjoy3/玩转JVM中的对象及引用.html#_5、对象年龄动态判定" class="sidebar-link">5、对象年龄动态判定</a></li><li class="sidebar-sub-header"><a href="/my-blog/enjoy3/玩转JVM中的对象及引用.html#_6、空间分配担保" class="sidebar-link">6、空间分配担保</a></li><li class="sidebar-sub-header"><a href="/my-blog/enjoy3/玩转JVM中的对象及引用.html#_7、本地线程分配缓冲" class="sidebar-link">7、本地线程分配缓冲</a></li></ul></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="玩转jvm中的对象及引用"><a href="#玩转jvm中的对象及引用" class="header-anchor">#</a> 玩转JVM中的对象及引用</h1> <div><span id="/my-blog/enjoy3/玩转JVM中的对象及引用.html" data-flag-title="玩转JVM中的对象及引用" class="leancloud_visitors read-count"><em class="post-meta-item-text">阅读量 </em> <i class="leancloud-visitors-count">loading</i></span> <div class="clear-both"></div></div> <h2 id="一、jvm-中对象的创建过程"><a href="#一、jvm-中对象的创建过程" class="header-anchor">#</a> 一、JVM 中对象的创建过程</h2> <p><img src="https://yjtravel-public.oss-cn-beijing.aliyuncs.com/my-blog/enjoy3/jvm16.png" alt="对象创建过程"></p> <h3 id="_1、对象的内存分配"><a href="#_1、对象的内存分配" class="header-anchor">#</a> 1、对象的内存分配</h3> <p><code>JVM</code> 遇到一条 <code>new</code> 指令时，首先检查是否被类加载器加载，如果没有，那必须先执行相应的类加载过程。类加载就是把 <code>class</code> 加载到 <code>JVM</code> 的运行时数据区的过程。</p> <h4 id="_1-检查加载"><a href="#_1-检查加载" class="header-anchor">#</a> (1) 检查加载</h4> <p>首先检查这个指令的参数是否能在 <code>常量池</code> 中定位到一个类的 <code>符号引用</code>（是以一组符号来描述所引用的目标），并且检查类是否已经被加载、解析和初始化过。</p> <h4 id="_2-分配内存"><a href="#_2-分配内存" class="header-anchor">#</a> (2) 分配内存</h4> <p>接下来虚拟机将为新生对象分配内存。为对象分配空间的任务等同于把一块确定大小的内存从 <code>Java 堆</code> 中划分出来。</p> <p>内存分配分为两种方式，一种是 <code>指针碰撞</code>，一种是 <code>空闲列表</code>。</p> <ul><li>指针碰撞</li></ul> <p>如果 <code>Java 堆</code> 中内存是绝对规整的，所有用过的内存都放在一边，空闲的内存放在另一边，中间放着一个指针作为分界点的指示器，那所分配内存就仅仅是把那个指针向空闲空间那边挪动一段与对象大小相等的距离，这种分配方式称为 <code>指针碰撞</code>。</p> <p><img src="https://yjtravel-public.oss-cn-beijing.aliyuncs.com/my-blog/enjoy3/jvm17.png" alt="指针碰撞"></p> <ul><li>空闲列表</li></ul> <p>如果 <code>Java 堆</code> 中的内存并不是规整的，已使用的内存和空闲的内存相互交错，那就没有办法简单地进行指针碰撞了，虚拟机就必须维护一个列表，记录上哪些内存块是可用的，在分配的时候从列表中找到一块足够大的空间划分给对象实例，并更新列表上的记录，这种分配方式称为 <code>空闲列表</code>。</p> <p><img src="https://yjtravel-public.oss-cn-beijing.aliyuncs.com/my-blog/enjoy3/jvm18.png" alt="空闲列表"></p> <p>选择哪种分配方式由 <code>Java 堆</code> 是否规整决定，而 <code>Java 堆</code> 是否规整又由所采用的 <code>垃圾收集器</code> 是否带有压缩整理功能决定。</p> <p>如果是 <code>Serial</code>、<code>ParNew</code> 等带有压缩的整理的垃圾回收器的话，系统采用的是 <code>指针碰撞</code>，既简单又高效。</p> <p>如果是使用 <code>CMS</code> 这种不带压缩（整理）的垃圾回收器的话，理论上只能采用较复杂的 <code>空闲列表</code>。</p> <h5 id="并发安全"><a href="#并发安全" class="header-anchor">#</a> 并发安全</h5> <p>除了如何划分可用空间之外，还有另外一个需要考虑的问题是对象创建在虚拟机中是非常频繁的行为，即使是仅仅修改一个指针所指向的位置，在并发情况下也并不是线程安全的，可能出现正在给 对象A 分配内存，指针还没来得及修改，对象B 又同时使用了原来的指针来分配内存的情况。</p> <p>解决这个问题有两种方案：</p> <ul><li>CAS 机制</li></ul> <p>一种是对分配内存空间的动作进行同步处理——实际上虚拟机采用 <code>CAS</code> 配上失败重试的方式保证更新操作的 <code>原子性</code>。</p> <p><img src="https://yjtravel-public.oss-cn-beijing.aliyuncs.com/my-blog/enjoy3/jvm19.png" alt="CAS机制"></p> <ul><li>分配缓冲</li></ul> <p>另一种是把内存分配的动作按照线程划分在不同的空间之中进行，即每个线程在 <code>Java 堆</code> 中预先分配一小块私有内存，也就是 <code>本地线程分配缓冲</code>（<code>Thread Local Allocation Buffer</code>，即 <code>TLAB</code>），<code>JVM</code> 在线程初始化时，同时也会申请一块指定大小的内存，只给当前线程使用，这样每个线程都单独拥有一个 <code>Buffer</code>，如果需要分配内存，就在自己的 <code>Buffer</code> 上分配，这样就不存在竞争的情况，可以大大提升分配效率，当 <code>Buffer</code> 容量不够的时候，再重新从 <code>Eden</code> 区域申请一块继续使用。</p> <p><code>TLAB</code> 的目的是在为新对象分配内存空间时，让每个 Java 应用线程 能在使用自己专属的分配指针来分配空间，减少同步开销。</p> <p><code>TLAB</code> 只是让每个线程有私有的分配指针，但底下存对象的内存空间还是给所有线程访问的，只是其它线程无法在这个区域分配而已。当一个 <code>TLAB</code> 用满（分配指针 <code>top</code> 撞上分配极限 <code>end</code> 了），就新申请一个 <code>TLAB</code>。</p> <p>配置参数 <code>-XX:+UseTLAB</code> 可以允许在年轻代空间中使用线程本地分配块（<code>TLAB</code>）。默认情况下启用此选项。要禁用 <code>TLAB</code>，请指定 <code>-XX:-UseTLAB</code>。</p> <p>参考文档：<a href="https://docs.oracle.com/javase/8/docs/technotes/tools/unix/java.html" target="_blank" rel="noopener noreferrer">https://docs.oracle.com/javase/8/docs/technotes/tools/unix/java.html<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <h4 id="_3-内存空间初始化"><a href="#_3-内存空间初始化" class="header-anchor">#</a> (3) 内存空间初始化</h4> <p>内存分配完成后，虚拟机需要将分配到的内存空间都初始化为零值(如 <code>int</code> 值为 0，<code>boolean</code> 值为 <code>false</code> 等等)。这一步操作保证了对象的实例字段在 Java 代码中可以不赋初始值就直接使用，程序能访问到这些字段的数据类型所对应的零值。</p> <h4 id="_4-设置"><a href="#_4-设置" class="header-anchor">#</a> (4) 设置</h4> <p>接下来，虚拟机要对对象进行必要的设置，例如这个对象是哪个类的实例、如何才能找到类的元数据信息（<code>Java classes</code> 在 <code>Java hotspot VM</code> 内部表示为类元数据）、对象的哈希码、对象的 <code>GC</code> 分代年龄等信息。这些信息存放在对象的对象头之中。</p> <h4 id="_5-对象初始化"><a href="#_5-对象初始化" class="header-anchor">#</a> (5) 对象初始化</h4> <p>在上面工作都完成之后，从虚拟机的视角来看，一个新的对象已经产生了，但从 Java 程序 的视角来看，对象创建才刚刚开始，所有的字段都还为零值。所以，一般来说，执行 <code>new</code> 指令之后会接着把对象按照程序员的意愿进行初始化(构造方法)，这样一个真正可用的对象才算完全产生出来。</p> <h3 id="_2、对象的内存布局"><a href="#_2、对象的内存布局" class="header-anchor">#</a> 2、对象的内存布局</h3> <p><img src="https://yjtravel-public.oss-cn-beijing.aliyuncs.com/my-blog/enjoy3/jvm20.png" alt="对象的内存布局"></p> <p>在 <code>HotSpot</code> 虚拟机中，对象在内存中存储的布局可以分为 3 块区域：<code>对象头</code>（<code>Header</code>）、<code>实例数据</code>（<code>Instance Data</code>）和 <code>对齐填充</code>（<code>Padding</code>）。</p> <p><code>对象头</code> 包括两部分信息，第一部分用于存储对象自身的运行时数据，如 <code>哈希码</code>（<code>HashCode</code>）、<code>GC 分代年龄</code>、<code>锁状态标志</code>、<code>线程持有的锁</code>、<code>偏向线程ID</code>、<code>偏向时间戳</code>等。</p> <p><code>对象头</code> 的另外一部分是 <code>类型指针</code>，即对象指向它的类元数据的指针，虚拟机通过这个指针来确定这个对象是哪个类的实例。</p> <p>如果对象是一个 <code>Java 数组</code>，那么在对象头中还有一块用于记录数组长度的数据。</p> <p>第三部分对齐填充并不是必然存在的，也没有特别的含义，它仅仅起着占位符的作用。由于 <code>HotSpot VM</code> 的自动内存管理系统要求对对象的大小必须是 8 字节的整数倍。当对象其他数据部分没有对齐时，就需要通过对齐填充来补全。</p> <h3 id="_4、对象的访问定位"><a href="#_4、对象的访问定位" class="header-anchor">#</a> 4、对象的访问定位</h3> <p>建立对象是为了使用对象，Java 程序需要通过 <code>栈</code> 上的 <code>reference</code> 数据来操作 <code>堆</code> 上的具体对象。目前主流的访问方式有使用 <code>句柄</code> 和 <code>直接指针</code> 两种。</p> <h4 id="_1-句柄"><a href="#_1-句柄" class="header-anchor">#</a> (1) 句柄</h4> <p>如果使用 <code>句柄</code> 访问的话，那么 <code>Java 堆</code> 中将会划分出一块内存来作为 <code>句柄池</code>，<code>reference</code> 中存储的就是对象的 <code>句柄地址</code>，而 <code>句柄</code> 中包含了对象实例数据与类型数据各自的具体地址信息。</p> <p>使用 <code>句柄</code> 来访问的最大好处就是 <code>reference</code> 中存储的是稳定的 <code>句柄地址</code>，在对象被移动（垃圾收集时移动对象是非常普遍的行为）时只会改变 <code>句柄</code> 中的 <code>实例数据指针</code>，而 <code>reference</code> 本身不需要修改.</p> <h4 id="_2-直接指针"><a href="#_2-直接指针" class="header-anchor">#</a> (2) 直接指针</h4> <p>如果使用直接指针访问，<code>reference</code> 中存储的直接就是 <code>对象地址</code>。</p> <p>这两种对象访问方式各有优势，使用 <code>直接指针</code> 访问方式的最大好处就是速度更快，它节省了一次指针定位的时间开销，由于对象的访问在 <code>Java</code> 中非常频繁，因此这类开销积少成多后也是一项非常可观的执行成本。</p> <p>对 <code>Sun HotSpot</code> 而言，它是使用 <code>直接指针</code> 访问方式进行对象访问的。</p> <h3 id="_5、判断对象的存活"><a href="#_5、判断对象的存活" class="header-anchor">#</a> 5、判断对象的存活</h3> <p>在 <code>堆</code> 里面存放着几乎所有的对象实例，垃圾回收器在对对进行回收前，要做的事情就是确定这些对象中哪些还是“存活”着，哪些已经“死去”（死去代表着不可能再被任何途径使用得对象了）</p> <p><code>C</code> 申请内存：<code>malloc free</code>，<code>C++</code> 申请内存：<code>new delete</code>。<code>C/C++</code> 都是手动回收内存。</p> <p><code>Java</code> 使用 <code>new</code> 创建对象，<code>Java</code> 是自动内存回收，编程上简单，系统不容易出错。</p> <p>手动释放内存，容易出两种类型的问题：1、忘记回收；2、多次回收</p> <p>判断对象是否是垃圾：没有任何引用指向的一个对象或者多个对象（不包括循环引用）。</p> <h4 id="_1-引用计数法"><a href="#_1-引用计数法" class="header-anchor">#</a> (1) 引用计数法</h4> <p>在对象中添加一个 <code>引用计数器</code>，每当有一个地方引用它，计数器就加 1，当引用失效时，计数器减 1。</p> <p><code>Python</code> 在用，但主流虚拟机没有使用，因为存在对象相互引用的情况，这个时候需要引入额外的机制来处理，这样做影响效率。</p> <p>在 <code>Java</code> 中，只保留相互引用的对象还是会被回收掉，说明 <code>JVM</code> 中采用的不是 <code>引用计数法</code>。</p> <h4 id="_2-可达性分析"><a href="#_2-可达性分析" class="header-anchor">#</a> (2) 可达性分析</h4> <p>来判定对象是否存活的。这个算法的基本思路就是通过一系列的称为 <code>GC Roots</code> 的对象作为起始点，从这些节点开始向下搜索，搜索所走过的路径称为 <code>引用链</code>（<code>Reference Chain</code>），当一个对象到 <code>GC Roots</code> 没有任何 <code>引用链</code> 相连时，则证明此对象是不可用的。</p> <p>作为 <code>GC Roots</code> 的对象包括下面几种，其中重点是前面 4 种：</p> <ol><li><code>虚拟机栈</code>（<code>栈帧</code> 中的 <code>本地变量表</code>）中引用的对象；各个线程被调用方法堆栈中使用到的参数、局部变量、临时变量等。</li> <li><code>方法区</code> 中类静态属性引用的对象；<code>Java 类</code> 的引用类型静态变量。</li> <li><code>方法区</code> 中常量引用的对象；比如：字符串常量池里的引用。</li> <li><code>本地方法栈</code> 中 <code>JNI</code>（即一般说的 <code>Native</code> 方法）引用的对象。</li> <li><code>JVM</code> 的内部引用（<code>class</code> 对象、异常对象 <code>NullPointException</code>、<code>OutofMemoryError</code>，系统类加载器）。</li> <li>所有被同步锁（<code>synchronized</code> 关键）持有的对象。</li> <li><code>JVM</code> 内部的 <code>JMXBean</code>、<code>JVMTI</code> 中注册的回调、本地代码缓存等。</li> <li><code>JVM</code> 实现中的“临时性”对象，跨代引用的对象（在使用分代模型回收只回收部分代的对象）</li></ol> <p>以上的回收都是对象和类的回收条件。注意 <code>Class</code> 要被回收，条件比较苛刻，必须同时满足以下的条件（仅仅是可以，不代表必然，因为还有一些参数可以进行控制）：</p> <ol><li>该类所有的实例都已经被回收，也就是 <code>堆</code> 中不存在该类的任何实例。</li> <li>加载该类的 <code>ClassLoader</code> 已经被回收。</li> <li>该类对应的 <code>java.lang.Class</code> 对象没有在任何地方被引用，无法在任何地方通过反射访问该类的方法。</li> <li>参数控制：<code>-Xnoclassgc</code>，废弃的常量和静态变量的回收其实就和 <code>Class</code> 回收的条件差不多。</li></ol> <h3 id="_5、finalize-方法"><a href="#_5、finalize-方法" class="header-anchor">#</a> 5、Finalize() 方法</h3> <p>即使通过可达性分析判断不可达的对象，也不是“非死不可”，它还会处于“缓刑”阶段，真正要宣告一个对象死亡，需要经过两次标记过程，一次是没有找到与 <code>GCRoots</code> 的引用链，它将被第一次标记。随后进行一次筛选（如果对象覆盖了 <code>finalize()</code>），我们可以在 <code>finalize()</code> 中去拯救。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FinalizeGC</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">FinalizeGC</span> instance <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">isAlive</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;I am still alive!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">finalize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">finalize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;finalize method executed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">FinalizeGC</span><span class="token punctuation">.</span>instance <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
        instance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FinalizeGC</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 对象进行第1次GC</span>
        instance <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">gc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//Finalizer方法优先级很低，需要等待</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>instance <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            instance<span class="token punctuation">.</span><span class="token function">isAlive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;I am dead！&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//对象进行第2次GC</span>
        instance <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">gc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>instance <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            instance<span class="token punctuation">.</span><span class="token function">isAlive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;I am dead！&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br></div></div><p>执行结果：</p> <div class="language-console line-numbers-mode"><pre class="language-text"><code>finalize method executed
I am still alive!
I am dead！
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>可以看到，对象可以被拯救一次( <code>finalize()</code> 方法会执行一次，但是不会执行第二次)。</p> <p>修改一下代码，再看看。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FinalizeGC</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">FinalizeGC</span> instance <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">isAlive</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;I am still alive!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">finalize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">finalize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;finalize method executed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">FinalizeGC</span><span class="token punctuation">.</span>instance <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
        instance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FinalizeGC</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 对象进行第1次GC</span>
        instance <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">gc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        Thread.sleep(1000);//Finalizer方法优先级很低，需要等待</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>instance <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            instance<span class="token punctuation">.</span><span class="token function">isAlive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;I am dead！&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//对象进行第2次GC</span>
        instance <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">gc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        Thread.sleep(1000);</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>instance <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            instance<span class="token punctuation">.</span><span class="token function">isAlive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;I am dead！&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br></div></div><p>将中间两次休眠注释掉。</p> <p>执行结果：</p> <div class="language-console line-numbers-mode"><pre class="language-text"><code>I am dead！
finalize method executed
I am dead！
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>这一次，对象没有被拯救，这个就是 <code>finalize()</code> 方法执行缓慢，还没有完成拯救，垃圾回收器就已经回收掉了。</p> <p>所以尽量不要使用 <code>finalize()</code>，因为这个方法太不可靠。在生产中你很难控制方法的执行或者对象的调用顺序。因为在 <code>finalize()</code> 方法能做的工作，<code>Java</code> 中有更好的，比如 <code>try-finally</code>。</p> <h2 id="二、各种引用"><a href="#二、各种引用" class="header-anchor">#</a> 二、各种引用</h2> <h3 id="_1、强引用"><a href="#_1、强引用" class="header-anchor">#</a> 1、强引用</h3> <p>一般的 <code>Object obj = new Object()</code>，就属于 <code>强引用</code>。在任何情况下，只有有强引用关联（与根可达）还在，垃圾回收器就永远不会回收掉被引用的对象。</p> <h3 id="_2、软引用-softreference"><a href="#_2、软引用-softreference" class="header-anchor">#</a> 2、软引用 SoftReference</h3> <p>一些有用但是并非必需，用 <code>软引用</code> 关联的对象，系统将要发生内存溢出（<code>OOM</code>）之前，这些对象就会被回收（如果这次回收后还是没有足够的空间，才会抛出内存溢出）。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestSoftRef</span> <span class="token punctuation">{</span>
    <span class="token comment">//对象</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token punctuation">{</span>
        <span class="token keyword">public</span> <span class="token keyword">int</span> id <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token class-name">String</span> name <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token keyword">int</span> id<span class="token punctuation">,</span> <span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>id <span class="token operator">=</span> id<span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token string">&quot;User [id=&quot;</span> <span class="token operator">+</span> id <span class="token operator">+</span> <span class="token string">&quot;, name=&quot;</span> <span class="token operator">+</span> name <span class="token operator">+</span> <span class="token string">&quot;]&quot;</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">User</span> u <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">&quot;King&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//new是强引用</span>
        <span class="token class-name">SoftReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span></span> userSoft <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SoftReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>u<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//软引用</span>
        u <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span><span class="token comment">//干掉强引用，确保这个实例只有userSoft的软引用</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>userSoft<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//看一下这个对象是否还在</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">gc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//进行一次GC垃圾回收  千万不要写在业务代码中。</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;After gc&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>userSoft<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//往堆中填充数据，导致OOM</span>
        <span class="token class-name">List</span><span class="token operator">&lt;</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">//System.out.println(&quot;*************&quot;+userSoft.get());</span>
                list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//1M的对象 100m</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//抛出了OOM异常时打印软引用对象</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Exception*************&quot;</span> <span class="token operator">+</span> userSoft<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br></div></div><p>运行时指定参数：<code>-Xms10m -Xmx10m -XX:+PrintGC</code></p> <p>执行结果：</p> <div class="language-console line-numbers-mode"><pre class="language-text"><code>User [id=1, name=King]
[GC (System.gc())  2028K-&gt;756K(9728K), 0.0031256 secs]
[Full GC (System.gc())  756K-&gt;670K(9728K), 0.0038726 secs]
After gc
User [id=1, name=King]
[GC (Allocation Failure) -- 7919K-&gt;7919K(9728K), 0.0005728 secs]
[Full GC (Ergonomics)  7919K-&gt;7766K(9728K), 0.0054970 secs]
[GC (Allocation Failure) -- 7766K-&gt;7766K(9728K), 0.0002498 secs]
[Full GC (Allocation Failure)  7766K-&gt;7750K(9728K), 0.0060318 secs]
Exception*************null
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>可以看出，最开始进行手动 <code>gc</code> 的时候，<code>User</code> 是存在的，当发生了 <code>OOM</code> 之后，<code>User</code> 被回收了。</p> <p>例如，一个程序用来处理用户提供的图片。如果将所有图片读入内存，这样虽然可以很快的打开图片，但内存空间使用巨大，一些使用较少的图片浪费内存空间，需要手动从内存中移除。如果每次打开图片都从磁盘文件中读取到内存再显示出来，虽然内存占用较少，但一些经常使用的图片每次打开都要访问磁盘，代价巨大。这个时候就可以用 <code>软引用</code> 构建缓存。</p> <h3 id="_3、弱引用-weakreference"><a href="#_3、弱引用-weakreference" class="header-anchor">#</a> 3、弱引用 WeakReference</h3> <p>一些有用（程度比 <code>软引用</code> 更低）但是并非必需，用 <code>弱引用</code> 关联的对象，只能生存到下一次垃圾回收之前，<code>GC</code> 发生时，不管内存够不够，都会被回收。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestWeakRef</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token punctuation">{</span>
        <span class="token keyword">public</span> <span class="token keyword">int</span> id <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token class-name">String</span> name <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token keyword">int</span> id<span class="token punctuation">,</span> <span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>id <span class="token operator">=</span> id<span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token string">&quot;User [id=&quot;</span> <span class="token operator">+</span> id <span class="token operator">+</span> <span class="token string">&quot;, name=&quot;</span> <span class="token operator">+</span> name <span class="token operator">+</span> <span class="token string">&quot;]&quot;</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">User</span> u <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">&quot;King&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">WeakReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span></span> userWeak <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeakReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>u<span class="token punctuation">)</span><span class="token punctuation">;</span>
        u <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span><span class="token comment">//干掉强引用，确保这个实例只有userWeak的弱引用</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>userWeak<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">gc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//进行一次GC垃圾回收,千万不要写在业务代码中。</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;After gc&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>userWeak<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><p>执行结果：</p> <div class="language-console line-numbers-mode"><pre class="language-text"><code>User [id=1, name=King]
After gc
null
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>注意：<code>软引用</code> <code>SoftReference</code> 和 <code>弱引用</code> <code>WeakReference</code>，可以用在内存资源紧张的情况下以及创建不是很重要的数据缓存。当系统内存不足的时候，缓存中的内容是可以被释放的。
实际运用例如：<code>WeakHashMap</code> 和 <code>ThreadLocal</code></p> <h3 id="_4、虚引用-phantomreference"><a href="#_4、虚引用-phantomreference" class="header-anchor">#</a> 4、虚引用 PhantomReference</h3> <p>最弱（随时会被回收掉），垃圾回收的时候会收到一个通知，就是为了监控垃圾回收器是否正常工作。</p> <h2 id="三、对象的分配策略"><a href="#三、对象的分配策略" class="header-anchor">#</a> 三、对象的分配策略</h2> <h3 id="_1、栈上分配"><a href="#_1、栈上分配" class="header-anchor">#</a> 1、栈上分配</h3> <h4 id="_1-没有逃逸"><a href="#_1-没有逃逸" class="header-anchor">#</a> (1) 没有逃逸</h4> <p>即方法中的对象没有发生逃逸。
逃逸分析的原理：分析对象动态作用域，当一个对象在方法中定义后，它可能被外部方法所引用。
比如：调用参数传递到其他方法中，这种称之为方法逃逸。甚至还有可能被外部线程访问到，例如：赋值给其他线程中访问的变量，这个称之为线程逃逸。
从不逃逸到方法逃逸到线程逃逸，称之为对象由低到高的不同逃逸程度。
如果确定一个对象不会逃逸出线程之外，那么让对象在栈上分配内存可以提高JVM 的效率。</p> <p>例如：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">EscapeAnalysisTest</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token keyword">long</span> start <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">50000000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//5000万次---5000万个对象</span>
            <span class="token function">allocate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; ms&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">600000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">allocate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//逃逸分析（不会逃逸出方法）</span>
        <span class="token comment">//这个myObject引用没有出去，也没有其他方法使用</span>
        <span class="token class-name">MyObject</span> myObject <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyObject</span><span class="token punctuation">(</span><span class="token number">2020</span><span class="token punctuation">,</span> <span class="token number">2020.6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">MyObject</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> a<span class="token punctuation">;</span>
        <span class="token keyword">double</span> b<span class="token punctuation">;</span>

        <span class="token class-name">MyObject</span><span class="token punctuation">(</span><span class="token keyword">int</span> a<span class="token punctuation">,</span> <span class="token keyword">double</span> b<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>a <span class="token operator">=</span> a<span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>b <span class="token operator">=</span> b<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><p>这段代码在调用的过程中 <code>Myboject</code> 这个对象属于不可逃逸，<code>JVM</code> 可以做栈上分配。</p> <p>开启逃逸分析，启动参数中配置：<code>-XX:+DoEscapeAnalysis</code> ，运行结果：</p> <div class="language-console line-numbers-mode"><pre class="language-text"><code>5 ms
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>关闭逃逸分析，启动参数中配置：<code>-XX:-DoEscapeAnalysis</code> ，运行结果：</p> <div class="language-console line-numbers-mode"><pre class="language-text"><code>237 ms
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>测试结果可见，开启逃逸分析对代码的执行性能有很大的影响！那为什么有这个影响？</p> <h4 id="_2-逃逸分析"><a href="#_2-逃逸分析" class="header-anchor">#</a> (2) 逃逸分析</h4> <p>如果是 <code>逃逸分析</code> 出来的对象可以在 <code>栈</code> 上分配的话，那么该对象的生命周期就跟随线程了，就不需要垃圾回收，如果是频繁的调用此方法则可以得到很大的性能提高。</p> <p>采用了 <code>逃逸分析</code> 后，满足逃逸的对象在栈上分配。</p> <p>没有开启 <code>逃逸分析</code>，对象都在 <code>堆</code> 上分配，会频繁触发垃圾回收（垃圾回收会影响系统性能），导致代码运行慢。</p> <p>还是上面的程序，开启 <code>GC</code> 打印日志：<code>-XX:+PrintGC</code>，开启逃逸分析的执行：</p> <div class="language-console line-numbers-mode"><pre class="language-text"><code>5 ms
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>关闭逃逸分析的执行：</p> <div class="language-console line-numbers-mode"><pre class="language-text"><code>[GC (Allocation Failure)  65536K-&gt;832K(251392K), 0.0015792 secs]
[GC (Allocation Failure)  66368K-&gt;864K(251392K), 0.0009692 secs]
[GC (Allocation Failure)  66400K-&gt;784K(251392K), 0.0006511 secs]
[GC (Allocation Failure)  66320K-&gt;784K(316928K), 0.0008088 secs]
[GC (Allocation Failure)  131856K-&gt;768K(316928K), 0.0012634 secs]
[GC (Allocation Failure)  131840K-&gt;816K(438272K), 0.0006588 secs]
[GC (Allocation Failure)  262960K-&gt;664K(438272K), 0.0016895 secs]
[GC (Allocation Failure)  262808K-&gt;664K(700928K), 0.0004302 secs]
287 ms
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>可以看到关闭了 <code>逃逸分析</code>，<code>JVM</code> 在频繁的进行垃圾回收（<code>GC</code>），正是这一块的操作导致性能有较大的差别。</p> <h3 id="_2、对象优先在eden-区分配"><a href="#_2、对象优先在eden-区分配" class="header-anchor">#</a> 2、对象优先在Eden 区分配</h3> <p>大多数情况下，对象在新生代 <code>Eden</code> 区中分配。当 <code>Eden</code> 区没有足够空间分配时，虚拟机将发起一次 <code>Minor GC</code>。</p> <h3 id="_3、大对象直接进入老年代"><a href="#_3、大对象直接进入老年代" class="header-anchor">#</a> 3、大对象直接进入老年代</h3> <p>大对象就是指需要大量连续内存空间的 <code>Java 对象</code>，最典型的大对象便是那种很长的字符串，或者元素数量很庞大的数组。</p> <p>大对象对虚拟机的内存分配来说就是一个不折不扣的坏消息，比遇到一个大对象更加坏的消息就是遇到一群“朝生夕灭”的“短命大对象”，我们写程序的时候应注意避免。</p> <p>在 <code>JVM</code> 中要避免大对象的原因是，在分配空间时，它容易导致内存明明还有不少空间时就提前触发垃圾收集，以获取足够的连续空间才能安置好它们。</p> <p>而当复制对象时，大对象就意味着高额的内存复制开销。</p> <p><code>HotSpot</code> 虚拟机提供了 <code>-XX:PretenureSizeThreshold</code> 参数，指定大于该设置值的对象直接在老年代分配，这样做的目的就是避免在 <code>Eden</code> 区及两个 <code>Survivor</code> 区之间来回复制，产生大量的内存复制操作。这样做的目的：1.避免大量内存复制，2.避免明明内存有空间进行分配而提前进行的垃圾回收。</p> <p><code>PretenureSizeThreshold</code> 参数只对 <code>Serial</code> 和 <code>ParNew</code> 两款收集器有效。设置例如：<code>-XX:PretenureSizeThreshold=4m</code></p> <h3 id="_4、长期存活对象进入老年区"><a href="#_4、长期存活对象进入老年区" class="header-anchor">#</a> 4、长期存活对象进入老年区</h3> <p><code>HotSpot</code> 虚拟机中多数收集器都采用了分代收集来管理堆内存，那内存回收时就必须能决策哪些存活对象应当放在新生代，哪些存活对象放在老年代中。为做到这点，虚拟机给每个对象定义了一个对象年龄(<code>Age</code>)计数器，存储在对象头中。</p> <p><img src="https://yjtravel-public.oss-cn-beijing.aliyuncs.com/my-blog/enjoy3/jvm20.png" alt="长期存活对象进入老年区"></p> <p>如果对象在 <code>Eden</code> 出生并经过第一次 <code>Minor GC</code> 后仍然存活，并且能被 <code>Survivor</code> 容纳的话，将被移动到 <code>Survivor</code> 空间中，并将对象年龄设为 1，对象在 <code>Survivor</code> 区中每熬过一次 <code>Minor GC</code>，年龄就增加 1，当它的年龄增加到一定程度（并发的垃圾回收器默认为 15），<code>CMS</code> 是 6 时，就会被晋升到 <code>老年代</code> 中。
-XX:MaxTenuringThreshold 调整</p> <h3 id="_5、对象年龄动态判定"><a href="#_5、对象年龄动态判定" class="header-anchor">#</a> 5、对象年龄动态判定</h3> <p>为了能更好地适应不同程序的内存状况，虚拟机并不是永远地要求对象的年龄必须达到了 <code>MaxTenuringThreshold</code> 才能晋升老年代，如果在 <code>Survivor</code> 空间中相同年龄所有对象大小的总和大于 <code>Survivor</code> 空间的一半，年龄大于或等于该年龄的对象就可以直接进入 <code>老年代</code>，无须等到 <code>MaxTenuringThreshold</code> 中要求的年龄。</p> <h3 id="_6、空间分配担保"><a href="#_6、空间分配担保" class="header-anchor">#</a> 6、空间分配担保</h3> <p>在发生 <code>Minor GC</code> 之前，虚拟机会先检查 <code>老年代</code> 最大可用的连续空间是否大于 <code>新生代</code> 所有对象总空间，如果这个条件成立，那么 <code>Minor GC</code> 可以确保是安全的。如果不成立，则虚拟机会查看 <code>HandlePromotionFailure</code> 设置值是否允许担保失败。如果允许，那么会继续检查 <code>老年代</code> 最大可用的连续空间是否大于历次晋升到 <code>老年代</code> 对象的平均大小，如果大于，将尝试着进行一次 <code>Minor GC</code>，尽管这次 <code>Minor GC</code> 是有风险的，如果担保失败则会进行一次 <code>Full GC</code>；如果小于，或者 <code>HandlePromotionFailure</code> 设置不允许冒险，那这时也要改为进行一次 <code>Full GC</code>。</p> <h3 id="_7、本地线程分配缓冲"><a href="#_7、本地线程分配缓冲" class="header-anchor">#</a> 7、本地线程分配缓冲</h3> <p>见文章开头讲到的“分配缓冲”。</p> <div><br> <div id="vcomments"></div></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2020-08-21 17:21:16（1 小时前）</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/my-blog/enjoy3/深入理解JVM的内存区域.html" class="prev">
        深入理解JVM的内存区域
      </a></span> <!----></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/my-blog/assets/js/app.11c55fdf.js" defer></script><script src="/my-blog/assets/js/2.f643b0a2.js" defer></script><script src="/my-blog/assets/js/45.7656da3c.js" defer></script><script src="/my-blog/assets/js/4.fd36f240.js" defer></script><script src="/my-blog/assets/js/5.628d6842.js" defer></script>
  </body>
</html>
