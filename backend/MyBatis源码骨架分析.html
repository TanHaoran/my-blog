<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>MyBatis源码骨架分析 | 林山夕风</title>
    <meta name="description" content="林山夕风的博客,md文档,技术博客">
    <meta name="generator" content="VuePress 1.3.0">
    <link rel="icon" href="/my-blog/avatar.jpg">
  <script>
                var _hmt = _hmt || [];
                (function() {
                    var hm = document.createElement("script");
                    hm.src = "https://hm.baidu.com/hm.js?68e7a949df184c1e4c82b115461e51e0";
                    var s = document.getElementsByTagName("script")[0];
                    s.parentNode.insertBefore(hm, s);
                })();
            </script>
    
    <link rel="preload" href="/my-blog/assets/css/0.styles.67b6080f.css" as="style"><link rel="preload" href="/my-blog/assets/js/app.11c55fdf.js" as="script"><link rel="preload" href="/my-blog/assets/js/2.f643b0a2.js" as="script"><link rel="preload" href="/my-blog/assets/js/21.741a18a7.js" as="script"><link rel="preload" href="/my-blog/assets/js/4.fd36f240.js" as="script"><link rel="preload" href="/my-blog/assets/js/5.628d6842.js" as="script"><link rel="prefetch" href="/my-blog/assets/js/10.f4eaa613.js"><link rel="prefetch" href="/my-blog/assets/js/100.07e38629.js"><link rel="prefetch" href="/my-blog/assets/js/101.dcfe2bf2.js"><link rel="prefetch" href="/my-blog/assets/js/102.209999b3.js"><link rel="prefetch" href="/my-blog/assets/js/103.a9a85d34.js"><link rel="prefetch" href="/my-blog/assets/js/104.fdefe1dc.js"><link rel="prefetch" href="/my-blog/assets/js/105.e4b5d0af.js"><link rel="prefetch" href="/my-blog/assets/js/106.cf83f84b.js"><link rel="prefetch" href="/my-blog/assets/js/107.848b42d5.js"><link rel="prefetch" href="/my-blog/assets/js/108.351fb64c.js"><link rel="prefetch" href="/my-blog/assets/js/109.4b9111f6.js"><link rel="prefetch" href="/my-blog/assets/js/11.5d5723d1.js"><link rel="prefetch" href="/my-blog/assets/js/110.7f24fb6a.js"><link rel="prefetch" href="/my-blog/assets/js/111.28300395.js"><link rel="prefetch" href="/my-blog/assets/js/112.839af357.js"><link rel="prefetch" href="/my-blog/assets/js/113.67de001a.js"><link rel="prefetch" href="/my-blog/assets/js/114.408ea2f6.js"><link rel="prefetch" href="/my-blog/assets/js/115.34a1d81a.js"><link rel="prefetch" href="/my-blog/assets/js/116.f510ca2c.js"><link rel="prefetch" href="/my-blog/assets/js/117.24ddf316.js"><link rel="prefetch" href="/my-blog/assets/js/12.06fcb150.js"><link rel="prefetch" href="/my-blog/assets/js/13.c441de9d.js"><link rel="prefetch" href="/my-blog/assets/js/14.ca26e948.js"><link rel="prefetch" href="/my-blog/assets/js/15.e7761bd0.js"><link rel="prefetch" href="/my-blog/assets/js/16.5be4d33f.js"><link rel="prefetch" href="/my-blog/assets/js/17.4426a95c.js"><link rel="prefetch" href="/my-blog/assets/js/18.7d974f8d.js"><link rel="prefetch" href="/my-blog/assets/js/19.775995bc.js"><link rel="prefetch" href="/my-blog/assets/js/20.71c35e12.js"><link rel="prefetch" href="/my-blog/assets/js/22.819a7e85.js"><link rel="prefetch" href="/my-blog/assets/js/23.f9133433.js"><link rel="prefetch" href="/my-blog/assets/js/24.86a7d541.js"><link rel="prefetch" href="/my-blog/assets/js/25.0aa2d6ab.js"><link rel="prefetch" href="/my-blog/assets/js/26.3e55392e.js"><link rel="prefetch" href="/my-blog/assets/js/27.ae2e0581.js"><link rel="prefetch" href="/my-blog/assets/js/28.aaa62b88.js"><link rel="prefetch" href="/my-blog/assets/js/29.55007ae9.js"><link rel="prefetch" href="/my-blog/assets/js/3.57915124.js"><link rel="prefetch" href="/my-blog/assets/js/30.63aac023.js"><link rel="prefetch" href="/my-blog/assets/js/31.d5607214.js"><link rel="prefetch" href="/my-blog/assets/js/32.a7ae912b.js"><link rel="prefetch" href="/my-blog/assets/js/33.58fcbfa4.js"><link rel="prefetch" href="/my-blog/assets/js/34.8538d781.js"><link rel="prefetch" href="/my-blog/assets/js/35.14a82428.js"><link rel="prefetch" href="/my-blog/assets/js/36.2ad806dd.js"><link rel="prefetch" href="/my-blog/assets/js/37.207a29ce.js"><link rel="prefetch" href="/my-blog/assets/js/38.57c0d12e.js"><link rel="prefetch" href="/my-blog/assets/js/39.83aff8a9.js"><link rel="prefetch" href="/my-blog/assets/js/40.bcbcfd03.js"><link rel="prefetch" href="/my-blog/assets/js/41.d0a94dfd.js"><link rel="prefetch" href="/my-blog/assets/js/42.f6011b50.js"><link rel="prefetch" href="/my-blog/assets/js/43.efd29b4c.js"><link rel="prefetch" href="/my-blog/assets/js/44.e5c9709c.js"><link rel="prefetch" href="/my-blog/assets/js/45.7656da3c.js"><link rel="prefetch" href="/my-blog/assets/js/46.0f46c833.js"><link rel="prefetch" href="/my-blog/assets/js/47.40ce4540.js"><link rel="prefetch" href="/my-blog/assets/js/48.3db9c583.js"><link rel="prefetch" href="/my-blog/assets/js/49.53285ac3.js"><link rel="prefetch" href="/my-blog/assets/js/50.4db56f99.js"><link rel="prefetch" href="/my-blog/assets/js/51.188f8c4f.js"><link rel="prefetch" href="/my-blog/assets/js/52.95be221e.js"><link rel="prefetch" href="/my-blog/assets/js/53.276e1791.js"><link rel="prefetch" href="/my-blog/assets/js/54.2fd73796.js"><link rel="prefetch" href="/my-blog/assets/js/55.c90a5bd8.js"><link rel="prefetch" href="/my-blog/assets/js/56.406f89df.js"><link rel="prefetch" href="/my-blog/assets/js/57.811f05ab.js"><link rel="prefetch" href="/my-blog/assets/js/58.e2896a54.js"><link rel="prefetch" href="/my-blog/assets/js/59.e5f3be54.js"><link rel="prefetch" href="/my-blog/assets/js/6.8ba90f8e.js"><link rel="prefetch" href="/my-blog/assets/js/60.e4b67c15.js"><link rel="prefetch" href="/my-blog/assets/js/61.7b772903.js"><link rel="prefetch" href="/my-blog/assets/js/62.bbe4352b.js"><link rel="prefetch" href="/my-blog/assets/js/63.e350ef3b.js"><link rel="prefetch" href="/my-blog/assets/js/64.7b6ca2f6.js"><link rel="prefetch" href="/my-blog/assets/js/65.76baf7fa.js"><link rel="prefetch" href="/my-blog/assets/js/66.ff801cea.js"><link rel="prefetch" href="/my-blog/assets/js/67.ee30cd5b.js"><link rel="prefetch" href="/my-blog/assets/js/68.0f4c1ce2.js"><link rel="prefetch" href="/my-blog/assets/js/69.111ce4de.js"><link rel="prefetch" href="/my-blog/assets/js/7.55078740.js"><link rel="prefetch" href="/my-blog/assets/js/70.46f8b5e8.js"><link rel="prefetch" href="/my-blog/assets/js/71.675e279c.js"><link rel="prefetch" href="/my-blog/assets/js/72.c419d947.js"><link rel="prefetch" href="/my-blog/assets/js/73.6eb4799a.js"><link rel="prefetch" href="/my-blog/assets/js/74.18229d2e.js"><link rel="prefetch" href="/my-blog/assets/js/75.46c8298d.js"><link rel="prefetch" href="/my-blog/assets/js/76.c966d3c5.js"><link rel="prefetch" href="/my-blog/assets/js/77.b31efc9c.js"><link rel="prefetch" href="/my-blog/assets/js/78.f7e57735.js"><link rel="prefetch" href="/my-blog/assets/js/79.e056b5a5.js"><link rel="prefetch" href="/my-blog/assets/js/8.ddecccf2.js"><link rel="prefetch" href="/my-blog/assets/js/80.0fc539d1.js"><link rel="prefetch" href="/my-blog/assets/js/81.2b7f0d10.js"><link rel="prefetch" href="/my-blog/assets/js/82.d3e4b716.js"><link rel="prefetch" href="/my-blog/assets/js/83.3073a1d2.js"><link rel="prefetch" href="/my-blog/assets/js/84.d231aeff.js"><link rel="prefetch" href="/my-blog/assets/js/85.7daed020.js"><link rel="prefetch" href="/my-blog/assets/js/86.0c8d8d8e.js"><link rel="prefetch" href="/my-blog/assets/js/87.c4ba5f03.js"><link rel="prefetch" href="/my-blog/assets/js/88.9a4e0ef6.js"><link rel="prefetch" href="/my-blog/assets/js/89.b7bca56b.js"><link rel="prefetch" href="/my-blog/assets/js/9.7463f385.js"><link rel="prefetch" href="/my-blog/assets/js/90.49ec4345.js"><link rel="prefetch" href="/my-blog/assets/js/91.84cb7a66.js"><link rel="prefetch" href="/my-blog/assets/js/92.cb5ea946.js"><link rel="prefetch" href="/my-blog/assets/js/93.05e2ac79.js"><link rel="prefetch" href="/my-blog/assets/js/94.e60969c0.js"><link rel="prefetch" href="/my-blog/assets/js/95.688af442.js"><link rel="prefetch" href="/my-blog/assets/js/96.aba3a873.js"><link rel="prefetch" href="/my-blog/assets/js/97.ca8196eb.js"><link rel="prefetch" href="/my-blog/assets/js/98.071b3a0f.js"><link rel="prefetch" href="/my-blog/assets/js/99.eca50447.js">
    <link rel="stylesheet" href="/my-blog/assets/css/0.styles.67b6080f.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/my-blog/" class="home-link router-link-active"><!----> <span class="site-name">林山夕风</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/my-blog/" class="nav-link">
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="基础教程" class="dropdown-title"><span class="title">基础教程</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/my-blog/frontend/" class="nav-link">
  前端
</a></li><li class="dropdown-item"><!----> <a href="/my-blog/backend/" class="nav-link router-link-active">
  后端
</a></li><li class="dropdown-item"><!----> <a href="/my-blog/enjoy3/" class="nav-link">
  进阶
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据结构与算法" class="dropdown-title"><span class="title">数据结构与算法</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/my-blog/structure/" class="nav-link">
  数据结构
</a></li><li class="dropdown-item"><!----> <a href="/my-blog/algorithm/" class="nav-link">
  算法
</a></li></ul></div></div><div class="nav-item"><a href="/my-blog/leetcode/" class="nav-link">
  LeetCode题解
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="设计思想" class="dropdown-title"><span class="title">设计思想</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/my-blog/principle/" class="nav-link">
  设计原则
</a></li><li class="dropdown-item"><!----> <a href="/my-blog/pattern/" class="nav-link">
  设计模式
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="读书笔记" class="dropdown-title"><span class="title">读书笔记</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/my-blog/thinking_in_java/" class="nav-link">
  Java编程思想
</a></li><li class="dropdown-item"><!----> <a href="/my-blog/refactoring_improving_the_design_of_existing_code/" class="nav-link">
  重构改善既有代码的设计
</a></li></ul></div></div><div class="nav-item"><a href="/my-blog/project/" class="nav-link">
  项目实战
</a></div><div class="nav-item"><a href="/my-blog/article/" class="nav-link">
  零散文章
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="代码管理" class="dropdown-title"><span class="title">代码管理</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://gitee.com/doomthr" target="_blank" rel="noopener noreferrer" class="nav-link external">
  码云
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://github.com/TanHaoran" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/my-blog/" class="nav-link">
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="基础教程" class="dropdown-title"><span class="title">基础教程</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/my-blog/frontend/" class="nav-link">
  前端
</a></li><li class="dropdown-item"><!----> <a href="/my-blog/backend/" class="nav-link router-link-active">
  后端
</a></li><li class="dropdown-item"><!----> <a href="/my-blog/enjoy3/" class="nav-link">
  进阶
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据结构与算法" class="dropdown-title"><span class="title">数据结构与算法</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/my-blog/structure/" class="nav-link">
  数据结构
</a></li><li class="dropdown-item"><!----> <a href="/my-blog/algorithm/" class="nav-link">
  算法
</a></li></ul></div></div><div class="nav-item"><a href="/my-blog/leetcode/" class="nav-link">
  LeetCode题解
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="设计思想" class="dropdown-title"><span class="title">设计思想</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/my-blog/principle/" class="nav-link">
  设计原则
</a></li><li class="dropdown-item"><!----> <a href="/my-blog/pattern/" class="nav-link">
  设计模式
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="读书笔记" class="dropdown-title"><span class="title">读书笔记</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/my-blog/thinking_in_java/" class="nav-link">
  Java编程思想
</a></li><li class="dropdown-item"><!----> <a href="/my-blog/refactoring_improving_the_design_of_existing_code/" class="nav-link">
  重构改善既有代码的设计
</a></li></ul></div></div><div class="nav-item"><a href="/my-blog/project/" class="nav-link">
  项目实战
</a></div><div class="nav-item"><a href="/my-blog/article/" class="nav-link">
  零散文章
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="代码管理" class="dropdown-title"><span class="title">代码管理</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://gitee.com/doomthr" target="_blank" rel="noopener noreferrer" class="nav-link external">
  码云
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://github.com/TanHaoran" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>基础教程</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/my-blog/backend/线程基础.html" class="sidebar-link">线程基础</a></li><li><a href="/my-blog/backend/线程之间的共享和协作.html" class="sidebar-link">线程之间的共享和协作</a></li><li><a href="/my-blog/backend/线程的并发工具类.html" class="sidebar-link">线程的并发工具类</a></li><li><a href="/my-blog/backend/原子操作CAS.html" class="sidebar-link">原子操作CAS</a></li><li><a href="/my-blog/backend/显示锁和AQS.html" class="sidebar-link">显示锁和AQS</a></li><li><a href="/my-blog/backend/并发容器.html" class="sidebar-link">并发容器</a></li><li><a href="/my-blog/backend/线程池.html" class="sidebar-link">线程池</a></li><li><a href="/my-blog/backend/并发安全.html" class="sidebar-link">并发安全</a></li><li><a href="/my-blog/backend/JMM和底层实现原理.html" class="sidebar-link">JMM和底层实现原理</a></li><li><a href="/my-blog/backend/Java8新增的并发.html" class="sidebar-link">Java8新增的并发</a></li><li><a href="/my-blog/backend/常见并发面试题.html" class="sidebar-link">常见并发面试题</a></li><li><a href="/my-blog/backend/深入理解JVM内存区域.html" class="sidebar-link">深入理解JVM内存区域</a></li><li><a href="/my-blog/backend/JVM如何创建对象.html" class="sidebar-link">JVM如何创建对象</a></li><li><a href="/my-blog/backend/垃圾回收算法与垃圾回收器.html" class="sidebar-link">垃圾回收算法与垃圾回收器</a></li><li><a href="/my-blog/backend/JVM执行子系统.html" class="sidebar-link">JVM执行子系统</a></li><li><a href="/my-blog/backend/JVM性能优化.html" class="sidebar-link">JVM性能优化</a></li><li><a href="/my-blog/backend/MySQL安装和基础数据类型.html" class="sidebar-link">MySQL安装和基础数据类型</a></li><li><a href="/my-blog/backend/MySQL体系架构.html" class="sidebar-link">MySQL体系架构</a></li><li><a href="/my-blog/backend/MySQL锁与事务的分析.html" class="sidebar-link">MySQL锁与事务的分析</a></li><li><a href="/my-blog/backend/MySQL业务设计.html" class="sidebar-link">MySQL业务设计</a></li><li><a href="/my-blog/backend/MySQL慢查询.html" class="sidebar-link">MySQL慢查询</a></li><li><a href="/my-blog/backend/MySQL索引和执行计划.html" class="sidebar-link">MySQL索引和执行计划</a></li><li><a href="/my-blog/backend/MySQL的SQL优化.html" class="sidebar-link">MySQL的SQL优化</a></li><li><a href="/my-blog/backend/Linux基础.html" class="sidebar-link">Linux基础</a></li><li><a href="/my-blog/backend/反射：框架设计的灵魂.html" class="sidebar-link">反射：框架设计的灵魂</a></li><li><a href="/my-blog/backend/Java8新增特性.html" class="sidebar-link">Java8新增特性</a></li><li><a href="/my-blog/backend/MyBatis应用.html" class="sidebar-link">MyBatis应用</a></li><li><a href="/my-blog/backend/MyBatis源码骨架分析.html" class="active sidebar-link">MyBatis源码骨架分析</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/my-blog/backend/MyBatis源码骨架分析.html#一、mybatis-源码概述" class="sidebar-link">一、MyBatis 源码概述</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/my-blog/backend/MyBatis源码骨架分析.html#_1、怎么下载-mybatis-源码" class="sidebar-link">1、怎么下载 MyBatis 源码</a></li><li class="sidebar-sub-header"><a href="/my-blog/backend/MyBatis源码骨架分析.html#_2、源码架构分析" class="sidebar-link">2、源码架构分析</a></li><li class="sidebar-sub-header"><a href="/my-blog/backend/MyBatis源码骨架分析.html#_3、外观模式（门面模式）" class="sidebar-link">3、外观模式（门面模式）</a></li><li class="sidebar-sub-header"><a href="/my-blog/backend/MyBatis源码骨架分析.html#_4、面向对象设计需要遵循的六大设计原则" class="sidebar-link">4、面向对象设计需要遵循的六大设计原则</a></li></ul></li><li class="sidebar-sub-header"><a href="/my-blog/backend/MyBatis源码骨架分析.html#二、日志模块分析" class="sidebar-link">二、日志模块分析</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/my-blog/backend/MyBatis源码骨架分析.html#_1、日志模块需求分析" class="sidebar-link">1、日志模块需求分析</a></li><li class="sidebar-sub-header"><a href="/my-blog/backend/MyBatis源码骨架分析.html#_2、适配器模式" class="sidebar-link">2、适配器模式</a></li><li class="sidebar-sub-header"><a href="/my-blog/backend/MyBatis源码骨架分析.html#_3、怎么实现优先加载日志组件" class="sidebar-link">3、怎么实现优先加载日志组件</a></li><li class="sidebar-sub-header"><a href="/my-blog/backend/MyBatis源码骨架分析.html#_4、代理模式和动态代理" class="sidebar-link">4、代理模式和动态代理</a></li><li class="sidebar-sub-header"><a href="/my-blog/backend/MyBatis源码骨架分析.html#_5、优雅的增强日志功能" class="sidebar-link">5、优雅的增强日志功能</a></li></ul></li><li class="sidebar-sub-header"><a href="/my-blog/backend/MyBatis源码骨架分析.html#三、数据源模块分析" class="sidebar-link">三、数据源模块分析</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/my-blog/backend/MyBatis源码骨架分析.html#_1、简单工厂模式" class="sidebar-link">1、简单工厂模式</a></li><li class="sidebar-sub-header"><a href="/my-blog/backend/MyBatis源码骨架分析.html#_2、工厂模式" class="sidebar-link">2、工厂模式</a></li><li class="sidebar-sub-header"><a href="/my-blog/backend/MyBatis源码骨架分析.html#_3、数据源的创建" class="sidebar-link">3、数据源的创建</a></li><li class="sidebar-sub-header"><a href="/my-blog/backend/MyBatis源码骨架分析.html#_4、数据库连接池技术解析" class="sidebar-link">4、数据库连接池技术解析</a></li></ul></li><li class="sidebar-sub-header"><a href="/my-blog/backend/MyBatis源码骨架分析.html#四、缓存模块分析" class="sidebar-link">四、缓存模块分析</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/my-blog/backend/MyBatis源码骨架分析.html#_1、需求分析" class="sidebar-link">1、需求分析</a></li><li class="sidebar-sub-header"><a href="/my-blog/backend/MyBatis源码骨架分析.html#_2、装饰器模式" class="sidebar-link">2、装饰器模式</a></li><li class="sidebar-sub-header"><a href="/my-blog/backend/MyBatis源码骨架分析.html#_3、装饰器在缓存模块的使用" class="sidebar-link">3、装饰器在缓存模块的使用</a></li><li class="sidebar-sub-header"><a href="/my-blog/backend/MyBatis源码骨架分析.html#_4、缓存的唯一标识-cachekey" class="sidebar-link">4、缓存的唯一标识 CacheKey</a></li><li class="sidebar-sub-header"><a href="/my-blog/backend/MyBatis源码骨架分析.html#_5、反射模块分析" class="sidebar-link">5、反射模块分析</a></li></ul></li></ul></li><li><a href="/my-blog/backend/MyBatis源码流程分析.html" class="sidebar-link">MyBatis源码流程分析</a></li><li><a href="/my-blog/backend/消息中间件入门，AMQP与RabbitMQ.html" class="sidebar-link">消息中间件入门，AMQP与RabbitMQ</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="mybatis源码骨架分析"><a href="#mybatis源码骨架分析" class="header-anchor">#</a> MyBatis源码骨架分析</h1> <div><span id="/my-blog/backend/MyBatis源码骨架分析.html" data-flag-title="MyBatis源码骨架分析" class="leancloud_visitors read-count"><em class="post-meta-item-text">阅读量 </em> <i class="leancloud-visitors-count">loading</i></span> <div class="clear-both"></div></div> <h2 id="一、mybatis-源码概述"><a href="#一、mybatis-源码概述" class="header-anchor">#</a> 一、MyBatis 源码概述</h2> <h3 id="_1、怎么下载-mybatis-源码"><a href="#_1、怎么下载-mybatis-源码" class="header-anchor">#</a> 1、怎么下载 MyBatis 源码</h3> <p>MyBatis 源码下载地址：<a href="https://github.com/MyBatis/MyBatis-3" target="_blank" rel="noopener noreferrer">https://github.com/MyBatis/MyBatis-3<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>源码包导入过程：</p> <ol><li>下载 <code>MyBatis</code> 的源码</li> <li>检查 <code>maven</code> 的版本，必须是 3.25 以上，建议使用 <code>maven</code> 的最新版本</li> <li><code>MyBatis</code> 的工程是 <code>maven</code> 工程，在开发工具中导入，工程必须使用 <code>jdk1.8</code> 以上版本；</li> <li>把 <code>MyBatis</code> 源码的 <code>pom</code> 文件中 <code>&lt;optional&gt;true&lt;/optional&gt;</code>，全部改为 <code>false</code>（如果第5步执行报错的话，再修改这一步）</li> <li>在工程目录下执行 <code>mvn clean install -Dmaven.test.skip=true</code>，将当前工程安装到本地仓库（<code>pdf</code> 插件报错的话，需要将这个插件屏蔽）；注意：安装过程中会可能会有很多异常信息，只要不中断运行，请耐心等待；</li> <li>其他工程依赖此工程</li></ol> <h3 id="_2、源码架构分析"><a href="#_2、源码架构分析" class="header-anchor">#</a> 2、源码架构分析</h3> <p><code>MyBatis</code> 源码共 16 个模块，可以分成三层，如下图：</p> <p><img src="https://yjtravel-public.oss-cn-beijing.aliyuncs.com/my-blog/basic/mybatis_struct.png" alt="mybatis架构图"></p> <ul><li>基础支撑层：技术组件专注于底层技术实现，通用性较强无业务含义；</li> <li>核心处理层：业务组件专注 <code>MyBatis</code> 的业务流程实现，依赖于基础支撑层；</li> <li>接口层：<code>MyBatis</code> 对外提供的访问接口，面向 <code>SqlSession</code> 编程；</li></ul> <p>系统为什么要分层？</p> <ol><li>代码和系统的可维护性更高。系统分层之后，每个层次都有自己的定位，每个层次内部的组件都有自己的分工，系统就会变得很清晰，维护起来非常明确；</li> <li>方便开发团队分工和开发效率的提升；举个例子，<code>mybatis</code> 这么大的一个源码框架不可能是一个人开发的，他需要一个团队，团队之间肯定有分工，既然有了层次的划分，分工也会变得容易，开发人员可以专注于某一层的某一个模块的实现，专注力提升了，开发效率自然也会提升；</li> <li>提高系统的伸缩性和性能。系统分层之后，我们只要把层次之间的调用接口明确了，那我们就可以从逻辑上的分层变成物理上的分层。当系统并发量吞吐量上来了，怎么办？为了提高系统伸缩性和性能，我们可以把不同的层部署在不同服务器集群上，不同的组件放在不同的机器上，用多台机器去抗压力，这就提高了系统的性能。压力大的时候扩展节点加机器，压力小的时候，压缩节点减机器，系统的伸缩性就是这么来的；</li></ol> <h3 id="_3、外观模式（门面模式）"><a href="#_3、外观模式（门面模式）" class="header-anchor">#</a> 3、外观模式（门面模式）</h3> <p>从源码的架构分析，特别是接口层的设计，可以看出来MyBatis的整体架构符合门面模式的。门面模式定义：提供了一个统一的接口，用来访问子系统中的一群接口。外观模式定义了一个高层接口，让子系统更容易使用。类图如下：</p> <p><img src="https://yjtravel-public.oss-cn-beijing.aliyuncs.com/my-blog/basic/mybatis_pattern.png" alt="mybatis架构图"></p> <ul><li><p>Facade 角色：提供一个外观接口，对外，它提供一个易于客户端访问的接口，对内，它可以访问子系统中的所有功能。</p></li> <li><p>SubSystem（子系统）角色：子系统在整个系统中可以是一个或多个模块，每个模块都有若干类组成，这些类可能相互之间有着比较复杂的关系。</p></li> <li><p>门面模式优点：</p></li></ul> <p>使复杂子系统的接口变的简单可用，减少了客户端对子系统的依赖，达到了解耦的效果；遵循了 <code>OO</code> 原则中的迪米特法则，对内封装具体细节，对外只暴露必要的接口。</p> <ul><li>门面模式使用场景：</li></ul> <ol><li>一个复杂的模块或子系统提供一个供外界访问的接口</li> <li>子系统相对独立 ― 外界对子系统的访问只要黑箱操作即可</li></ol> <h3 id="_4、面向对象设计需要遵循的六大设计原则"><a href="#_4、面向对象设计需要遵循的六大设计原则" class="header-anchor">#</a> 4、面向对象设计需要遵循的六大设计原则</h3> <p>学习源码的目的除了学习编程的技巧、经验之外，最重要的是学习源码的设计的思想以及设计模式的灵活应用，因此在学习源码之前有必要对面向对象设计的几个原则先深入的去了解，让自己具备良好的设计思想和理念；</p> <ol><li>单一职责原则：一个类或者一个接口只负责唯一项职责，尽量设计出功能单一的接口；</li> <li>依赖倒转原则：高层模块不应该依赖低层模块具体实现，解耦高层与低层。既面向接口编程，当实现发生变化时，只需提供新的实现类，不需要修改高层模块代码;</li> <li>开放-封闭原则：程序对外扩展开放，对修改关闭；换句话说，当需求发生变化时，我们可以通过添加新模块来满足新需求，而不是通过修改原来的实现代码来满足新需求；</li> <li>迪米特法则：一个对象应该对其他对象保持最少的了解，尽量降低类与类之间的耦合度；实现这个原则，要注意两个点，一方面在做类结构设计的时候尽量降低成员的访问权限，能用 <code>private</code> 的尽量用 <code>private</code>；另外在类之间，如果没有必要直接调用，就不要有依赖关系；这个法则强调的还是类之间的松耦合；</li> <li>里氏代换原则：所有引用基类（父类）的地方必须能透明地使用其子类的对象；</li> <li>接口隔离原则：客户端不应该依赖它不需要的接口，一个类对另一个类的依赖应该建立在最小的接口上；</li></ol> <h2 id="二、日志模块分析"><a href="#二、日志模块分析" class="header-anchor">#</a> 二、日志模块分析</h2> <h3 id="_1、日志模块需求分析"><a href="#_1、日志模块需求分析" class="header-anchor">#</a> 1、日志模块需求分析</h3> <ol><li><code>MyBatis</code> 没有提供日志的实现类，需要接入第三方的日志组件，但第三方日志组件都有各自的 <code>Log</code> 级别，且各不相同，而 <code>MyBatis</code> 统一提供了 <code>trace</code>、<code>debug</code>、<code>warn</code>、<code>error</code> 四个级别；</li> <li>自动扫描日志实现，并且第三方日志插件加载优先级如下：<code>slf4J</code> → <code>commonsLoging</code> → <code>Log4J2</code> → <code>Log4J</code> → <code>JdkLog</code>;</li> <li>日志的使用要优雅的嵌入到主体功能中；</li></ol> <h3 id="_2、适配器模式"><a href="#_2、适配器模式" class="header-anchor">#</a> 2、适配器模式</h3> <p>日志模块的第一个需求是一个典型的使用适配器模式的场景，适配器模式（<code>Adapter Pattern</code>）是作为两个不兼容的接口之间的桥梁，将一个类的接口转换成客户希望的另外一个接口。适配器模式使得原本由于接口不兼容而不能一起工作的那些类可以一起工作；类图如下：</p> <p><img src="https://yjtravel-public.oss-cn-beijing.aliyuncs.com/my-blog/basic/adapter_pattern.png" alt="适配器模式"></p> <ul><li>Target：目标角色,期待得到的接口.</li> <li>Adaptee：适配者角色,被适配的接口.</li> <li>Adapter：适配器角色,将源接口转换成目标接口.</li></ul> <p>适用场景：</p> <p>当调用双方都不太容易修改的时候，为了复用现有组件可以使用适配器模式；在系统中接入第三方组件的时候经常被使用到；注意：如果系统中存在过多的适配器，会增加系统的复杂性，设计人员应考虑对系统进行重构；</p> <p>MyBatis 日志模块是怎么使用适配器模式？实现如下：</p> <ul><li>Target：目标角色,期待得到的接口。<code>org.apache.ibatis.logging.Log</code> 接口，对内提供了统一的日志接口；</li> <li>Adaptee：适配者角色,被适配的接口。其他日志组件组件如 <code>slf4J</code> <code>、commonsLoging</code> <code>、Log4J2</code> 等被包含在适配器中。</li> <li>Adapter：适配器角色,将源接口转换成目标接口。针对每个日志组件都提供了适配器，每个适配器都对特定的日志组件进行封装和转换； 如 <code>Slf4jLoggerImpl</code> <code>、JakartaCommonsLoggingImpl</code> 等；</li></ul> <p>日志模块适配器结构类图：</p> <p><img src="https://yjtravel-public.oss-cn-beijing.aliyuncs.com/my-blog/basic/adapter_pattern_pic.png" alt="适配器结构类图"></p> <p>总结：日志模块实现采用适配器模式，日志组件（<code>Target</code>）、适配器以及统一接口（<code>Log</code> 接口）定义清晰明确符合单一职责原则；同时，客户端在使用日志时，面向 <code>Log</code> 接口编程，不需要关心底层日志模块的实现，符合依赖倒转原则；最为重要的是，如果需要加入其他第三方日志框架，只需要扩展新的模块满足新需求，而不需要修改原有代码，这又符合了开闭原则；</p> <h3 id="_3、怎么实现优先加载日志组件"><a href="#_3、怎么实现优先加载日志组件" class="header-anchor">#</a> 3、怎么实现优先加载日志组件</h3> <p>见 <code>org.apache.ibatis.logging.LogFactory</code> 中的静态代码块，通过静态代码块确保第三方日志插件加载优先级如下：<code>slf4J</code> → <code>commonsLoging</code> → <code>Log4J2</code> → <code>Log4J</code> → <code>JdkLog</code>;</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">LogFactory</span> <span class="token punctuation">{</span>

  <span class="token comment">/**
   * Marker to be used by logging implementations that support markers.
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> MARKER <span class="token operator">=</span> <span class="token string">&quot;MYBATIS&quot;</span><span class="token punctuation">;</span>

  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Constructor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">Log</span><span class="token punctuation">&gt;</span></span> logConstructor<span class="token punctuation">;</span>

  <span class="token keyword">static</span> <span class="token punctuation">{</span>
    <span class="token function">tryImplementation</span><span class="token punctuation">(</span><span class="token class-name">LogFactory</span><span class="token operator">::</span><span class="token function">useSlf4jLogging</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">tryImplementation</span><span class="token punctuation">(</span><span class="token class-name">LogFactory</span><span class="token operator">::</span><span class="token function">useCommonsLogging</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">tryImplementation</span><span class="token punctuation">(</span><span class="token class-name">LogFactory</span><span class="token operator">::</span><span class="token function">useLog4J2Logging</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">tryImplementation</span><span class="token punctuation">(</span><span class="token class-name">LogFactory</span><span class="token operator">::</span><span class="token function">useLog4JLogging</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">tryImplementation</span><span class="token punctuation">(</span><span class="token class-name">LogFactory</span><span class="token operator">::</span><span class="token function">useJdkLogging</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">tryImplementation</span><span class="token punctuation">(</span><span class="token class-name">LogFactory</span><span class="token operator">::</span><span class="token function">useNoLogging</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">private</span> <span class="token class-name">LogFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// disable construction</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><h3 id="_4、代理模式和动态代理"><a href="#_4、代理模式和动态代理" class="header-anchor">#</a> 4、代理模式和动态代理</h3> <p>代理模式定义：给目标对象提供一个代理对象，并由代理对象控制对目标对象的引用；</p> <p>目的：</p> <ol><li>通过引入代理对象的方式来间接访问目标对象，防止直接访问目标对象给系统带来的不必要复杂性；</li> <li>通过代理对象对原有的业务增强；</li></ol> <p>代理模式类图：</p> <p><img src="https://yjtravel-public.oss-cn-beijing.aliyuncs.com/my-blog/basic/proxy_pattern.png" alt="代理模式"></p> <p>代理模式有静态代理和动态代理两种实现方式。</p> <h4 id="_1-静态代理"><a href="#_1-静态代理" class="header-anchor">#</a> (1) 静态代理</h4> <p>这种代理方式需要代理对象和目标对象实现一样的接口。</p> <p>优点：可以在不修改目标对象的前提下扩展目标对象的功能。</p> <p>缺点：</p> <ul><li>冗余。由于代理对象要实现与目标对象一致的接口，会产生过多的代理类。</li> <li>不易维护。一旦接口增加方法，目标对象与代理对象都要进行修改。</li></ul> <h4 id="_2-动态代理"><a href="#_2-动态代理" class="header-anchor">#</a> (2) 动态代理</h4> <p>动态代理利用了 <code>JDK API</code>，动态地在内存中构建代理对象，从而实现对目标对象的代理功能。</p> <p>动态代理又被称为 <code>JDK</code> 代理或接口代理。静态代理与动态代理的区别主要在：</p> <ol><li>静态代理在编译时就已经实现，编译完成后代理类是一个实际的 <code>class</code> 文件</li> <li>动态代理是在运行时动态生成的，即编译完成后没有实际的 <code>class</code> 文件，而是在运行时动态生成类字节码，并加载到 JVM 中</li></ol> <p>注意：动态代理对象不需要实现接口，但是要求目标对象必须实现接口，否则不能使用动态代理。</p> <p><code>JDK</code> 中生成代理对象主要涉及两个类：</p> <p>第一个类为 <code>java.lang.reflect.Proxy</code>，通过静态方法 <code>newProxyInstance</code> 生成代理对象，<code>newProxyInstance</code> 有3个参数，第一个是类加载器，第二个是被代理对象实现的所有接口的字节码数组，第三个是执行处理器，用户定义方法的增强规则，也就是下面的 <code>InvocationHandler</code> 类。</p> <p>第二个为 <code>java.lang.reflect.InvocationHandler</code> 接口，通过 <code>invoke()</code> 方法对业务进行增强；</p> <h3 id="_5、优雅的增强日志功能"><a href="#_5、优雅的增强日志功能" class="header-anchor">#</a> 5、优雅的增强日志功能</h3> <p>首先搞清楚那些地方需要打印日志？通过对日志的观察，如下几个位置需要打日志：</p> <ol><li>在创建 <code>prepareStatement</code> 时，打印执行的 <code>SQL</code> 语句；</li> <li>访问数据库时，打印参数的类型和值</li> <li>查询出结构后，打印结果数据条数</li></ol> <p>因此在日志模块中有 <code>BaseJdbcLogger</code>、<code>ConnectionLogger</code>、<code>PreparedStatementLogger</code> 和 <code>ResultSetLogger</code> 通过动态代理负责在不同的位置打印日志；几个相关类的类图如下：</p> <p><img src="https://yjtravel-public.oss-cn-beijing.aliyuncs.com/my-blog/basic/log_class.png" alt="日志模块类图"></p> <ul><li>BaseJdbcLogger：所有日志增强的抽象基类，用于记录 <code>JDBC</code> 哪些方法需要增强，保存运行期间 <code>sql</code> 参数信息；</li></ul> <p><code>BaseJdbcLogger</code> 一些重要的成员变量：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>  <span class="token comment">// 保存 prepareStatement 中常用的 set() 方法（占位符赋值）</span>
  <span class="token keyword">protected</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> SET_METHODS<span class="token punctuation">;</span>
  <span class="token comment">// 保存 prepareStatement 中常用的执行 sql 语句的方法</span>
  <span class="token keyword">protected</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> EXECUTE_METHODS <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 保存 prepareStatement 中 set() 方法的键值对</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> columnMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 保存 prepareStatement 中 set() 方法的 key</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> columnNames <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// prepareStatement 中 set() 方法的的 value</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> columnValues <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><ul><li>ConnectionLogger：负责打印连接信息和 <code>SQL</code> 语句。通过动态代理，对 <code>connection</code> 对象进行增强，如果是调用 <code>prepareStatement()</code>、<code>prepareCall()</code>、<code>createStatement()</code> 的方法，打印要执行的 <code>sql</code> 语句并返回 <code>prepareStatement()</code> 的代理对象（<code>PreparedStatementLogger</code>），让 <code>prepareStatement</code> 也具备日志能力，打印参数；</li></ul> <div class="language-java line-numbers-mode"><pre class="language-java"><code>  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">Object</span> proxy<span class="token punctuation">,</span> <span class="token class-name">Method</span> method<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> params<span class="token punctuation">)</span>
      <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token comment">// 忽略掉从 Object 继承的方法</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>method<span class="token punctuation">.</span><span class="token function">getDeclaringClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> method<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> params<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 下面的方法需要增强</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">&quot;prepareStatement&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>method<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token string">&quot;prepareCall&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>method<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot; Preparing: &quot;</span> <span class="token operator">+</span> <span class="token function">removeBreakingWhitespace</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> params<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">PreparedStatement</span> stmt <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">PreparedStatement</span><span class="token punctuation">)</span> method<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>connection<span class="token punctuation">,</span> params<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 对上面返回的 PreparedStatement 也需要增强</span>
        stmt <span class="token operator">=</span> <span class="token class-name">PreparedStatementLogger</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span>stmt<span class="token punctuation">,</span> statementLog<span class="token punctuation">,</span> queryStack<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> stmt<span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">&quot;createStatement&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>method<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Statement</span> stmt <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Statement</span><span class="token punctuation">)</span> method<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>connection<span class="token punctuation">,</span> params<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 对上面返回的 Statement 也需要增强</span>
        stmt <span class="token operator">=</span> <span class="token class-name">StatementLogger</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span>stmt<span class="token punctuation">,</span> statementLog<span class="token punctuation">,</span> queryStack<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> stmt<span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> method<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>connection<span class="token punctuation">,</span> params<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token class-name">ExceptionUtil</span><span class="token punctuation">.</span><span class="token function">unwrapThrowable</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  
  <span class="token comment">/**
   * Creates a logging version of a connection.
   *
   * @param conn
   *          the original connection
   * @param statementLog
   *          the statement log
   * @param queryStack
   *          the query stack
   * @return the connection with logging
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Connection</span> <span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token class-name">Connection</span> conn<span class="token punctuation">,</span> <span class="token class-name">Log</span> statementLog<span class="token punctuation">,</span> <span class="token keyword">int</span> queryStack<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">InvocationHandler</span> handler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConnectionLogger</span><span class="token punctuation">(</span>conn<span class="token punctuation">,</span> statementLog<span class="token punctuation">,</span> queryStack<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">ClassLoader</span> cl <span class="token operator">=</span> <span class="token class-name">Connection</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">Connection</span><span class="token punctuation">)</span> <span class="token class-name">Proxy</span><span class="token punctuation">.</span><span class="token function">newProxyInstance</span><span class="token punctuation">(</span>cl<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token class-name">Connection</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">,</span> handler<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br></div></div><ul><li>PreparedStatementLogger：对 <code>prepareStatement</code> 对象增强，增强的点如下：</li></ul> <ol><li>增强 <code>PreparedStatement</code> 的 <code>setxxx</code> 方法将参数设置到 <code>columnMap</code>、<code>columnNames</code>、<code>columnValues</code>，为打印参数做好准备；</li> <li>增强 <code>PreparedStatement</code> 的 <code>execute</code> 相关方法，当方法执行时，通过动态代理打印参数,返回动态代理能力的 <code>resultSet；</code></li> <li>如果是查询，增强 <code>PreparedStatement</code> 的 <code>getResultSet</code> 方法，返回动态代理能力的 <code>resultSet</code>；如果是更新，直接打印影响的行数</li></ol> <div class="language-java line-numbers-mode"><pre class="language-java"><code>  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">Object</span> proxy<span class="token punctuation">,</span> <span class="token class-name">Method</span> method<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> params<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>method<span class="token punctuation">.</span><span class="token function">getDeclaringClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> method<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> params<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>EXECUTE_METHODS<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>method<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// 打印参数</span>
          <span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Parameters: &quot;</span> <span class="token operator">+</span> <span class="token function">getParameterValueString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">clearColumnInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">&quot;executeQuery&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>method<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token class-name">ResultSet</span> rs <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ResultSet</span><span class="token punctuation">)</span> method<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>statement<span class="token punctuation">,</span> params<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span> rs <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token operator">:</span> <span class="token class-name">ResultSetLogger</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span>rs<span class="token punctuation">,</span> statementLog<span class="token punctuation">,</span> queryStack<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> method<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>statement<span class="token punctuation">,</span> params<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>SET_METHODS<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>method<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 将参数设置到 columnMap、columnNames、columnValues，为打印参数做好准备</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">&quot;setNull&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>method<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">setColumn</span><span class="token punctuation">(</span>params<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token function">setColumn</span><span class="token punctuation">(</span>params<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> params<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> method<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>statement<span class="token punctuation">,</span> params<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">&quot;getResultSet&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>method<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ResultSet</span> rs <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ResultSet</span><span class="token punctuation">)</span> method<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>statement<span class="token punctuation">,</span> params<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> rs <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token operator">:</span> <span class="token class-name">ResultSetLogger</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span>rs<span class="token punctuation">,</span> statementLog<span class="token punctuation">,</span> queryStack<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">&quot;getUpdateCount&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>method<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> updateCount <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">)</span> method<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>statement<span class="token punctuation">,</span> params<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>updateCount <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;   Updates: &quot;</span> <span class="token operator">+</span> updateCount<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> updateCount<span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> method<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>statement<span class="token punctuation">,</span> params<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token class-name">ExceptionUtil</span><span class="token punctuation">.</span><span class="token function">unwrapThrowable</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Creates a logging version of a PreparedStatement.
   *
   * @param stmt - the statement
   * @param statementLog - the statement log
   * @param queryStack - the query stack
   * @return - the proxy
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">PreparedStatement</span> <span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token class-name">PreparedStatement</span> stmt<span class="token punctuation">,</span> <span class="token class-name">Log</span> statementLog<span class="token punctuation">,</span> <span class="token keyword">int</span> queryStack<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">InvocationHandler</span> handler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PreparedStatementLogger</span><span class="token punctuation">(</span>stmt<span class="token punctuation">,</span> statementLog<span class="token punctuation">,</span> queryStack<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">ClassLoader</span> cl <span class="token operator">=</span> <span class="token class-name">PreparedStatement</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">PreparedStatement</span><span class="token punctuation">)</span> <span class="token class-name">Proxy</span><span class="token punctuation">.</span><span class="token function">newProxyInstance</span><span class="token punctuation">(</span>cl<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token class-name">PreparedStatement</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">CallableStatement</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">,</span> handler<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br></div></div><ul><li>ResultSetLogger：负责打印数据结果信息，对 <code>next()</code> 方法增强；</li></ul> <div class="language-java line-numbers-mode"><pre class="language-java"><code>  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">Object</span> proxy<span class="token punctuation">,</span> <span class="token class-name">Method</span> method<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> params<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>method<span class="token punctuation">.</span><span class="token function">getDeclaringClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> method<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> params<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token class-name">Object</span> o <span class="token operator">=</span> method<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>rs<span class="token punctuation">,</span> params<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 通过执行 result.next() 方法的结果值，判断是否还有数据</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">&quot;next&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>method<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Boolean</span><span class="token punctuation">)</span> o<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// 如果还有数据，计数器 rows 加1</span>
          rows<span class="token operator">++</span><span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isTraceEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">ResultSetMetaData</span> rsmd <span class="token operator">=</span> rs<span class="token punctuation">.</span><span class="token function">getMetaData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> <span class="token keyword">int</span> columnCount <span class="token operator">=</span> rsmd<span class="token punctuation">.</span><span class="token function">getColumnCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>first<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              first <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
              <span class="token function">printColumnHeaders</span><span class="token punctuation">(</span>rsmd<span class="token punctuation">,</span> columnCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token function">printColumnValues</span><span class="token punctuation">(</span>columnCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token comment">// 如果没有数据则打印查询出来的数据总条数</span>
          <span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;     Total: &quot;</span> <span class="token operator">+</span> rows<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token function">clearColumnInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> o<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token class-name">ExceptionUtil</span><span class="token punctuation">.</span><span class="token function">unwrapThrowable</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Creates a logging version of a ResultSet.
   *
   * @param rs
   *          the ResultSet to proxy
   * @param statementLog
   *          the statement log
   * @param queryStack
   *          the query stack
   * @return the ResultSet with logging
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">ResultSet</span> <span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token class-name">ResultSet</span> rs<span class="token punctuation">,</span> <span class="token class-name">Log</span> statementLog<span class="token punctuation">,</span> <span class="token keyword">int</span> queryStack<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">InvocationHandler</span> handler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ResultSetLogger</span><span class="token punctuation">(</span>rs<span class="token punctuation">,</span> statementLog<span class="token punctuation">,</span> queryStack<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">ClassLoader</span> cl <span class="token operator">=</span> <span class="token class-name">ResultSet</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">ResultSet</span><span class="token punctuation">)</span> <span class="token class-name">Proxy</span><span class="token punctuation">.</span><span class="token function">newProxyInstance</span><span class="token punctuation">(</span>cl<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token class-name">ResultSet</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">,</span> handler<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br></div></div><p>上面这么多，都是日志功能的实现，那日志功能是怎么加入主体功能的？</p> <p>既然在 <code>Mybatis</code> 中 <code>Executor</code> 才是访问数据库的组件，日志功能是在 <code>Executor</code> 中被嵌入的，具体代码在 <code>org.apache.ibatis.executor.SimpleExecutor.prepareStatement(StatementHandler, Log)</code>方法中，如下所示：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>  <span class="token comment">// 创建 Statement</span>
  <span class="token keyword">private</span> <span class="token class-name">Statement</span> <span class="token function">prepareStatement</span><span class="token punctuation">(</span><span class="token class-name">StatementHandler</span> handler<span class="token punctuation">,</span> <span class="token class-name">Log</span> statementLog<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span> <span class="token punctuation">{</span>
    <span class="token class-name">Statement</span> stmt<span class="token punctuation">;</span>
    <span class="token comment">// 获取 Connection 对象的动态代理，添加日志能力</span>
    <span class="token class-name">Connection</span> connection <span class="token operator">=</span> <span class="token function">getConnection</span><span class="token punctuation">(</span>statementLog<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 通过不同的 StatementHandler，利用 connection 创建 (prepare)Statement</span>
    stmt <span class="token operator">=</span> handler<span class="token punctuation">.</span><span class="token function">prepare</span><span class="token punctuation">(</span>connection<span class="token punctuation">,</span> transaction<span class="token punctuation">.</span><span class="token function">getTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 使用 parameterHandler 处理占位符</span>
    handler<span class="token punctuation">.</span><span class="token function">parameterize</span><span class="token punctuation">(</span>stmt<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> stmt<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>然后在 <code>getConnection()</code> 中获取到了增强的 <code>Connection</code> 对象：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>  <span class="token keyword">protected</span> <span class="token class-name">Connection</span> <span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token class-name">Log</span> statementLog<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span> <span class="token punctuation">{</span>
    <span class="token class-name">Connection</span> connection <span class="token operator">=</span> transaction<span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>statementLog<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token class-name">ConnectionLogger</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span>connection<span class="token punctuation">,</span> statementLog<span class="token punctuation">,</span> queryStack<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> connection<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>修改之前的工厂，让它依赖我们下载好的源码，运行过程中可能会报错，需要添加以下两个依赖：</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code>		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.javassist<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>javassist<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>3.21.0-GA<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>ognl<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>ognl<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>3.1.12<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>上面的是解决 <code>Cannot enable lazy loading because Javassist is not available. Add Javassist</code> 这个异常的。</p> <p>下面的解决 <code>java.lang.NoClassDefFoundError: ognl/PropertyAccessor</code> 这个异常的。</p> <h2 id="三、数据源模块分析"><a href="#三、数据源模块分析" class="header-anchor">#</a> 三、数据源模块分析</h2> <p>数据源模块重点讲解数据源的创建和数据库连接池的源码分析；数据源创建比较负责，对于复杂对象的创建，可以考虑使用工厂模式来优化，接下来介绍下简单工厂模式和工厂模式；</p> <h3 id="_1、简单工厂模式"><a href="#_1、简单工厂模式" class="header-anchor">#</a> 1、简单工厂模式</h3> <p>简单工厂属于类的创建型设计模式，通过专门定义一个类来负责创建其它类的实例，被创建的实例通常都具有共同的父类。类图如下：</p> <p><img src="https://yjtravel-public.oss-cn-beijing.aliyuncs.com/my-blog/basic/simple_factory.png" alt="简单工厂模式"></p> <ul><li>工厂接口（<code>Factory</code>）:简单工厂的接口，定义了创建产品的方法，具体的工厂类必须实现这个接口；</li> <li>工厂角色（<code>ConcreteFactory</code>）：这是简单工厂模式的核心，由它负责创建全部的类的内部逻辑。工厂类被外界调用，创建所须要的产品对象。</li> <li>抽象（<code>Product</code>）产品角色：简单工厂模式所创建的全部对象的父类，注意，这里的父类能够是接口也能够是抽象类，它负责描写叙述全部实例所共同拥有的公共接口。</li> <li>详细产品（<code>Concrete Product</code>）角色：简单工厂所创建的详细实例对象，这些详细的产品往往都拥有共同的父类。</li></ul> <p>简单工厂适用场景：</p> <p>简单工厂模式将对象的创建和使用进行解耦，并屏蔽了创建对象可能的复杂过程，但由于创建对象的逻辑集中工厂类当中，所以简单工厂适合于产品类型不多、需求变化不频繁的场景；</p> <p>简单工厂模式的缺点：</p> <p>工厂类负责了所有产品的实例化，违反单一职责原则，如果产品类型比较多工厂类的代码量会比较大，不利于类的可读性和扩展性；。另外当有新的产品类型加入时，必须修改工厂类原有的代码，这又违反了开闭原则；</p> <h3 id="_2、工厂模式"><a href="#_2、工厂模式" class="header-anchor">#</a> 2、工厂模式</h3> <p>工厂模式属于创建型模式，它提供了一种创建对象的最佳方式。定义一个创建对象的接口，让其子类自己决定实例化哪一个工厂类，工厂模式使其创建过程延迟到子类进行。类图如下：</p> <p><img src="https://yjtravel-public.oss-cn-beijing.aliyuncs.com/my-blog/basic/factory_pattern.png" alt="工厂模式"></p> <ul><li>产品接口（<code>Product</code>）：产品接口用于定义产品类的功能，具体工厂类产生的所有产品都必须实现这个接口。调用者与产品接口直接交互，这是调用者最关心的接口；</li> <li>具体产品类（<code>ConcreteProduct</code>）：实现产品接口的实现类，具体产品类中定义了具体的业务逻辑；</li> <li>工厂接口（<code>Factory</code>）：工厂接口是工厂方法模式的核心接口，调用者会直接和工厂接口交互用于获取具体的产品实现类；</li> <li>具体工厂类（<code>ConcreteFactory</code>）:是工厂接口的实现类，用于实例化产品对象，不同的具体工厂类会根据需求实例化不同的产品实现类；</li></ul> <p>为什么要使用工厂模式？</p> <p>答：对象可以通过 <code>new</code> 关键字、反射、<code>clone()</code> 等方式创建，也可以通过工厂模式创建。对于复杂对象，使用 <code>new</code> 关键字、反射、<code>clone()</code> 等方式创建存在如下缺点：</p> <ul><li>对象创建和对象使用的职责耦合在一起，违反单一原则；</li> <li>当业务扩展时，必须修改代业务代码，违反了开闭原则；</li></ul> <p>而使用工厂模式将对象的创建和使用进行解耦，并屏蔽了创建对象可能的复杂过程，相对简单工厂模式，又具备更好的扩展性和可维护性，优点具体如下：</p> <ul><li>把对象的创建和使用的过程分开，对象创建和对象使用使用的职责解耦；</li> <li>如果创建对象的过程很复杂，创建过程统一到工厂里管理，既减少了重复代码，也方便以后对创建过程的修改维护；</li> <li>当业务扩展时，只需要增加工厂子类，符合开闭原则；</li></ul> <h3 id="_3、数据源的创建"><a href="#_3、数据源的创建" class="header-anchor">#</a> 3、数据源的创建</h3> <p>数据源对象是比较复杂的对象，其创建过程相对比较复杂，对于 <code>MyBatis</code> 创建一个数据源，具体来讲有如下难点：</p> <ol><li>常见的数据源组件都实现了 <code>javax.sql.DataSource</code> 接口；</li> <li><code>MyBatis</code> 不但要能集成第三方的数据源组件，自身也提供了数据源的实现；</li> <li>一般情况下，数据源的初始化过程参数较多，比较复杂；</li></ol> <p>综上所述，数据源的创建是一个典型使用工厂模式的场景，实现类图如下所示：</p> <p><img src="https://yjtravel-public.oss-cn-beijing.aliyuncs.com/my-blog/basic/data_source.png" alt="数据源的创建"></p> <ul><li>DataSource：数据源接口，<code>JDBC</code> 标准规范之一，定义了获取获取 <code>Connection</code> 的方法；</li> <li>UnPooledDataSource：不带连接池的数据源，获取连接的方式和手动通过 <code>JDBC</code> 获取连接的方式是一样的；</li> <li>PooledDataSource：带连接池的数据源，提高连接资源的复用性，避免频繁创建、关闭连接资源带来的开销；</li> <li>DataSourceFactory：工厂接口，定义了创建 <code>Datasource</code> 的方法；</li> <li>UnpooledDataSourceFactory：工厂接口的实现类之一，用于创建 <code>UnpooledDataSource</code>(不带连接池的数据源)；</li> <li>PooledDataSourceFactory：工厂接口的实现类之一，用于创建 <code>PooledDataSource</code>（带连接池的数据源）；</li></ul> <h3 id="_4、数据库连接池技术解析"><a href="#_4、数据库连接池技术解析" class="header-anchor">#</a> 4、数据库连接池技术解析</h3> <p>数据库连接池技术是提升数据库访问效率常用的手段，使用连接池可以提高连接资源的复用性，避免频繁创建、关闭连接资源带来的开销，池化技术也是大厂高频面试题。<code>MyBatis</code> 内部就带了一个连接池的实现，接下来重点解析连接池技术的数据结构和算法；先重点分析下跟连接池相关的关键类：</p> <ul><li>PooledDataSource：一个简单，同步的、线程安全的数据库连接池</li> <li>PooledConnection：使用动态代理封装了真正的数据库连接对象，在连接使用之前和关闭时进行增强；</li> <li>PoolState：用于管理 <code>PooledConnection</code> 对象状态的组件，通过两个 <code>list</code> 分别管理空闲状态的连接资源和活跃状态的连接资源，如下图，需要注意的是这两个 <code>List</code> 使用 <code>ArrayList</code> 实现，存在并发安全的问题，因此在使用时，注意加上同步控制；</li></ul> <p>重点解析获取资源和回收资源的流程，获取连接资源的过程如下图：</p> <p><img src="https://yjtravel-public.oss-cn-beijing.aliyuncs.com/my-blog/basic/getConnection.png" alt="获取连接"></p> <p>回收连接资源的过程如下图：</p> <p><img src="https://yjtravel-public.oss-cn-beijing.aliyuncs.com/my-blog/basic/pushConnection.png" alt="回收连接"></p> <h2 id="四、缓存模块分析"><a href="#四、缓存模块分析" class="header-anchor">#</a> 四、缓存模块分析</h2> <h3 id="_1、需求分析"><a href="#_1、需求分析" class="header-anchor">#</a> 1、需求分析</h3> <p><code>MyBatis</code> 缓存模块需满足如下需求：</p> <ol><li><code>MyBatis</code> 缓存的实现是基于 <code>Map</code> 的，从缓存里面读写数据是缓存模块的核心基础功能；</li> <li>除核心功能之外，有很多额外的附加功能，如：防止缓存击穿，添加缓存清空策略（<code>fifo</code>、<code>lru</code>）、序列化功能、日志能力、定时清空能力等；</li> <li>附加功能可以以任意的组合附加到核心基础功能之上；</li></ol> <p>基于 <code>Map</code> 核心缓存能力，将阻塞、清空策略、序列化、日志等等能力以任意组合的方式优雅的增强是 <code>Mybatis</code> 缓存模块实现最大的难题，用动态代理或者继承的方式扩展多种附加能力的传统方式存在以下问题：这些方式是静态的，用户不能控制增加行为的方式和时机；另外，新功能的存在多种组合，使用继承可能导致大量子类存在。综上，<code>MyBtis</code> 缓存模块采用了装饰器模式实现了缓存模块；</p> <h3 id="_2、装饰器模式"><a href="#_2、装饰器模式" class="header-anchor">#</a> 2、装饰器模式</h3> <p>装饰器模式是一种用于代替继承的技术，无需通过继承增加子类就能扩展对象的新功能。使用对象的关联关系代替继承关系，更加灵活，同时避免类型体系的快速膨胀。装饰器 <code>UML</code> 类图如下：</p> <p><img src="https://yjtravel-public.oss-cn-beijing.aliyuncs.com/my-blog/basic/decorator_pattern.png" alt="装饰器模式"></p> <ul><li>组件（Component）：组件接口定义了全部组件类和装饰器实现的行为；</li> <li>组件实现类（ConcreteComponent）：实现 <code>Component</code> 接口，组件实现类就是被装饰器装饰的原始对象，新功能或者附加功能都是通过装饰器添加到该类的对象上的；</li> <li>装饰器抽象类（Decorator）：实现 <code>Component</code> 接口的抽象类，在其中封装了一个 <code>Component</code> 对象，也就是被装饰的对象；</li> <li>具体装饰器类（ConcreteDecorator）：该实现类要向被装饰的对象添加某些功能；</li></ul> <p>装饰器模式通俗易懂图示：</p> <p><img src="https://yjtravel-public.oss-cn-beijing.aliyuncs.com/my-blog/basic/simple_decorator.png" alt="通俗装饰器模式"></p> <p>装饰器相对于继承，装饰器模式灵活性更强，扩展性更强：</p> <ul><li>灵活性：装饰器模式将功能切分成一个个独立的装饰器，在运行期可以根据需要动态的添加功能，甚至对添加的新功能进行自由的组合；</li> <li>扩展性：当有新功能要添加的时候，只需要添加新的装饰器实现类，然后通过组合方式添加这个新装饰器，无需修改已有代码，符合开闭原则；</li></ul> <p>装饰器模式使用举例：</p> <ol><li><code>IO</code> 中输入流和输出流的设计</li></ol> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">BufferedReader</span> bufferedReader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BufferedReader</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">InputStreamReader</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span><span class="token string">&quot;c://a.txt&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ol start="2"><li>对网络爬虫的自定义增强，可增强的功能包括：多线程能力、缓存、自动生成报表、黑白名单、<code>random</code> 触发等</li></ol> <h3 id="_3、装饰器在缓存模块的使用"><a href="#_3、装饰器在缓存模块的使用" class="header-anchor">#</a> 3、装饰器在缓存模块的使用</h3> <p>MyBatis 缓存模块是一个经典的使用装饰器实现的模块，类图如下：</p> <p><img src="https://yjtravel-public.oss-cn-beijing.aliyuncs.com/my-blog/basic/mybatis_cache.png" alt="MyBatis缓存"></p> <ul><li>Cache：Cache 接口是缓存模块的核心接口，定义了缓存的基本操作；</li> <li>PerpetualCache：在缓存模块中扮演 <code>ConcreteComponent</code> 角色，使用 <code>HashMap</code> 来实现 <code>cache</code> 的相关操作；</li> <li>BlockingCache：阻塞版本的缓存装饰器，保证只有一个线程到数据库去查找指定的 <code>key</code> 对应的数据；</li></ul> <p>BlockingCache 是阻塞版本的缓存装饰器，这个装饰器通过 ConcurrentHashMap 对锁的粒度进行了控制，提高加锁后系统代码运行的效率（注：缓存雪崩的问题可以使用细粒度锁的方式提升锁性能），源码分析见：<code>org.apache.ibatis.cache.decorators.BlockingCache</code>；除了 <code>BlockingCache</code> 之外，缓存模块还有其他的装饰器如：</p> <ol><li>LoggingCache：日志能力的缓存；</li> <li>ScheduledCache：定时清空的缓存；</li> <li>BlockingCache：阻塞式缓存；</li> <li>SerializedCache：序列化能力的缓存；</li> <li>SynchronizedCache：进行同步控制的缓存；</li></ol> <h4 id="mybatis-的缓存功能使用-hashmap-实现会不会出现并发安全的问题？"><a href="#mybatis-的缓存功能使用-hashmap-实现会不会出现并发安全的问题？" class="header-anchor">#</a> Mybatis 的缓存功能使用 HashMap 实现会不会出现并发安全的问题？</h4> <p>答：<code>MyBatis</code> 的缓存分为一级缓存、二级缓存。二级缓存是多个会话共享的缓存，确实会出现并发安全的问题，因此 <code>MyBatis</code> 在初始化二级缓存时，会给二级缓存默认加上 <code>SynchronizedCache</code> 装饰器的增强，在对共享数据 <code>HashMap</code> 操作时进行同步控制，所以二级缓存不会出现并发安全问题；而一级缓存是会话独享的，不会出现多个线程同时操作缓存数据的场景，因此一级缓存也不会出现并发安全的问题；</p> <h3 id="_4、缓存的唯一标识-cachekey"><a href="#_4、缓存的唯一标识-cachekey" class="header-anchor">#</a> 4、缓存的唯一标识 CacheKey</h3> <p><code>MyBatis</code> 中涉及到动态 <code>SQL</code> 的原因，缓存项的 <code>key</code> 不能仅仅通过一个 <code>String</code> 来表示，所以通过 <code>CacheKey</code> 来封装缓存的 <code>Key</code> 值，<code>CacheKey</code> 可以封装多个影响缓存项的因素；判断两个 <code>CacheKey</code> 是否相同关键是比较两个对象的hash值是否一致；构成 <code>CacheKey</code> 对象的要素包括：</p> <ol><li><code>mappedStatment</code> 的 <code>id</code></li> <li>指定查询结果集的范围（分页信息）</li> <li>查询所使用的 <code>SQL</code> 语句</li> <li>用户传递给 <code>SQL</code> 语句的实际参数值</li></ol> <p><code>CacheKey</code> 中 <code>update()</code> 方法和 <code>equals()</code> 方法是进行比较时非常重要的两个方法：</p> <ul><li>update 方法：用于添加构成 <code>CacheKey</code> 对象的要素，每添加上面4个元素的其中一个，就会对 <code>hashcode</code>、<code>checksum</code>、<code>count</code> 以及 <code>updateList</code> 进行更新；</li></ul> <div class="language-java line-numbers-mode"><pre class="language-java"><code>  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token class-name">Object</span> object<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 获取object的hash值</span>
    <span class="token keyword">int</span> baseHashCode <span class="token operator">=</span> object <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">:</span> <span class="token class-name">ArrayUtil</span><span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span>object<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 更新count、checksum以及hashcode的值</span>
    count<span class="token operator">++</span><span class="token punctuation">;</span>
    checksum <span class="token operator">+=</span> baseHashCode<span class="token punctuation">;</span>
    baseHashCode <span class="token operator">*=</span> count<span class="token punctuation">;</span>

    hashcode <span class="token operator">=</span> multiplier <span class="token operator">*</span> hashcode <span class="token operator">+</span> baseHashCode<span class="token punctuation">;</span>
    <span class="token comment">// 将对象添加到updateList中</span>
    updateList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>object<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><ul><li>equals 方法：用于比较两个元素是否相等。首先比较 <code>hashcode</code>、<code>checksum</code>、<code>count</code> 是否相等，如果这三个值相等，会循环比较 <code>updateList</code> 中每个元素的 <code>hashCode</code> 是否一致；按照这种方式判断两个对象是否相等，一方面能很严格的判断是否一致避免出现误判，另外一方面能提高比较的效率；</li></ul> <div class="language-java line-numbers-mode"><pre class="language-java"><code>  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">equals</span><span class="token punctuation">(</span><span class="token class-name">Object</span> object<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 比较是不是同一个对象</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token operator">==</span> object<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 是否类型相同</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>object <span class="token keyword">instanceof</span> <span class="token class-name">CacheKey</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">final</span> <span class="token class-name">CacheKey</span> cacheKey <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">CacheKey</span><span class="token punctuation">)</span> object<span class="token punctuation">;</span>

    <span class="token comment">// hashcode 是否相同</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>hashcode <span class="token operator">!=</span> cacheKey<span class="token punctuation">.</span>hashcode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// checksum 是否相同</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>checksum <span class="token operator">!=</span> cacheKey<span class="token punctuation">.</span>checksum<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// count 是否相同</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">!=</span> cacheKey<span class="token punctuation">.</span>count<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 以上都相同，才按顺序比较 updateList 中元素的 hash 值是否一致</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> updateList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">Object</span> thisObject <span class="token operator">=</span> updateList<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">Object</span> thatObject <span class="token operator">=</span> cacheKey<span class="token punctuation">.</span>updateList<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">ArrayUtil</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>thisObject<span class="token punctuation">,</span> thatObject<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br></div></div><h3 id="_5、反射模块分析"><a href="#_5、反射模块分析" class="header-anchor">#</a> 5、反射模块分析</h3> <p>反射是 Mybatis 模块中类最多的模块，通过反射实现了 POJO 对象的实例化和 POJO 的属性赋值，相对 JDK 自带的反射功能，MyBatis 的反射模块功能更为强大，性能更高；反射模块关键的几个类如下：</p> <ul><li>ObjectFactory：<code>MyBatis</code> 每次创建结果对象的新实例时，它都会使用对象工厂（<code>ObjectFactory</code>）去构建 <code>POJO</code>；</li></ul> <p><code>ObjectFactory：</code> 接口中最终要的两个方法是：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>  <span class="token comment">/**
   * Creates a new object with default constructor.
   *
   * @param &lt;T&gt;
   *          the generic type
   * @param type
   *          Object type
   * @return the t
   */</span>
  <span class="token comment">// 通过无参构造函数创建指定类的对象</span>
  <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">T</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> type<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>默认是的实现是 <code>DefaultObjectFactory</code>：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">T</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">create</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">&quot;unchecked&quot;</span><span class="token punctuation">)</span>
  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">T</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> type<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Class</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> constructorArgTypes<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> constructorArgs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 判断类是不是集合类，如果是集合类指定具体的实现类</span>
    <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> classToCreate <span class="token operator">=</span> <span class="token function">resolveInterface</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// we know types are assignable</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">)</span> <span class="token function">instantiateClass</span><span class="token punctuation">(</span>classToCreate<span class="token punctuation">,</span> constructorArgTypes<span class="token punctuation">,</span> constructorArgs<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 根据传过来的类型，构造方法，和构造方法的参数实例化对象</span>
  <span class="token keyword">private</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">T</span> <span class="token function">instantiateClass</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> type<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Class</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> constructorArgTypes<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> constructorArgs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token class-name">Constructor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> constructor<span class="token punctuation">;</span>
      <span class="token comment">// 通过无参构造函数创建对象</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>constructorArgTypes <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> constructorArgs <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        constructor <span class="token operator">=</span> type<span class="token punctuation">.</span><span class="token function">getDeclaredConstructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> constructor<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IllegalAccessException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Reflector</span><span class="token punctuation">.</span><span class="token function">canControlMemberAccessible</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            constructor<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> constructor<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> e<span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 根据指定的参数列表查找构造函数，并实例化对象</span>
      constructor <span class="token operator">=</span> type<span class="token punctuation">.</span><span class="token function">getDeclaredConstructor</span><span class="token punctuation">(</span>constructorArgTypes<span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> constructor<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span>constructorArgs<span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IllegalAccessException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Reflector</span><span class="token punctuation">.</span><span class="token function">canControlMemberAccessible</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          constructor<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span> constructor<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span>constructorArgs<span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token keyword">throw</span> e<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">String</span> argTypes <span class="token operator">=</span> <span class="token class-name">Optional</span><span class="token punctuation">.</span><span class="token function">ofNullable</span><span class="token punctuation">(</span>constructorArgTypes<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">orElseGet</span><span class="token punctuation">(</span><span class="token class-name">Collections</span><span class="token operator">::</span><span class="token function">emptyList</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token operator">::</span><span class="token function">getSimpleName</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">joining</span><span class="token punctuation">(</span><span class="token string">&quot;,&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">String</span> argValues <span class="token operator">=</span> <span class="token class-name">Optional</span><span class="token punctuation">.</span><span class="token function">ofNullable</span><span class="token punctuation">(</span>constructorArgs<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">orElseGet</span><span class="token punctuation">(</span><span class="token class-name">Collections</span><span class="token operator">::</span><span class="token function">emptyList</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token operator">::</span><span class="token function">valueOf</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">joining</span><span class="token punctuation">(</span><span class="token string">&quot;,&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ReflectionException</span><span class="token punctuation">(</span><span class="token string">&quot;Error instantiating &quot;</span> <span class="token operator">+</span> type <span class="token operator">+</span> <span class="token string">&quot; with invalid types (&quot;</span> <span class="token operator">+</span> argTypes <span class="token operator">+</span> <span class="token string">&quot;) or values (&quot;</span> <span class="token operator">+</span> argValues <span class="token operator">+</span> <span class="token string">&quot;). Cause: &quot;</span> <span class="token operator">+</span> e<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br></div></div><p>通过暴力反射帮助我们生成实例对象。</p> <ul><li>ReflectorFactory：创建 <code>Reflector</code> 的工厂类，<code>Reflector</code> 是 <code>MyBatis</code> 反射模块的基础，每个 <code>Reflector</code> 对象都对应一个类，在其中缓存了反射操作所需要的类元信息；</li></ul> <p>元信息就是实体类的字段和成员方法。<code>Reflector</code> 的属性和构造方法：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>  <span class="token comment">// 对应的 class</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> type<span class="token punctuation">;</span>
  <span class="token comment">// 可读属性的名称集合，存在 get()方法即可读</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> writablePropertyNames<span class="token punctuation">;</span>
  <span class="token comment">// 可写属性的名称集合，存在 set() 方法即可写</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Invoker</span><span class="token punctuation">&gt;</span></span> setMethods <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 保存属性相关的 set() 方法</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Invoker</span><span class="token punctuation">&gt;</span></span> getMethods <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 保存属性相关的 get() 方法</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> readablePropertyNames<span class="token punctuation">;</span>
  <span class="token comment">// 保存属性相关的 set() 方法入参类型</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> setTypes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 保存属性相关的 get() 方法返回类型</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> getTypes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// class 默认的构造函数</span>
  <span class="token keyword">private</span> <span class="token class-name">Constructor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> defaultConstructor<span class="token punctuation">;</span>

  <span class="token comment">// 记录所有属性的名称集合</span>
  <span class="token keyword">private</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> caseInsensitivePropertyMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">public</span> <span class="token class-name">Reflector</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> clazz<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    type <span class="token operator">=</span> clazz<span class="token punctuation">;</span>
    <span class="token comment">// 获取 clazz 的默认构造函数</span>
    <span class="token function">addDefaultConstructor</span><span class="token punctuation">(</span>clazz<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 处理 clazz 中的 get() 方法信息，填充 getMethods、getTypes</span>
    <span class="token function">addGetMethods</span><span class="token punctuation">(</span>clazz<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 处理 clazz 中的 set() 方法信息，填充 setMethods、setTypes</span>
    <span class="token function">addSetMethods</span><span class="token punctuation">(</span>clazz<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 处理没有 get()、set() 方法的属性</span>
    <span class="token function">addFields</span><span class="token punctuation">(</span>clazz<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 根据 get()、set() 方法初始化可读属性集合和可写属性集合</span>
    readablePropertyNames <span class="token operator">=</span> getMethods<span class="token punctuation">.</span><span class="token function">keySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    writablePropertyNames <span class="token operator">=</span> setMethods<span class="token punctuation">.</span><span class="token function">keySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 初始化 caseInsensitivePropertyMap</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> propName <span class="token operator">:</span> readablePropertyNames<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      caseInsensitivePropertyMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>propName<span class="token punctuation">.</span><span class="token function">toUpperCase</span><span class="token punctuation">(</span><span class="token class-name">Locale</span><span class="token punctuation">.</span>ENGLISH<span class="token punctuation">)</span><span class="token punctuation">,</span> propName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> propName <span class="token operator">:</span> writablePropertyNames<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      caseInsensitivePropertyMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>propName<span class="token punctuation">.</span><span class="token function">toUpperCase</span><span class="token punctuation">(</span><span class="token class-name">Locale</span><span class="token punctuation">.</span>ENGLISH<span class="token punctuation">)</span><span class="token punctuation">,</span> propName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br></div></div><p><code>MyBatis</code> 强大之处在于，即使你定义的 <code>pojo</code> 类的成员没有 <code>get()</code> 和 <code>set()</code> 方法，它也会帮助你生成对应的 <code>get()</code> 和 <code>set()</code> 方法。</p> <p>在 <code>addFields()</code> 方法中：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>  <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">addFields</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> clazz<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Field</span><span class="token punctuation">[</span><span class="token punctuation">]</span> fields <span class="token operator">=</span> clazz<span class="token punctuation">.</span><span class="token function">getDeclaredFields</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Field</span> field <span class="token operator">:</span> fields<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>setMethods<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>field<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// issue #379 - removed the check for final because JDK 1.5 allows</span>
        <span class="token comment">// modification of final fields through reflection (JSR-133). (JGB)</span>
        <span class="token comment">// pr #16 - final static can only be set by the classloader</span>
        <span class="token keyword">int</span> modifiers <span class="token operator">=</span> field<span class="token punctuation">.</span><span class="token function">getModifiers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span><span class="token class-name">Modifier</span><span class="token punctuation">.</span><span class="token function">isFinal</span><span class="token punctuation">(</span>modifiers<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token class-name">Modifier</span><span class="token punctuation">.</span><span class="token function">isStatic</span><span class="token punctuation">(</span>modifiers<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// 这里给没有 set() 方法的属性，生成一个 set() 方法</span>
          <span class="token function">addSetField</span><span class="token punctuation">(</span>field<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>getMethods<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>field<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 这里给没有 get() 方法的属性，生成一个 get() 方法</span>
        <span class="token function">addGetField</span><span class="token punctuation">(</span>field<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>clazz<span class="token punctuation">.</span><span class="token function">getSuperclass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">addFields</span><span class="token punctuation">(</span>clazz<span class="token punctuation">.</span><span class="token function">getSuperclass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p>它会检测是属性如果没有 <code>get()</code> 和 <code>set()</code> 方法，就会帮助生成一个对应的方法。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>  <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">addSetField</span><span class="token punctuation">(</span><span class="token class-name">Field</span> field<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isValidPropertyName</span><span class="token punctuation">(</span>field<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      setMethods<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>field<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">SetFieldInvoker</span><span class="token punctuation">(</span>field<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">Type</span> fieldType <span class="token operator">=</span> <span class="token class-name">TypeParameterResolver</span><span class="token punctuation">.</span><span class="token function">resolveFieldType</span><span class="token punctuation">(</span>field<span class="token punctuation">,</span> type<span class="token punctuation">)</span><span class="token punctuation">;</span>
      setTypes<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>field<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">typeToClass</span><span class="token punctuation">(</span>fieldType<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">addGetField</span><span class="token punctuation">(</span><span class="token class-name">Field</span> field<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isValidPropertyName</span><span class="token punctuation">(</span>field<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      getMethods<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>field<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">GetFieldInvoker</span><span class="token punctuation">(</span>field<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">Type</span> fieldType <span class="token operator">=</span> <span class="token class-name">TypeParameterResolver</span><span class="token punctuation">.</span><span class="token function">resolveFieldType</span><span class="token punctuation">(</span>field<span class="token punctuation">,</span> type<span class="token punctuation">)</span><span class="token punctuation">;</span>
      getTypes<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>field<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">typeToClass</span><span class="token punctuation">(</span>fieldType<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>其中 <code>SetFieldInvoker</code> 和 <code>GetFieldInvoker</code> 类就是负责生成 <code>set()</code> 和 <code>get()</code> 方法的类。</p> <p><code>ReflectorFactory</code> 的默认实现类是 <code>DefaultReflectorFactory</code></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// reflect 的简单工厂类</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DefaultReflectorFactory</span> <span class="token keyword">implements</span> <span class="token class-name">ReflectorFactory</span> <span class="token punctuation">{</span>
  <span class="token keyword">private</span> <span class="token keyword">boolean</span> classCacheEnabled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token comment">// 用户缓存 pojo 的元数据，避免反射性能较低的问题</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ConcurrentMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Class</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">Reflector</span><span class="token punctuation">&gt;</span></span> reflectorMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">public</span> <span class="token class-name">DefaultReflectorFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token punctuation">}</span>

  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isClassCacheEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> classCacheEnabled<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setClassCacheEnabled</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> classCacheEnabled<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>classCacheEnabled <span class="token operator">=</span> classCacheEnabled<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token class-name">Reflector</span> <span class="token function">findForClass</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>classCacheEnabled<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// synchronized (type) removed see issue #461</span>
      <span class="token keyword">return</span> reflectorMap<span class="token punctuation">.</span><span class="token function">computeIfAbsent</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> <span class="token class-name">Reflector</span><span class="token operator">::</span><span class="token keyword">new</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Reflector</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><p><code>DefaultReflectorFactory</code> 会在启动的时候，将所有的 <code>pojo</code> 的元数据，缓存到 <code>ConcurrentHashMap</code> 中，解决了反射性能低的问题。</p> <p>演示通过 <code>Reflector</code> 获取元数据信息：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">reflectorTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 反射工具类初始化</span>
        <span class="token class-name">ObjectFactory</span> objectFactory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultObjectFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">TUser</span> user <span class="token operator">=</span> objectFactory<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token class-name">TUser</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ObjectWrapperFactory</span> objectWrapperFactory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultObjectWrapperFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ReflectorFactory</span> reflectorFactory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultReflectorFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">MetaObject</span> metaObject <span class="token operator">=</span> <span class="token class-name">MetaObject</span><span class="token punctuation">.</span><span class="token function">forObject</span><span class="token punctuation">(</span>user<span class="token punctuation">,</span> objectFactory<span class="token punctuation">,</span> objectWrapperFactory<span class="token punctuation">,</span> reflectorFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// 使用 Reflector 读取类元信息</span>
		<span class="token class-name">Reflector</span> findForClass <span class="token operator">=</span> reflectorFactory<span class="token punctuation">.</span><span class="token function">findForClass</span><span class="token punctuation">(</span><span class="token class-name">TUser</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">Constructor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> defaultConstructor <span class="token operator">=</span> findForClass<span class="token punctuation">.</span><span class="token function">getDefaultConstructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> getablePropertyNames <span class="token operator">=</span> findForClass<span class="token punctuation">.</span><span class="token function">getGetablePropertyNames</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> setablePropertyNames <span class="token operator">=</span> findForClass<span class="token punctuation">.</span><span class="token function">getSetablePropertyNames</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>defaultConstructor<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>getablePropertyNames<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>setablePropertyNames<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><ul><li><p>ObjectWrapper：对对象的包装，抽象了对象的属性信息，他定义了一系列查询对象属性信息的方法，以及更新属性的方法；</p></li> <li><p>ObjectWrapperFactory： <code>ObjectWrapper</code> 的工厂类，用于创建 <code>ObjectWrapper</code> ；</p></li></ul> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ObjectWrapper</span> <span class="token punctuation">{</span>

  <span class="token comment">// 获取对象指定属性的值</span>
  <span class="token class-name">Object</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">PropertyTokenizer</span> prop<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 设置对象指定属性的值</span>
  <span class="token keyword">void</span> <span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">PropertyTokenizer</span> prop<span class="token punctuation">,</span> <span class="token class-name">Object</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token class-name">String</span> <span class="token function">findProperty</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token keyword">boolean</span> useCamelCaseMapping<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">getGetterNames</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">getSetterNames</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> <span class="token function">getSetterType</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> <span class="token function">getGetterType</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">boolean</span> <span class="token function">hasSetter</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">boolean</span> <span class="token function">hasGetter</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token class-name">MetaObject</span> <span class="token function">instantiatePropertyValue</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token class-name">PropertyTokenizer</span> prop<span class="token punctuation">,</span> <span class="token class-name">ObjectFactory</span> objectFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 判断当前对象是否为集合</span>
  <span class="token keyword">boolean</span> <span class="token function">isCollection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 当前集合添加一个元素</span>
  <span class="token keyword">void</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">Object</span> element<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 当前集合添加另外一个集合</span>
  <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">void</span> <span class="token function">addAll</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> element<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br></div></div><p><code>ObjectWrapper</code> 的默认实现类是：<code>BeanWrapper</code>，<code>BeanWrapper</code> 封装了两个非常重要的数据：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>  <span class="token comment">// 实例对象</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Object</span> object<span class="token punctuation">;</span>
  <span class="token comment">// 类的元数据</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">MetaClass</span> metaClass<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p><code>BeanWrapper</code> 实现的 <code>set()</code> 方法，用户给字段赋值：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">PropertyTokenizer</span> prop<span class="token punctuation">,</span> <span class="token class-name">Object</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 判断是否是容器</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>prop<span class="token punctuation">.</span><span class="token function">getIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">Object</span> collection <span class="token operator">=</span> <span class="token function">resolveCollection</span><span class="token punctuation">(</span>prop<span class="token punctuation">,</span> object<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">setCollectionValue</span><span class="token punctuation">(</span>prop<span class="token punctuation">,</span> collection<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token function">setBeanProperty</span><span class="token punctuation">(</span>prop<span class="token punctuation">,</span> object<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>判断不为容器的时候，执行 <code>setBeanProperty()</code> 进行赋值：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>  <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">setBeanProperty</span><span class="token punctuation">(</span><span class="token class-name">PropertyTokenizer</span> prop<span class="token punctuation">,</span> <span class="token class-name">Object</span> object<span class="token punctuation">,</span> <span class="token class-name">Object</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token comment">// 获取元数据的 set() 方法</span>
      <span class="token class-name">Invoker</span> method <span class="token operator">=</span> metaClass<span class="token punctuation">.</span><span class="token function">getSetInvoker</span><span class="token punctuation">(</span>prop<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> params <span class="token operator">=</span> <span class="token punctuation">{</span>value<span class="token punctuation">}</span><span class="token punctuation">;</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// 将这个属性设置成 value</span>
        method<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> params<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token class-name">ExceptionUtil</span><span class="token punctuation">.</span><span class="token function">unwrapThrowable</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ReflectionException</span><span class="token punctuation">(</span><span class="token string">&quot;Could not set property '&quot;</span> <span class="token operator">+</span> prop<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;' of '&quot;</span> <span class="token operator">+</span> object<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;' with value '&quot;</span> <span class="token operator">+</span> value <span class="token operator">+</span> <span class="token string">&quot;' Cause: &quot;</span> <span class="token operator">+</span> t<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>演示通过 <code>ObjectWrapper</code> 给 <code>bean</code> 的属性赋值：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">objectWrapperTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 反射工具类初始化</span>
        <span class="token class-name">ObjectFactory</span> objectFactory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultObjectFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">TUser</span> user <span class="token operator">=</span> objectFactory<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token class-name">TUser</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ObjectWrapperFactory</span> objectWrapperFactory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultObjectWrapperFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ReflectorFactory</span> reflectorFactory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultReflectorFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">MetaObject</span> metaObject <span class="token operator">=</span> <span class="token class-name">MetaObject</span><span class="token punctuation">.</span><span class="token function">forObject</span><span class="token punctuation">(</span>user<span class="token punctuation">,</span> objectFactory<span class="token punctuation">,</span> objectWrapperFactory<span class="token punctuation">,</span> reflectorFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 使用ObjectWrapper读取对象信息，并对对象属性进行赋值操作</span>
		<span class="token class-name">TUser</span> userTemp <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">ObjectWrapper</span> wrapperForUser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BeanWrapper</span><span class="token punctuation">(</span>metaObject<span class="token punctuation">,</span> userTemp<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> getterNames <span class="token operator">=</span> wrapperForUser<span class="token punctuation">.</span><span class="token function">getGetterNames</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> setterNames <span class="token operator">=</span> wrapperForUser<span class="token punctuation">.</span><span class="token function">getSetterNames</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>getterNames<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>setterNames<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token class-name">PropertyTokenizer</span> prop <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PropertyTokenizer</span><span class="token punctuation">(</span><span class="token string">&quot;userName&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		wrapperForUser<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>prop<span class="token punctuation">,</span> <span class="token string">&quot;lison&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>userTemp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><ul><li>MetaObject：封装了对象元信息，包装了 <code>MyBatis</code> 中五个核心的反射类。也是提供给外部使用的反射工具类，可以利用它可以读取或者修改对象的属性信息；<code>MetaObject</code> 的类结构如下所示：</li></ul> <p><img src="https://yjtravel-public.oss-cn-beijing.aliyuncs.com/my-blog/basic/reflect_class.png" alt="反射核心类"></p> <p>模拟从数据库读取数据并转化成对象：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">metaObjectTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 反射工具类初始化</span>
        <span class="token class-name">ObjectFactory</span> objectFactory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultObjectFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">TUser</span> user <span class="token operator">=</span> objectFactory<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token class-name">TUser</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ObjectWrapperFactory</span> objectWrapperFactory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultObjectWrapperFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ReflectorFactory</span> reflectorFactory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultReflectorFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">MetaObject</span> metaObject <span class="token operator">=</span> <span class="token class-name">MetaObject</span><span class="token punctuation">.</span><span class="token function">forObject</span><span class="token punctuation">(</span>user<span class="token punctuation">,</span> objectFactory<span class="token punctuation">,</span> objectWrapperFactory<span class="token punctuation">,</span> reflectorFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 模拟数据库行数据转化成对象</span>
        <span class="token comment">// 1.模拟从数据库读取数据</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> dbResult <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        dbResult<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        dbResult<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;userName&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;lison&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        dbResult<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;realName&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;李晓宇&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">TPosition</span> tp <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TPosition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        tp<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        dbResult<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;position_id&quot;</span><span class="token punctuation">,</span> tp<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2.模拟映射关系</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> mapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mapper<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mapper<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;userName&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;userName&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mapper<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;realName&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;realName&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mapper<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;position&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;position_id&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 3.使用反射工具类将行数据转换成 pojo</span>
        <span class="token class-name">BeanWrapper</span> objectWrapper <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">BeanWrapper</span><span class="token punctuation">)</span> metaObject<span class="token punctuation">.</span><span class="token function">getObjectWrapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Map</span><span class="token punctuation">.</span><span class="token class-name">Entry</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> entrySet <span class="token operator">=</span> mapper<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 遍历映射关系</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token punctuation">.</span><span class="token class-name">Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> colInfo <span class="token operator">:</span> entrySet<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 获取 pojo 的字段名称</span>
            <span class="token class-name">String</span> propName <span class="token operator">=</span> colInfo<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 模拟从数据库中加载数据对应列的值</span>
            <span class="token class-name">Object</span> propValue <span class="token operator">=</span> dbResult<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>colInfo<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">PropertyTokenizer</span> proTokenizer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PropertyTokenizer</span><span class="token punctuation">(</span>propName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 将数据库的值赋值到 pojo 的字段中</span>
            objectWrapper<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>proTokenizer<span class="token punctuation">,</span> propValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>metaObject<span class="token punctuation">.</span><span class="token function">getOriginalObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br></div></div><div><br> <div id="vcomments"></div></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2020-08-21 09:02:51（10 小时前）</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/my-blog/backend/MyBatis应用.html" class="prev">
        MyBatis应用
      </a></span> <span class="next"><a href="/my-blog/backend/MyBatis源码流程分析.html">
        MyBatis源码流程分析
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/my-blog/assets/js/app.11c55fdf.js" defer></script><script src="/my-blog/assets/js/2.f643b0a2.js" defer></script><script src="/my-blog/assets/js/21.741a18a7.js" defer></script><script src="/my-blog/assets/js/4.fd36f240.js" defer></script><script src="/my-blog/assets/js/5.628d6842.js" defer></script>
  </body>
</html>
