<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>MySQL锁与事务的分析 | 林山夕风</title>
    <meta name="description" content="林山夕风的博客,md文档,技术博客">
    <meta name="generator" content="VuePress 1.3.0">
    <link rel="icon" href="/my-blog/avatar.jpg">
  <script>
                var _hmt = _hmt || [];
                (function() {
                    var hm = document.createElement("script");
                    hm.src = "https://hm.baidu.com/hm.js?68e7a949df184c1e4c82b115461e51e0";
                    var s = document.getElementsByTagName("script")[0];
                    s.parentNode.insertBefore(hm, s);
                })();
            </script>
    
    <link rel="preload" href="/my-blog/assets/css/0.styles.67b6080f.css" as="style"><link rel="preload" href="/my-blog/assets/js/app.11c55fdf.js" as="script"><link rel="preload" href="/my-blog/assets/js/2.f643b0a2.js" as="script"><link rel="preload" href="/my-blog/assets/js/28.aaa62b88.js" as="script"><link rel="preload" href="/my-blog/assets/js/4.fd36f240.js" as="script"><link rel="preload" href="/my-blog/assets/js/5.628d6842.js" as="script"><link rel="prefetch" href="/my-blog/assets/js/10.f4eaa613.js"><link rel="prefetch" href="/my-blog/assets/js/100.07e38629.js"><link rel="prefetch" href="/my-blog/assets/js/101.dcfe2bf2.js"><link rel="prefetch" href="/my-blog/assets/js/102.209999b3.js"><link rel="prefetch" href="/my-blog/assets/js/103.a9a85d34.js"><link rel="prefetch" href="/my-blog/assets/js/104.fdefe1dc.js"><link rel="prefetch" href="/my-blog/assets/js/105.e4b5d0af.js"><link rel="prefetch" href="/my-blog/assets/js/106.cf83f84b.js"><link rel="prefetch" href="/my-blog/assets/js/107.848b42d5.js"><link rel="prefetch" href="/my-blog/assets/js/108.351fb64c.js"><link rel="prefetch" href="/my-blog/assets/js/109.4b9111f6.js"><link rel="prefetch" href="/my-blog/assets/js/11.5d5723d1.js"><link rel="prefetch" href="/my-blog/assets/js/110.7f24fb6a.js"><link rel="prefetch" href="/my-blog/assets/js/111.28300395.js"><link rel="prefetch" href="/my-blog/assets/js/112.839af357.js"><link rel="prefetch" href="/my-blog/assets/js/113.67de001a.js"><link rel="prefetch" href="/my-blog/assets/js/114.408ea2f6.js"><link rel="prefetch" href="/my-blog/assets/js/115.34a1d81a.js"><link rel="prefetch" href="/my-blog/assets/js/116.f510ca2c.js"><link rel="prefetch" href="/my-blog/assets/js/117.24ddf316.js"><link rel="prefetch" href="/my-blog/assets/js/12.06fcb150.js"><link rel="prefetch" href="/my-blog/assets/js/13.c441de9d.js"><link rel="prefetch" href="/my-blog/assets/js/14.ca26e948.js"><link rel="prefetch" href="/my-blog/assets/js/15.e7761bd0.js"><link rel="prefetch" href="/my-blog/assets/js/16.5be4d33f.js"><link rel="prefetch" href="/my-blog/assets/js/17.4426a95c.js"><link rel="prefetch" href="/my-blog/assets/js/18.7d974f8d.js"><link rel="prefetch" href="/my-blog/assets/js/19.775995bc.js"><link rel="prefetch" href="/my-blog/assets/js/20.71c35e12.js"><link rel="prefetch" href="/my-blog/assets/js/21.741a18a7.js"><link rel="prefetch" href="/my-blog/assets/js/22.819a7e85.js"><link rel="prefetch" href="/my-blog/assets/js/23.f9133433.js"><link rel="prefetch" href="/my-blog/assets/js/24.86a7d541.js"><link rel="prefetch" href="/my-blog/assets/js/25.0aa2d6ab.js"><link rel="prefetch" href="/my-blog/assets/js/26.3e55392e.js"><link rel="prefetch" href="/my-blog/assets/js/27.ae2e0581.js"><link rel="prefetch" href="/my-blog/assets/js/29.55007ae9.js"><link rel="prefetch" href="/my-blog/assets/js/3.57915124.js"><link rel="prefetch" href="/my-blog/assets/js/30.63aac023.js"><link rel="prefetch" href="/my-blog/assets/js/31.d5607214.js"><link rel="prefetch" href="/my-blog/assets/js/32.a7ae912b.js"><link rel="prefetch" href="/my-blog/assets/js/33.58fcbfa4.js"><link rel="prefetch" href="/my-blog/assets/js/34.8538d781.js"><link rel="prefetch" href="/my-blog/assets/js/35.14a82428.js"><link rel="prefetch" href="/my-blog/assets/js/36.2ad806dd.js"><link rel="prefetch" href="/my-blog/assets/js/37.207a29ce.js"><link rel="prefetch" href="/my-blog/assets/js/38.57c0d12e.js"><link rel="prefetch" href="/my-blog/assets/js/39.83aff8a9.js"><link rel="prefetch" href="/my-blog/assets/js/40.bcbcfd03.js"><link rel="prefetch" href="/my-blog/assets/js/41.d0a94dfd.js"><link rel="prefetch" href="/my-blog/assets/js/42.f6011b50.js"><link rel="prefetch" href="/my-blog/assets/js/43.efd29b4c.js"><link rel="prefetch" href="/my-blog/assets/js/44.e5c9709c.js"><link rel="prefetch" href="/my-blog/assets/js/45.7656da3c.js"><link rel="prefetch" href="/my-blog/assets/js/46.0f46c833.js"><link rel="prefetch" href="/my-blog/assets/js/47.40ce4540.js"><link rel="prefetch" href="/my-blog/assets/js/48.3db9c583.js"><link rel="prefetch" href="/my-blog/assets/js/49.53285ac3.js"><link rel="prefetch" href="/my-blog/assets/js/50.4db56f99.js"><link rel="prefetch" href="/my-blog/assets/js/51.188f8c4f.js"><link rel="prefetch" href="/my-blog/assets/js/52.95be221e.js"><link rel="prefetch" href="/my-blog/assets/js/53.276e1791.js"><link rel="prefetch" href="/my-blog/assets/js/54.2fd73796.js"><link rel="prefetch" href="/my-blog/assets/js/55.c90a5bd8.js"><link rel="prefetch" href="/my-blog/assets/js/56.406f89df.js"><link rel="prefetch" href="/my-blog/assets/js/57.811f05ab.js"><link rel="prefetch" href="/my-blog/assets/js/58.e2896a54.js"><link rel="prefetch" href="/my-blog/assets/js/59.e5f3be54.js"><link rel="prefetch" href="/my-blog/assets/js/6.8ba90f8e.js"><link rel="prefetch" href="/my-blog/assets/js/60.e4b67c15.js"><link rel="prefetch" href="/my-blog/assets/js/61.7b772903.js"><link rel="prefetch" href="/my-blog/assets/js/62.bbe4352b.js"><link rel="prefetch" href="/my-blog/assets/js/63.e350ef3b.js"><link rel="prefetch" href="/my-blog/assets/js/64.7b6ca2f6.js"><link rel="prefetch" href="/my-blog/assets/js/65.76baf7fa.js"><link rel="prefetch" href="/my-blog/assets/js/66.ff801cea.js"><link rel="prefetch" href="/my-blog/assets/js/67.ee30cd5b.js"><link rel="prefetch" href="/my-blog/assets/js/68.0f4c1ce2.js"><link rel="prefetch" href="/my-blog/assets/js/69.111ce4de.js"><link rel="prefetch" href="/my-blog/assets/js/7.55078740.js"><link rel="prefetch" href="/my-blog/assets/js/70.46f8b5e8.js"><link rel="prefetch" href="/my-blog/assets/js/71.675e279c.js"><link rel="prefetch" href="/my-blog/assets/js/72.c419d947.js"><link rel="prefetch" href="/my-blog/assets/js/73.6eb4799a.js"><link rel="prefetch" href="/my-blog/assets/js/74.18229d2e.js"><link rel="prefetch" href="/my-blog/assets/js/75.46c8298d.js"><link rel="prefetch" href="/my-blog/assets/js/76.c966d3c5.js"><link rel="prefetch" href="/my-blog/assets/js/77.b31efc9c.js"><link rel="prefetch" href="/my-blog/assets/js/78.f7e57735.js"><link rel="prefetch" href="/my-blog/assets/js/79.e056b5a5.js"><link rel="prefetch" href="/my-blog/assets/js/8.ddecccf2.js"><link rel="prefetch" href="/my-blog/assets/js/80.0fc539d1.js"><link rel="prefetch" href="/my-blog/assets/js/81.2b7f0d10.js"><link rel="prefetch" href="/my-blog/assets/js/82.d3e4b716.js"><link rel="prefetch" href="/my-blog/assets/js/83.3073a1d2.js"><link rel="prefetch" href="/my-blog/assets/js/84.d231aeff.js"><link rel="prefetch" href="/my-blog/assets/js/85.7daed020.js"><link rel="prefetch" href="/my-blog/assets/js/86.0c8d8d8e.js"><link rel="prefetch" href="/my-blog/assets/js/87.c4ba5f03.js"><link rel="prefetch" href="/my-blog/assets/js/88.9a4e0ef6.js"><link rel="prefetch" href="/my-blog/assets/js/89.b7bca56b.js"><link rel="prefetch" href="/my-blog/assets/js/9.7463f385.js"><link rel="prefetch" href="/my-blog/assets/js/90.49ec4345.js"><link rel="prefetch" href="/my-blog/assets/js/91.84cb7a66.js"><link rel="prefetch" href="/my-blog/assets/js/92.cb5ea946.js"><link rel="prefetch" href="/my-blog/assets/js/93.05e2ac79.js"><link rel="prefetch" href="/my-blog/assets/js/94.e60969c0.js"><link rel="prefetch" href="/my-blog/assets/js/95.688af442.js"><link rel="prefetch" href="/my-blog/assets/js/96.aba3a873.js"><link rel="prefetch" href="/my-blog/assets/js/97.ca8196eb.js"><link rel="prefetch" href="/my-blog/assets/js/98.071b3a0f.js"><link rel="prefetch" href="/my-blog/assets/js/99.eca50447.js">
    <link rel="stylesheet" href="/my-blog/assets/css/0.styles.67b6080f.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/my-blog/" class="home-link router-link-active"><!----> <span class="site-name">林山夕风</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/my-blog/" class="nav-link">
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="基础教程" class="dropdown-title"><span class="title">基础教程</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/my-blog/frontend/" class="nav-link">
  前端
</a></li><li class="dropdown-item"><!----> <a href="/my-blog/backend/" class="nav-link router-link-active">
  后端
</a></li><li class="dropdown-item"><!----> <a href="/my-blog/enjoy3/" class="nav-link">
  进阶
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据结构与算法" class="dropdown-title"><span class="title">数据结构与算法</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/my-blog/structure/" class="nav-link">
  数据结构
</a></li><li class="dropdown-item"><!----> <a href="/my-blog/algorithm/" class="nav-link">
  算法
</a></li></ul></div></div><div class="nav-item"><a href="/my-blog/leetcode/" class="nav-link">
  LeetCode题解
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="设计思想" class="dropdown-title"><span class="title">设计思想</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/my-blog/principle/" class="nav-link">
  设计原则
</a></li><li class="dropdown-item"><!----> <a href="/my-blog/pattern/" class="nav-link">
  设计模式
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="读书笔记" class="dropdown-title"><span class="title">读书笔记</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/my-blog/thinking_in_java/" class="nav-link">
  Java编程思想
</a></li><li class="dropdown-item"><!----> <a href="/my-blog/refactoring_improving_the_design_of_existing_code/" class="nav-link">
  重构改善既有代码的设计
</a></li></ul></div></div><div class="nav-item"><a href="/my-blog/project/" class="nav-link">
  项目实战
</a></div><div class="nav-item"><a href="/my-blog/article/" class="nav-link">
  零散文章
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="代码管理" class="dropdown-title"><span class="title">代码管理</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://gitee.com/doomthr" target="_blank" rel="noopener noreferrer" class="nav-link external">
  码云
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://github.com/TanHaoran" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/my-blog/" class="nav-link">
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="基础教程" class="dropdown-title"><span class="title">基础教程</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/my-blog/frontend/" class="nav-link">
  前端
</a></li><li class="dropdown-item"><!----> <a href="/my-blog/backend/" class="nav-link router-link-active">
  后端
</a></li><li class="dropdown-item"><!----> <a href="/my-blog/enjoy3/" class="nav-link">
  进阶
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据结构与算法" class="dropdown-title"><span class="title">数据结构与算法</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/my-blog/structure/" class="nav-link">
  数据结构
</a></li><li class="dropdown-item"><!----> <a href="/my-blog/algorithm/" class="nav-link">
  算法
</a></li></ul></div></div><div class="nav-item"><a href="/my-blog/leetcode/" class="nav-link">
  LeetCode题解
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="设计思想" class="dropdown-title"><span class="title">设计思想</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/my-blog/principle/" class="nav-link">
  设计原则
</a></li><li class="dropdown-item"><!----> <a href="/my-blog/pattern/" class="nav-link">
  设计模式
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="读书笔记" class="dropdown-title"><span class="title">读书笔记</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/my-blog/thinking_in_java/" class="nav-link">
  Java编程思想
</a></li><li class="dropdown-item"><!----> <a href="/my-blog/refactoring_improving_the_design_of_existing_code/" class="nav-link">
  重构改善既有代码的设计
</a></li></ul></div></div><div class="nav-item"><a href="/my-blog/project/" class="nav-link">
  项目实战
</a></div><div class="nav-item"><a href="/my-blog/article/" class="nav-link">
  零散文章
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="代码管理" class="dropdown-title"><span class="title">代码管理</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://gitee.com/doomthr" target="_blank" rel="noopener noreferrer" class="nav-link external">
  码云
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://github.com/TanHaoran" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>基础教程</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/my-blog/backend/线程基础.html" class="sidebar-link">线程基础</a></li><li><a href="/my-blog/backend/线程之间的共享和协作.html" class="sidebar-link">线程之间的共享和协作</a></li><li><a href="/my-blog/backend/线程的并发工具类.html" class="sidebar-link">线程的并发工具类</a></li><li><a href="/my-blog/backend/原子操作CAS.html" class="sidebar-link">原子操作CAS</a></li><li><a href="/my-blog/backend/显示锁和AQS.html" class="sidebar-link">显示锁和AQS</a></li><li><a href="/my-blog/backend/并发容器.html" class="sidebar-link">并发容器</a></li><li><a href="/my-blog/backend/线程池.html" class="sidebar-link">线程池</a></li><li><a href="/my-blog/backend/并发安全.html" class="sidebar-link">并发安全</a></li><li><a href="/my-blog/backend/JMM和底层实现原理.html" class="sidebar-link">JMM和底层实现原理</a></li><li><a href="/my-blog/backend/Java8新增的并发.html" class="sidebar-link">Java8新增的并发</a></li><li><a href="/my-blog/backend/常见并发面试题.html" class="sidebar-link">常见并发面试题</a></li><li><a href="/my-blog/backend/深入理解JVM内存区域.html" class="sidebar-link">深入理解JVM内存区域</a></li><li><a href="/my-blog/backend/JVM如何创建对象.html" class="sidebar-link">JVM如何创建对象</a></li><li><a href="/my-blog/backend/垃圾回收算法与垃圾回收器.html" class="sidebar-link">垃圾回收算法与垃圾回收器</a></li><li><a href="/my-blog/backend/JVM执行子系统.html" class="sidebar-link">JVM执行子系统</a></li><li><a href="/my-blog/backend/JVM性能优化.html" class="sidebar-link">JVM性能优化</a></li><li><a href="/my-blog/backend/MySQL安装和基础数据类型.html" class="sidebar-link">MySQL安装和基础数据类型</a></li><li><a href="/my-blog/backend/MySQL体系架构.html" class="sidebar-link">MySQL体系架构</a></li><li><a href="/my-blog/backend/MySQL锁与事务的分析.html" class="active sidebar-link">MySQL锁与事务的分析</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/my-blog/backend/MySQL锁与事务的分析.html#一、锁的简介" class="sidebar-link">一、锁的简介</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/my-blog/backend/MySQL锁与事务的分析.html#_1、为什么需要锁" class="sidebar-link">1、为什么需要锁</a></li><li class="sidebar-sub-header"><a href="/my-blog/backend/MySQL锁与事务的分析.html#_2、锁的概念" class="sidebar-link">2、锁的概念</a></li><li class="sidebar-sub-header"><a href="/my-blog/backend/MySQL锁与事务的分析.html#_3、mysql-中的锁" class="sidebar-link">3、MySQL 中的锁</a></li><li class="sidebar-sub-header"><a href="/my-blog/backend/MySQL锁与事务的分析.html#_4、表锁与行锁的使用场景" class="sidebar-link">4、表锁与行锁的使用场景</a></li></ul></li><li class="sidebar-sub-header"><a href="/my-blog/backend/MySQL锁与事务的分析.html#二、myisam-锁" class="sidebar-link">二、MyISAM 锁</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/my-blog/backend/MySQL锁与事务的分析.html#_1、共享读锁" class="sidebar-link">1、共享读锁</a></li><li class="sidebar-sub-header"><a href="/my-blog/backend/MySQL锁与事务的分析.html#_2、独占写锁" class="sidebar-link">2、独占写锁</a></li><li class="sidebar-sub-header"><a href="/my-blog/backend/MySQL锁与事务的分析.html#_3、总结" class="sidebar-link">3、总结</a></li></ul></li><li class="sidebar-sub-header"><a href="/my-blog/backend/MySQL锁与事务的分析.html#三、innodb-锁" class="sidebar-link">三、InnoDB 锁</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/my-blog/backend/MySQL锁与事务的分析.html#_1、语法" class="sidebar-link">1、语法</a></li><li class="sidebar-sub-header"><a href="/my-blog/backend/MySQL锁与事务的分析.html#_2、注意" class="sidebar-link">2、注意</a></li></ul></li><li class="sidebar-sub-header"><a href="/my-blog/backend/MySQL锁与事务的分析.html#四、锁的等待问题" class="sidebar-link">四、锁的等待问题</a></li><li class="sidebar-sub-header"><a href="/my-blog/backend/MySQL锁与事务的分析.html#五、事务" class="sidebar-link">五、事务</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/my-blog/backend/MySQL锁与事务的分析.html#_1、为什么要事务" class="sidebar-link">1、为什么要事务</a></li><li class="sidebar-sub-header"><a href="/my-blog/backend/MySQL锁与事务的分析.html#_2、什么存储引擎支持事务" class="sidebar-link">2、什么存储引擎支持事务</a></li><li class="sidebar-sub-header"><a href="/my-blog/backend/MySQL锁与事务的分析.html#_3、事务特性" class="sidebar-link">3、事务特性</a></li></ul></li><li class="sidebar-sub-header"><a href="/my-blog/backend/MySQL锁与事务的分析.html#六、事务语法" class="sidebar-link">六、事务语法</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/my-blog/backend/MySQL锁与事务的分析.html#_1、开启事务" class="sidebar-link">1、开启事务</a></li><li class="sidebar-sub-header"><a href="/my-blog/backend/MySQL锁与事务的分析.html#_2、事务回滚" class="sidebar-link">2、事务回滚</a></li><li class="sidebar-sub-header"><a href="/my-blog/backend/MySQL锁与事务的分析.html#_3、事务提交" class="sidebar-link">3、事务提交</a></li><li class="sidebar-sub-header"><a href="/my-blog/backend/MySQL锁与事务的分析.html#_4、还原点" class="sidebar-link">4、还原点</a></li></ul></li></ul></li><li><a href="/my-blog/backend/MySQL业务设计.html" class="sidebar-link">MySQL业务设计</a></li><li><a href="/my-blog/backend/MySQL慢查询.html" class="sidebar-link">MySQL慢查询</a></li><li><a href="/my-blog/backend/MySQL索引和执行计划.html" class="sidebar-link">MySQL索引和执行计划</a></li><li><a href="/my-blog/backend/MySQL的SQL优化.html" class="sidebar-link">MySQL的SQL优化</a></li><li><a href="/my-blog/backend/Linux基础.html" class="sidebar-link">Linux基础</a></li><li><a href="/my-blog/backend/反射：框架设计的灵魂.html" class="sidebar-link">反射：框架设计的灵魂</a></li><li><a href="/my-blog/backend/Java8新增特性.html" class="sidebar-link">Java8新增特性</a></li><li><a href="/my-blog/backend/MyBatis应用.html" class="sidebar-link">MyBatis应用</a></li><li><a href="/my-blog/backend/MyBatis源码骨架分析.html" class="sidebar-link">MyBatis源码骨架分析</a></li><li><a href="/my-blog/backend/MyBatis源码流程分析.html" class="sidebar-link">MyBatis源码流程分析</a></li><li><a href="/my-blog/backend/消息中间件入门，AMQP与RabbitMQ.html" class="sidebar-link">消息中间件入门，AMQP与RabbitMQ</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="mysql锁与事务的分析"><a href="#mysql锁与事务的分析" class="header-anchor">#</a> MySQL锁与事务的分析</h1> <div><span id="/my-blog/backend/MySQL锁与事务的分析.html" data-flag-title="MySQL锁与事务的分析" class="leancloud_visitors read-count"><em class="post-meta-item-text">阅读量 </em> <i class="leancloud-visitors-count">loading</i></span> <div class="clear-both"></div></div> <h2 id="一、锁的简介"><a href="#一、锁的简介" class="header-anchor">#</a> 一、锁的简介</h2> <h3 id="_1、为什么需要锁"><a href="#_1、为什么需要锁" class="header-anchor">#</a> 1、为什么需要锁</h3> <p>到淘宝上买一件商品，商品只有一件库存，这个时候如果还有另一个人买，那么如何解决是你买到还是另一个人买到的问题？</p> <h3 id="_2、锁的概念"><a href="#_2、锁的概念" class="header-anchor">#</a> 2、锁的概念</h3> <ul><li>锁是计算机协调多个进程或线程并发访问某一资源的机制。</li> <li>在数据库中，数据也是一种供许多用户共享的资源。如何保证数据并发访问的一致性、有效性是所有数据库必须解决的一个问题，锁冲突也是影响数据库并发访问性能的一个重要因素。</li> <li>锁对数据库而言显得尤其重要，也更加复杂。</li></ul> <h3 id="_3、mysql-中的锁"><a href="#_3、mysql-中的锁" class="header-anchor">#</a> 3、MySQL 中的锁</h3> <p>MySQL的锁最显著的特点是不同的存储引擎支持不同的锁机制。例如：<code>MyISAM</code> 和 <code>MEMORY</code> 存储引擎采用的是表级锁，<code>InnoDB</code> 存储引擎既支持行级锁，也支持表级索，但默认情况下采用行级锁。</p> <ul><li>表级锁：开销小，加锁快；不会出现死锁；锁定粒度大，发生锁冲突的概率最高,并发度最低。</li> <li>行级锁：开销大，加锁慢；会出现死锁；锁定粒度最小，发生锁冲突的概率最低,并发度也最高。</li> <li>页面锁(gap 锁,间隙锁)：开销和加锁时间界于表锁和行锁之间；会出现死锁；锁定粒度界于表锁和行锁之间，并发度一般。</li></ul> <h3 id="_4、表锁与行锁的使用场景"><a href="#_4、表锁与行锁的使用场景" class="header-anchor">#</a> 4、表锁与行锁的使用场景</h3> <p>表级锁更适合于以查询为主，只有少量按索引条件更新数据的应用，如 <code>OLAP</code> 系统。</p> <p>行级锁则更适合于有大量按索引条件并发更新少量不同数据，同时又有并发查询的应用，如一些在线事务处理（<code>OLTP</code>）系统。</p> <p>很难笼统地说哪种锁更好，只能就具体应用的特点来说哪种锁更合适。</p> <h2 id="二、myisam-锁"><a href="#二、myisam-锁" class="header-anchor">#</a> 二、MyISAM 锁</h2> <p><code>MySQL</code> 的表级锁有两种模式：</p> <p>表共享读锁（<code>Table Read Lock</code>）</p> <p>表独占写锁（<code>Table Write Lock</code>）</p> <table><thead><tr><th>请求锁模式是否兼容当前锁模式</th> <th>None</th> <th>读锁</th> <th>写锁</th></tr></thead> <tbody><tr><td>读锁</td> <td>是</td> <td>是</td> <td>否</td></tr> <tr><td>写锁</td> <td>是</td> <td>否</td> <td>否</td></tr></tbody></table> <h3 id="_1、共享读锁"><a href="#_1、共享读锁" class="header-anchor">#</a> 1、共享读锁</h3> <p>语法：<code>LOCK TABLE 表名 READ</code></p> <p>给表中插入数据：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">INSERT</span> testmyisam <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">13</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>然后添加读锁：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">LOCK</span> <span class="token keyword">TABLE</span> testmyisam <span class="token keyword">READ</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>在当前会话中进行新增或、更新或者删除都会报错：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">INSERT</span> testmyisam <span class="token keyword">VALUES</span>	<span class="token punctuation">(</span> <span class="token number">2</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment"># 1099 - Table 'testmyisam' was locked with a READ lock and can't be updated</span>
<span class="token keyword">UPDATE</span> testmyisam <span class="token keyword">SET</span> id <span class="token operator">=</span> <span class="token number">2</span> <span class="token keyword">WHERE</span>	id <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment"># 1099 - Table 'testmyisam' was locked with a READ lock and can't be updated</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>即使对其它表进行查询、插入等操作也会报错：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> account<span class="token punctuation">;</span> <span class="token comment"># 1100 - Table 'account' was not locked with LOCK TABLES</span>

<span class="token keyword">INSERT</span> account <span class="token keyword">VALUE</span> <span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token string">'aaa'</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment"># 1100 - Table 'account' was not locked with LOCK TABLES</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>如果查询当前表，但是起了别名也会报错：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">SELECT</span> s<span class="token punctuation">.</span><span class="token operator">*</span> <span class="token keyword">FROM</span> testmyisam<span class="token punctuation">;</span> <span class="token number">1100</span> <span class="token operator">-</span> <span class="token keyword">Table</span> <span class="token string">'testmyisam'</span> was <span class="token operator">not</span> locked <span class="token keyword">with</span> <span class="token keyword">LOCK</span> <span class="token keyword">TABLES</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>但是如果新开一个会话，进行查询操作的时候是可以成功的，但是要进行插入、更新或删除操作：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">INSERT</span> testmyisam <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>会发现并没有报错，而是一直在等待执行。</p> <p>解锁的命令：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">UNLOCK</span> <span class="token keyword">TABLES</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="_2、独占写锁"><a href="#_2、独占写锁" class="header-anchor">#</a> 2、独占写锁</h3> <p>语法：<code>LOCK TABLE 表名 WRITE</code></p> <p>加写锁：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">LOCK</span> <span class="token keyword">TABLE</span> testmyisam <span class="token keyword">WRITE</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>在相同会话中是可以进行查询、新增、更新、删除操作的。</p> <p>如果查询其它表的话是会报错的：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> account<span class="token punctuation">;</span> <span class="token comment"># 1100 - Table 'account' was not locked with LOCK TABLES</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>如果对当前表起别名也是无法查询的：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">SELECT</span> s<span class="token punctuation">.</span><span class="token operator">*</span> <span class="token keyword">FROM</span> testmyisam s<span class="token punctuation">;</span> <span class="token comment"># 1100 - Table 's' was not locked with LOCK TABLES</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>如果在新会话中进行查询当前表的话，会一直等待：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> testmyisam<span class="token punctuation">;</span> <span class="token comment"># 不报错，一直等待</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="_3、总结"><a href="#_3、总结" class="header-anchor">#</a> 3、总结</h3> <ul><li>读锁，对 <code>MyISAM</code> 表的读操作，不会阻塞其他用户对同一表的读请求，但会阻塞对同一表的写请求</li> <li>读锁，对 <code>MyISAM</code> 表的读操作，不会阻塞当前 <code>session</code> 对表读，当对表进行修改会报错</li> <li>读锁，一个 <code>session</code> 使用 <code>LOCK TABLE</code> 命令给表 <code>f</code> 加了读锁，这个 <code>session</code> 可以查询锁定表中的记录，但更新或访问其他表都会提示错误；</li> <li>写锁，对 <code>MyISAM</code> 表的写操作，则会阻塞其他用户对同一表的读和写操作；</li> <li>写锁，对 <code>MyISAM</code> 表的写操作，当前 <code>session</code> 可以对本表做 <code>CRUD</code>,但对其他表进行操作会报错</li></ul> <h2 id="三、innodb-锁"><a href="#三、innodb-锁" class="header-anchor">#</a> 三、InnoDB 锁</h2> <p>在 <code>mysql</code> 的 <code>InnoDB</code> 引擎支持行锁。</p> <ul><li>共享锁又称：读锁。当一个事务对某几行上读锁时，允许其他事务对这几行进行读操作，但不允许其进行写操作，也不允许其他事务给这几行上排它锁，但允许上读锁。</li> <li>排它锁又称：写锁。当一个事务对某几个上写锁时，不允许其他事务写，但允许读。更不允许其他事务给这几行上任何锁。包括写锁。</li></ul> <h3 id="_1、语法"><a href="#_1、语法" class="header-anchor">#</a> 1、语法</h3> <p>上共享锁的写法：<code>lock in share mode</code>。例如： <code>select * from 表 where 条件 lock in share mode；</code></p> <p>上排它锁的写法：<code>for update</code>。例如：<code>select * from 表 where 条件 for update；</code></p> <h3 id="_2、注意"><a href="#_2、注意" class="header-anchor">#</a> 2、注意</h3> <ul><li>两个事务不能锁同一个索引。</li> <li><code>insert</code>、<code>delete</code>、<code>update</code> 在事务中都会自动默认加上排它锁。</li> <li>行锁必须有索引才能实现，否则会自动锁全表，那么就不是行锁了。</li></ul> <p>如何查看使用行锁时锁的是不是索引呢？利用执行计划 <code>EXPLAIN</code> 来看字段 <code>key</code> 是什么就可以，<code>key</code> 对应的是索引列，就是行锁，不是索引列，就锁全表。</p> <p>创建表并插入数据：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> testdemo <span class="token punctuation">(</span>
	<span class="token punctuation">`</span>id<span class="token punctuation">`</span> <span class="token keyword">INT</span> <span class="token punctuation">(</span> <span class="token number">255</span> <span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
	<span class="token punctuation">`</span>c1<span class="token punctuation">`</span> <span class="token keyword">VARCHAR</span> <span class="token punctuation">(</span> <span class="token number">300</span> <span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> 
	<span class="token keyword">SET</span> utf8 <span class="token keyword">COLLATE</span> utf8_general_ci <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
	<span class="token punctuation">`</span>c2<span class="token punctuation">`</span> <span class="token keyword">INT</span> <span class="token punctuation">(</span> <span class="token number">50</span> <span class="token punctuation">)</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
	<span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span> <span class="token punctuation">`</span>id<span class="token punctuation">`</span> <span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token keyword">INDEX</span> <span class="token punctuation">`</span>idx_c2<span class="token punctuation">`</span> <span class="token punctuation">(</span> <span class="token punctuation">`</span>c2<span class="token punctuation">`</span> <span class="token punctuation">)</span> <span class="token keyword">USING</span> <span class="token keyword">BTREE</span> 
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span> <span class="token operator">=</span> <span class="token keyword">INNODB</span><span class="token punctuation">;</span>

<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> testdemo <span class="token keyword">VALUES</span> <span class="token punctuation">(</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'1'</span><span class="token punctuation">,</span> <span class="token number">1</span> <span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span>	<span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">'2'</span><span class="token punctuation">,</span>	<span class="token number">2</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h4 id="_1-示例1"><a href="#_1-示例1" class="header-anchor">#</a> (1) 示例1</h4> <p>开启事务后，上写锁：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">BEGIN</span><span class="token punctuation">;</span>

<span class="token keyword">SELECT</span>
	<span class="token operator">*</span> 
<span class="token keyword">FROM</span>
	testdemo 
<span class="token keyword">WHERE</span>
	id <span class="token operator">=</span> <span class="token number">1</span> <span class="token keyword">FOR</span> <span class="token keyword">UPDATE</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>另开一个会话执行：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">UPDATE</span> testdemo <span class="token keyword">SET</span> c1 <span class="token operator">=</span> <span class="token string">'1'</span> <span class="token keyword">WHERE</span> id <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span> <span class="token comment"># 执行成功</span>
<span class="token keyword">UPDATE</span> testdemo <span class="token keyword">SET</span> c1 <span class="token operator">=</span> <span class="token string">'1'</span> <span class="token keyword">WHERE</span> id <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment"># 等待</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>给第一个事物回滚后，第二个事务等待的才可以执行成功：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">ROLLBACK</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h4 id="_2-示例2"><a href="#_2-示例2" class="header-anchor">#</a> (2) 示例2</h4> <p>重新开启一个事物，并进行更新操作：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">BEGIN</span><span class="token punctuation">;</span>
<span class="token keyword">UPDATE</span> testdemo <span class="token keyword">SET</span> c1 <span class="token operator">=</span> <span class="token string">'1'</span> <span class="token keyword">WHERE</span> id <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>再另一个会话中对同一行进行更新操作也会等待：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">UPDATE</span> testdemo <span class="token keyword">SET</span> c1 <span class="token operator">=</span> <span class="token string">'1'</span> <span class="token keyword">WHERE</span> id <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>回滚回去。</p> <p>这个例子说明了在进行 <code>update</code> 操作的时候，会默认加上排它锁。</p> <h4 id="_3-示例3"><a href="#_3-示例3" class="header-anchor">#</a> (3) 示例3</h4> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">BEGIN</span><span class="token punctuation">;</span>
<span class="token keyword">UPDATE</span> testdemo <span class="token keyword">SET</span> c1 <span class="token operator">=</span> <span class="token string">'1'</span> <span class="token keyword">WHERE</span> c1 <span class="token operator">=</span> <span class="token string">'1'</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>在另一个事物中执行：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">UPDATE</span> testdemo <span class="token keyword">SET</span> c1 <span class="token operator">=</span> <span class="token string">'2'</span> <span class="token keyword">WHERE</span> c1 <span class="token operator">=</span> <span class="token string">'2'</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>会发在等待。因为在建表的时候 <code>c1</code> 并没有索引，而第一个会话锁的是 <code>c1</code>，从而这说明了行锁必须有索引才能实现，否则会自动锁全表，那么就不是行锁了。</p> <p>回滚回去。</p> <p>在锁住行锁之后，使用 <code>ROLLBACK</code> 或者 <code>COMMIT</code> 都可以解锁。</p> <h2 id="四、锁的等待问题"><a href="#四、锁的等待问题" class="header-anchor">#</a> 四、锁的等待问题</h2> <p>假如有一个同事在 <code>debug</code> 程序，正在对数据库进行更新：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">BEGIN</span><span class="token punctuation">;</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> testdemo <span class="token keyword">WHERE</span> id <span class="token operator">=</span> <span class="token number">1</span> <span class="token keyword">FOR</span> <span class="token keyword">UPDATE</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>此时，我们需要进行一个共享锁：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">BEGIN</span><span class="token punctuation">;</span>

<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> testdemo <span class="token keyword">WHERE</span> id <span class="token operator">=</span><span class="token number">1</span> <span class="token keyword">LOCK</span> <span class="token operator">IN</span> <span class="token keyword">SHARE</span> <span class="token keyword">MODE</span> 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>去发现等待了，此时只能让前面那个同事进行提交或者回滚的操作才可以让我们的共享锁进行下去，而 <code>UNLOCK TABLES</code> 并不能解锁。</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">COMMIT</span><span class="token punctuation">;</span> <span class="token comment"># 或者 ROLLBACK 或者 BEGIN</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>其实还有一种比较简单的方法，当发现死锁的时候，使用下面这个语句可以查询目前锁的内容：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> information_schema<span class="token punctuation">.</span>INNODB_LOCKS<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>然后再用下面这个语句查看锁的队列id：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> sys<span class="token punctuation">.</span>innodb_lock_waits<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>其中 <code>waiting_queue</code> 字段显示的就是当前正在等待的 <code>sql</code> 语句，接下来找到 <code>sql_kill_blocking_connection</code> 字段的值，直接运行：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">KILL</span> xxx<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>就可以解锁了。</p> <h2 id="五、事务"><a href="#五、事务" class="header-anchor">#</a> 五、事务</h2> <h3 id="_1、为什么要事务"><a href="#_1、为什么要事务" class="header-anchor">#</a> 1、为什么要事务</h3> <p>现在的很多软件都是多用户，多程序，多线程的，对同一个表可能同时有很多人在用，为保持数据的一致性，所以提出了事务的概念。</p> <p>A 给 B 要划钱，A 的账户 -1000 元， B 的账户就要 +1000 元，这两个 <code>update</code> 语句必须作为一个整体来执行，不然 A 扣钱了，B 没有加钱这种情况很难处理。</p> <h3 id="_2、什么存储引擎支持事务"><a href="#_2、什么存储引擎支持事务" class="header-anchor">#</a> 2、什么存储引擎支持事务</h3> <p>只有 <code>InnoDB</code> 的引擎支持事务。</p> <ul><li>查看数据库下面是否支持事务（<code>InnoDB</code> 支持）？</li></ul> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">show</span> engines<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ul><li>查看 <code>mysql</code> 当前默认的存储引擎？</li></ul> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">show</span> variables <span class="token operator">like</span> <span class="token string">'%storage_engine%'</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ul><li>查看某张表的存储引擎？</li></ul> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">show</span> <span class="token keyword">create</span> <span class="token keyword">table</span> 表名<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ul><li>对于表的存储结构的修改？</li></ul> <p>建立 <code>InnoDB</code> 表：<code>CREATE TABLE xxx type = InnoDB；</code>。或者修改引擎： <code>Alter table xxx type = InnoDB;</code></p> <h3 id="_3、事务特性"><a href="#_3、事务特性" class="header-anchor">#</a> 3、事务特性</h3> <p>事务应该具有 4 个属性：原子性、一致性、隔离性、持久性。这四个属性通常称为 <code>ACID</code> 特性。</p> <h4 id="_1-原子性（atomicity）"><a href="#_1-原子性（atomicity）" class="header-anchor">#</a> (1) 原子性（atomicity）</h4> <p>一个事务必须被视为一个不可分割的最小单元，整个事务中的所有操作要么全部提交成功，要么全部失败，对于一个事务来说，不可能只执行其中的一部分操作。</p> <p>例如：</p> <p>老婆大人给 Deer 老师发生活费</p> <ol><li>老婆大人工资卡扣除 500 元</li> <li>Deer 老师工资卡增加 500</li></ol> <p>整个事务要么全部成功，要么全部失败。</p> <h4 id="_2-一致性（consistency）"><a href="#_2-一致性（consistency）" class="header-anchor">#</a> (2) 一致性（consistency）</h4> <p>一致性是指事务将数据库从一种一致性转换到另外一种一致性状态，在事务开始之前和事务结束之后数据库中数据的完整性没有被破坏。</p> <p>例如：</p> <p>老婆大人给 Deer 老师发生活费</p> <ol><li>老婆大人工资卡扣除 500 元</li> <li>Deer 老师工资卡增加 500</li> <li>Deer 老师工资卡增加 1000</li></ol> <p>扣除的钱（-500） 与增加的钱（500） 相加应该为 0</p> <h4 id="_3-持久性（durability）"><a href="#_3-持久性（durability）" class="header-anchor">#</a> (3) 持久性（durability）</h4> <p>一旦事务提交，则其所做的修改就会永久保存到数据库中。此时即使系统崩溃，已经提交的修改数据也不会丢失。但这并不是数据库的角度完全能解决的。</p> <h4 id="_4-隔离性（isolation）"><a href="#_4-隔离性（isolation）" class="header-anchor">#</a> (4) 隔离性（isolation）</h4> <p>一个事务的执行不能被其他事务干扰。即一个事务内部的操作及使用的数据对并发的其他事务是隔离的，并发执行的各个事务之间不能互相干扰。（对数据库的并行执行，应该像串行执行一样）</p> <ul><li>未提交读（READ UNCOMMITED）脏读</li> <li>已提交读（READ COMMITED）不可重复读</li> <li>可重复读（REPEATABLE READ）</li> <li>可串行化（SERIALIZABLE）</li></ul> <p><code>mysql</code> 默认的事务隔离级别为 <code>repeatable-read</code></p> <p>使用这个语句可以查询：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">SHOW</span> VARIABLES <span class="token operator">LIKE</span> <span class="token string">'%tx_isolation%'</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>事务并发问题：</p> <ul><li>脏读</li></ul> <p>事务 A 读取了事务 B 更新的数据，然后 B 回滚操作，那么 A 读取到的数据是脏数据</p> <ul><li>不可重复读</li></ul> <p>事务 A 多次读取同一数据，事务 B 在事务 A 多次读取的过程中，对数据作了更新并提交，导致事务 A 多次读取同一数据时，结果不一致。</p> <ul><li>幻读</li></ul> <p>系统管理员 A 将数据库中所有学生的成绩从具体分数改为 ABCDE 等级，但是系统管理员 B 就在这个时候插入了一条具体分数的记录，当系统管理员 A 改结束后发现还有一条记录没有改过来，就好像发生了幻觉一样，这就叫幻读。</p> <p>下面举例说明。</p> <h5 id="未提交读（read-uncommited）"><a href="#未提交读（read-uncommited）" class="header-anchor">#</a> 未提交读（READ UNCOMMITED）</h5> <p>首先来看脏读。</p> <p>新建两个会话，都修改当前会话默认隔离级别为： <code>READ UNCOMMITTED</code>：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">SET</span> <span class="token keyword">SESSION</span> <span class="token keyword">TRANSACTION</span> <span class="token keyword">ISOLATION</span> <span class="token keyword">LEVEL</span> <span class="token keyword">READ</span> <span class="token keyword">UNCOMMITTED</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>两个会话都开启事务：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">BEGIN</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><code>account</code> 表此时的数据是这样子的：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code>id  name    balance
<span class="token number">1</span>	lilei	<span class="token number">900</span>
<span class="token number">2</span>	hanmei	<span class="token number">100</span>
<span class="token number">3</span>	lucy	<span class="token number">250</span>
<span class="token number">5</span>	tom	    <span class="token number">0</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>第一个会话修改记录：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">UPDATE</span> account <span class="token keyword">set</span> balance <span class="token operator">=</span> balance <span class="token operator">-</span> <span class="token number">50</span> <span class="token keyword">WHERE</span> id <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>此时，这条记录的值变为了 850，第一个会话还未提交，第二个会话中读取：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> account <span class="token keyword">WHERE</span> id <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>居然也读到了 850的值，但是实际上第一个会话还没有提交。这就是脏读。</p> <h5 id="已提交读（read-committed）"><a href="#已提交读（read-committed）" class="header-anchor">#</a> 已提交读（READ COMMITTED）</h5> <p>接下来看不可重复读。</p> <p>新建两个会话，都设置隔离级别为 <code>READ COMMITTED</code>：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">SET</span> <span class="token keyword">SESSION</span> <span class="token keyword">TRANSACTION</span> <span class="token keyword">ISOLATION</span> <span class="token keyword">LEVEL</span> <span class="token keyword">READ</span> <span class="token keyword">COMMITTED</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><code>account</code> 表此时的数据是这样子的：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code>id  name    balance
<span class="token number">1</span>	lilei	<span class="token number">900</span>
<span class="token number">2</span>	hanmei	<span class="token number">100</span>
<span class="token number">3</span>	lucy	<span class="token number">250</span>
<span class="token number">5</span>	tom	    <span class="token number">0</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>在第一个会话中修改记录：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">UPDATE</span> account <span class="token keyword">set</span> balance <span class="token operator">=</span> balance <span class="token operator">-</span> <span class="token number">50</span> <span class="token keyword">WHERE</span> id <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>此时，这条记录的值变为了 850。第一个会话还未提交时在第二个会话中读取该条记录的值仍是 900，这解决了脏读的问题。</p> <p>此时，第一个会话进行提交 <code>COMMIT</code>，然后第二个会话查询，值变为了 850，说明第二个会话两次读取的值不一样，这就是不可重复读。</p> <h5 id="可重复读（repeatable-read）"><a href="#可重复读（repeatable-read）" class="header-anchor">#</a> 可重复读（REPEATABLE READ）</h5> <p>再看可重复读：</p> <p>新建两个会话，使用默认的隔离级别 <code>REPEATABLE READ</code>，都开启事务。</p> <p><code>account</code> 表此时的数据是这样子的：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code>id  name    balance
<span class="token number">1</span>	lilei	<span class="token number">900</span>
<span class="token number">2</span>	hanmei	<span class="token number">100</span>
<span class="token number">3</span>	lucy	<span class="token number">250</span>
<span class="token number">5</span>	tom	    <span class="token number">0</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>在第一个会话中修改记录：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">UPDATE</span> account <span class="token keyword">set</span> balance <span class="token operator">=</span> balance <span class="token operator">-</span> <span class="token number">50</span> <span class="token keyword">WHERE</span> id <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>然后第一个会话提交记录。此时这条记录改为 850并提交了。此时到第二个会话中查询值仍然是900，也就是说第一个会话提交的数据，第二个会话并没有读取到。这就叫做可重复读。第二个会话提交后在读取，才能读取到850的值。</p> <h5 id="可串行化（serializable）"><a href="#可串行化（serializable）" class="header-anchor">#</a> 可串行化（SERIALIZABLE）</h5> <p>接着看看可串行化。</p> <p>幻读代表当前会话已经读取到了一定的数据量，由于另一回话进行了新增或删除导致当前会话再次读取的时候数据量不同。</p> <p>新建两个会话，都修改当前会话默认隔离级别为： <code>SERIALIZABLE</code>：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">SET</span> <span class="token keyword">SESSION</span> <span class="token keyword">TRANSACTION</span> <span class="token keyword">ISOLATION</span> <span class="token keyword">LEVEL</span> <span class="token keyword">SERIALIZABLE</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>两个会话都开启事务：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">BEGIN</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><code>account</code> 表此时的数据是这样子的：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code>id  name    balance
<span class="token number">1</span>	lilei	<span class="token number">900</span>
<span class="token number">2</span>	hanmei	<span class="token number">100</span>
<span class="token number">3</span>	lucy	<span class="token number">250</span>
<span class="token number">5</span>	tom	    <span class="token number">0</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>第一个进行新增操作：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">INSERT</span> account <span class="token keyword">VALUE</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token string">'jerrr'</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>发现被卡主了。</p> <p>只有当第二个会话进行 <code>COMMIT</code> 后，第一个会话的新增操作才可以进行下去。</p> <p>这说明可序列化解决了幻读的问题，它采用了锁表的机制。</p> <p>总结：</p> <table><thead><tr><th>事务隔离级别</th> <th>脏读</th> <th>不可重复读</th> <th>幻读</th></tr></thead> <tbody><tr><td>未提交读（READ UNCOMMITED）</td> <td>是</td> <td>是</td> <td>是</td></tr> <tr><td>已提交读（READ COMMITED）</td> <td>否</td> <td>是</td> <td>是</td></tr> <tr><td>可重复读（REPEATABLE READ）</td> <td>否</td> <td>否</td> <td>是 / MySQL否</td></tr> <tr><td>可串行化（SERIALIZABLE）</td> <td>否</td> <td>否</td> <td>否</td></tr></tbody></table> <h5 id="间隙所（gap锁）"><a href="#间隙所（gap锁）" class="header-anchor">#</a> 间隙所（gap锁）</h5> <h6 id="测试1"><a href="#测试1" class="header-anchor">#</a> 测试1</h6> <p>创建表并插入数据：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> t_lock_1 <span class="token punctuation">(</span> a <span class="token keyword">INT</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> t_lock_1 <span class="token keyword">VALUES</span>	<span class="token punctuation">(</span> <span class="token number">10</span> <span class="token punctuation">)</span><span class="token punctuation">,</span>	<span class="token punctuation">(</span> <span class="token number">11</span> <span class="token punctuation">)</span><span class="token punctuation">,</span>	<span class="token punctuation">(</span> <span class="token number">13</span> <span class="token punctuation">)</span><span class="token punctuation">,</span>	<span class="token punctuation">(</span> <span class="token number">20</span> <span class="token punctuation">)</span><span class="token punctuation">,</span>	<span class="token punctuation">(</span> <span class="token number">40</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>开启事务并上锁：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">BEGIN</span><span class="token punctuation">;</span>

<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> t_lock_1 <span class="token keyword">WHERE</span> a <span class="token operator">&lt;=</span> <span class="token number">13</span> <span class="token keyword">FOR</span> <span class="token keyword">UPDATE</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>在另一个会话中进行开启事务并插入：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">BEGIN</span><span class="token punctuation">;</span>

<span class="token keyword">INSERT</span> t_lock_1 <span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>发现被锁住了。因为插入值 0 是小于等于 13的。</p> <p>仍然在另一个会话中先插入一条 21 的记录：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">INSERT</span> t_lock_1 <span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token number">21</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>发现可以插入成功，接着插入一条 19 的记录：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">INSERT</span> t_lock_1 <span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token number">19</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>发现被锁住了。这是为什么呢？</p> <p>原来再第一个会话中在对主键 <code>a</code> 上锁的时候，表中的数据是 10、11、13、20、40，它会从小到大开始，先从 10 开始上锁，然后发现满足条件，再对 11 上锁，也满足条件，然后是 13 上锁，也满足条件，然后对 20 上锁，发现不满足条件，后面的40就不上锁了，所以在第二个会话中 插入 21 的时候因为没有上锁，所以可以插入，但是 19 却不行了。</p> <h6 id="测试2"><a href="#测试2" class="header-anchor">#</a> 测试2</h6> <p>创建表并插入数据：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> t_lock_2 <span class="token punctuation">(</span>	a <span class="token keyword">INT</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span><span class="token punctuation">,</span>	b <span class="token keyword">INT</span><span class="token punctuation">,</span><span class="token keyword">KEY</span> <span class="token punctuation">(</span> b <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> t_lock_2 <span class="token keyword">VALUES</span>	<span class="token punctuation">(</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span> <span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">3</span><span class="token punctuation">,</span>	<span class="token number">1</span> <span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span>	<span class="token number">3</span> <span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span>	<span class="token number">6</span> <span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>表字段 <code>a</code> 是主键，字段 <code>b</code> 有一个索引。</p> <p>此时的表数据是这样子的：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code>a   b
<span class="token number">1</span>  	<span class="token number">1</span>
<span class="token number">3</span>  	<span class="token number">1</span>
<span class="token number">5</span>	<span class="token number">3</span>
<span class="token number">8</span>	<span class="token number">6</span>
<span class="token number">10</span>	<span class="token number">8</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>开启一个会话，并加锁：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">BEGIN</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> t_lock_2 <span class="token keyword">WHERE</span> b<span class="token operator">=</span><span class="token number">3</span> <span class="token keyword">FOR</span> <span class="token keyword">UPDATE</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><div class="language-sql line-numbers-mode"><pre class="language-sql"><code>a   b
<span class="token number">1</span>  	<span class="token number">1</span>
<span class="token number">3</span>  	<span class="token number">1</span>
<span class="token number">5</span>	<span class="token number">3</span>  <span class="token comment"># 加锁的是这条数据</span>
<span class="token number">8</span>	<span class="token number">6</span>
<span class="token number">10</span>	<span class="token number">8</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>另开一个会话：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">BEGIN</span><span class="token punctuation">;</span>

 <span class="token comment"># 因为数据(5, 3)被锁，不能加锁</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> t_lock_2 <span class="token keyword">WHERE</span> a <span class="token operator">=</span> <span class="token number">5</span> <span class="token keyword">LOCK</span> <span class="token operator">IN</span> <span class="token keyword">SHARE</span> <span class="token keyword">MODE</span><span class="token punctuation">;</span>

<span class="token comment"># 被锁，已经锁的字段 b 是 3 ，但是 2 在 1 和 3 之间的也被锁了 </span>
<span class="token keyword">INSERT</span> t_lock_2 <span class="token keyword">VALUE</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 

<span class="token comment"># 被锁，已经锁的字段 b 是 3 ，但是 5 在 3 和 6 之间的也被锁了 </span>
<span class="token keyword">INSERT</span> t_lock_2 <span class="token keyword">VALUE</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 

<span class="token comment"># 可以插入成功</span>
<span class="token keyword">INSERT</span> t_lock_2 <span class="token keyword">VALUE</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment"># 可以插入成功</span>
<span class="token keyword">INSERT</span> t_lock_2 <span class="token keyword">VALUE</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment"># 可以</span>
<span class="token keyword">INSERT</span> t_lock_2 <span class="token keyword">VALUE</span><span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment"># 可以</span>
<span class="token keyword">INSERT</span> t_lock_2 <span class="token keyword">VALUE</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><h2 id="六、事务语法"><a href="#六、事务语法" class="header-anchor">#</a> 六、事务语法</h2> <h3 id="_1、开启事务"><a href="#_1、开启事务" class="header-anchor">#</a> 1、开启事务</h3> <ul><li>begin</li> <li>START TRANSACTION（推荐）</li> <li>begin work</li></ul> <h3 id="_2、事务回滚"><a href="#_2、事务回滚" class="header-anchor">#</a> 2、事务回滚</h3> <p>rollback</p> <h3 id="_3、事务提交"><a href="#_3、事务提交" class="header-anchor">#</a> 3、事务提交</h3> <p>commit</p> <h3 id="_4、还原点"><a href="#_4、还原点" class="header-anchor">#</a> 4、还原点</h3> <p>savepoint</p> <p>首先看系统中自动提交是开启的：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">show</span> variables <span class="token operator">like</span> <span class="token string">'%autocommit%'</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>设置自动提交为0：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">set</span> autocommit<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>开启事务</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">insert</span> <span class="token keyword">into</span> testdemo <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">savepoint</span> s1<span class="token punctuation">;</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> testdemo <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">savepoint</span> s2<span class="token punctuation">;</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> testdemo <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">savepoint</span> s3<span class="token punctuation">;</span>
<span class="token keyword">rollback</span> <span class="token keyword">to</span> <span class="token keyword">savepoint</span> s2
<span class="token keyword">rollback</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>插入第一条数据(5,5,5)后保存存储点1，插第二条数据(6,6,6)后保存存储点2，插入第三条数据(7,7,7)后保存存储点3，然后还原到存储点二，也就是没有了数据(7,7,7)，最后全部回滚。</p> <div><br> <div id="vcomments"></div></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2020-08-21 09:02:51（10 小时前）</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/my-blog/backend/MySQL体系架构.html" class="prev">
        MySQL体系架构
      </a></span> <span class="next"><a href="/my-blog/backend/MySQL业务设计.html">
        MySQL业务设计
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/my-blog/assets/js/app.11c55fdf.js" defer></script><script src="/my-blog/assets/js/2.f643b0a2.js" defer></script><script src="/my-blog/assets/js/28.aaa62b88.js" defer></script><script src="/my-blog/assets/js/4.fd36f240.js" defer></script><script src="/my-blog/assets/js/5.628d6842.js" defer></script>
  </body>
</html>
