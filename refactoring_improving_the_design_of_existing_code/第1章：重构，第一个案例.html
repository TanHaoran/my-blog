<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>第1章：重构，第一个案例 | 林山夕风</title>
    <meta name="description" content="林山夕风的博客,md文档,技术博客">
    <meta name="generator" content="VuePress 1.3.0">
    <link rel="icon" href="/my-blog/avatar.jpg">
  <script>
                var _hmt = _hmt || [];
                (function() {
                    var hm = document.createElement("script");
                    hm.src = "https://hm.baidu.com/hm.js?68e7a949df184c1e4c82b115461e51e0";
                    var s = document.getElementsByTagName("script")[0];
                    s.parentNode.insertBefore(hm, s);
                })();
            </script>
    
    <link rel="preload" href="/my-blog/assets/css/0.styles.67b6080f.css" as="style"><link rel="preload" href="/my-blog/assets/js/app.11c55fdf.js" as="script"><link rel="preload" href="/my-blog/assets/js/2.f643b0a2.js" as="script"><link rel="preload" href="/my-blog/assets/js/98.071b3a0f.js" as="script"><link rel="preload" href="/my-blog/assets/js/4.fd36f240.js" as="script"><link rel="preload" href="/my-blog/assets/js/5.628d6842.js" as="script"><link rel="prefetch" href="/my-blog/assets/js/10.f4eaa613.js"><link rel="prefetch" href="/my-blog/assets/js/100.07e38629.js"><link rel="prefetch" href="/my-blog/assets/js/101.dcfe2bf2.js"><link rel="prefetch" href="/my-blog/assets/js/102.209999b3.js"><link rel="prefetch" href="/my-blog/assets/js/103.a9a85d34.js"><link rel="prefetch" href="/my-blog/assets/js/104.fdefe1dc.js"><link rel="prefetch" href="/my-blog/assets/js/105.e4b5d0af.js"><link rel="prefetch" href="/my-blog/assets/js/106.cf83f84b.js"><link rel="prefetch" href="/my-blog/assets/js/107.848b42d5.js"><link rel="prefetch" href="/my-blog/assets/js/108.351fb64c.js"><link rel="prefetch" href="/my-blog/assets/js/109.4b9111f6.js"><link rel="prefetch" href="/my-blog/assets/js/11.5d5723d1.js"><link rel="prefetch" href="/my-blog/assets/js/110.7f24fb6a.js"><link rel="prefetch" href="/my-blog/assets/js/111.28300395.js"><link rel="prefetch" href="/my-blog/assets/js/112.839af357.js"><link rel="prefetch" href="/my-blog/assets/js/113.67de001a.js"><link rel="prefetch" href="/my-blog/assets/js/114.408ea2f6.js"><link rel="prefetch" href="/my-blog/assets/js/115.34a1d81a.js"><link rel="prefetch" href="/my-blog/assets/js/116.f510ca2c.js"><link rel="prefetch" href="/my-blog/assets/js/117.24ddf316.js"><link rel="prefetch" href="/my-blog/assets/js/12.06fcb150.js"><link rel="prefetch" href="/my-blog/assets/js/13.c441de9d.js"><link rel="prefetch" href="/my-blog/assets/js/14.ca26e948.js"><link rel="prefetch" href="/my-blog/assets/js/15.e7761bd0.js"><link rel="prefetch" href="/my-blog/assets/js/16.5be4d33f.js"><link rel="prefetch" href="/my-blog/assets/js/17.4426a95c.js"><link rel="prefetch" href="/my-blog/assets/js/18.7d974f8d.js"><link rel="prefetch" href="/my-blog/assets/js/19.775995bc.js"><link rel="prefetch" href="/my-blog/assets/js/20.71c35e12.js"><link rel="prefetch" href="/my-blog/assets/js/21.741a18a7.js"><link rel="prefetch" href="/my-blog/assets/js/22.819a7e85.js"><link rel="prefetch" href="/my-blog/assets/js/23.f9133433.js"><link rel="prefetch" href="/my-blog/assets/js/24.86a7d541.js"><link rel="prefetch" href="/my-blog/assets/js/25.0aa2d6ab.js"><link rel="prefetch" href="/my-blog/assets/js/26.3e55392e.js"><link rel="prefetch" href="/my-blog/assets/js/27.ae2e0581.js"><link rel="prefetch" href="/my-blog/assets/js/28.aaa62b88.js"><link rel="prefetch" href="/my-blog/assets/js/29.55007ae9.js"><link rel="prefetch" href="/my-blog/assets/js/3.57915124.js"><link rel="prefetch" href="/my-blog/assets/js/30.63aac023.js"><link rel="prefetch" href="/my-blog/assets/js/31.d5607214.js"><link rel="prefetch" href="/my-blog/assets/js/32.a7ae912b.js"><link rel="prefetch" href="/my-blog/assets/js/33.58fcbfa4.js"><link rel="prefetch" href="/my-blog/assets/js/34.8538d781.js"><link rel="prefetch" href="/my-blog/assets/js/35.14a82428.js"><link rel="prefetch" href="/my-blog/assets/js/36.2ad806dd.js"><link rel="prefetch" href="/my-blog/assets/js/37.207a29ce.js"><link rel="prefetch" href="/my-blog/assets/js/38.57c0d12e.js"><link rel="prefetch" href="/my-blog/assets/js/39.83aff8a9.js"><link rel="prefetch" href="/my-blog/assets/js/40.bcbcfd03.js"><link rel="prefetch" href="/my-blog/assets/js/41.d0a94dfd.js"><link rel="prefetch" href="/my-blog/assets/js/42.f6011b50.js"><link rel="prefetch" href="/my-blog/assets/js/43.efd29b4c.js"><link rel="prefetch" href="/my-blog/assets/js/44.e5c9709c.js"><link rel="prefetch" href="/my-blog/assets/js/45.7656da3c.js"><link rel="prefetch" href="/my-blog/assets/js/46.0f46c833.js"><link rel="prefetch" href="/my-blog/assets/js/47.40ce4540.js"><link rel="prefetch" href="/my-blog/assets/js/48.3db9c583.js"><link rel="prefetch" href="/my-blog/assets/js/49.53285ac3.js"><link rel="prefetch" href="/my-blog/assets/js/50.4db56f99.js"><link rel="prefetch" href="/my-blog/assets/js/51.188f8c4f.js"><link rel="prefetch" href="/my-blog/assets/js/52.95be221e.js"><link rel="prefetch" href="/my-blog/assets/js/53.276e1791.js"><link rel="prefetch" href="/my-blog/assets/js/54.2fd73796.js"><link rel="prefetch" href="/my-blog/assets/js/55.c90a5bd8.js"><link rel="prefetch" href="/my-blog/assets/js/56.406f89df.js"><link rel="prefetch" href="/my-blog/assets/js/57.811f05ab.js"><link rel="prefetch" href="/my-blog/assets/js/58.e2896a54.js"><link rel="prefetch" href="/my-blog/assets/js/59.e5f3be54.js"><link rel="prefetch" href="/my-blog/assets/js/6.8ba90f8e.js"><link rel="prefetch" href="/my-blog/assets/js/60.e4b67c15.js"><link rel="prefetch" href="/my-blog/assets/js/61.7b772903.js"><link rel="prefetch" href="/my-blog/assets/js/62.bbe4352b.js"><link rel="prefetch" href="/my-blog/assets/js/63.e350ef3b.js"><link rel="prefetch" href="/my-blog/assets/js/64.7b6ca2f6.js"><link rel="prefetch" href="/my-blog/assets/js/65.76baf7fa.js"><link rel="prefetch" href="/my-blog/assets/js/66.ff801cea.js"><link rel="prefetch" href="/my-blog/assets/js/67.ee30cd5b.js"><link rel="prefetch" href="/my-blog/assets/js/68.0f4c1ce2.js"><link rel="prefetch" href="/my-blog/assets/js/69.111ce4de.js"><link rel="prefetch" href="/my-blog/assets/js/7.55078740.js"><link rel="prefetch" href="/my-blog/assets/js/70.46f8b5e8.js"><link rel="prefetch" href="/my-blog/assets/js/71.675e279c.js"><link rel="prefetch" href="/my-blog/assets/js/72.c419d947.js"><link rel="prefetch" href="/my-blog/assets/js/73.6eb4799a.js"><link rel="prefetch" href="/my-blog/assets/js/74.18229d2e.js"><link rel="prefetch" href="/my-blog/assets/js/75.46c8298d.js"><link rel="prefetch" href="/my-blog/assets/js/76.c966d3c5.js"><link rel="prefetch" href="/my-blog/assets/js/77.b31efc9c.js"><link rel="prefetch" href="/my-blog/assets/js/78.f7e57735.js"><link rel="prefetch" href="/my-blog/assets/js/79.e056b5a5.js"><link rel="prefetch" href="/my-blog/assets/js/8.ddecccf2.js"><link rel="prefetch" href="/my-blog/assets/js/80.0fc539d1.js"><link rel="prefetch" href="/my-blog/assets/js/81.2b7f0d10.js"><link rel="prefetch" href="/my-blog/assets/js/82.d3e4b716.js"><link rel="prefetch" href="/my-blog/assets/js/83.3073a1d2.js"><link rel="prefetch" href="/my-blog/assets/js/84.d231aeff.js"><link rel="prefetch" href="/my-blog/assets/js/85.7daed020.js"><link rel="prefetch" href="/my-blog/assets/js/86.0c8d8d8e.js"><link rel="prefetch" href="/my-blog/assets/js/87.c4ba5f03.js"><link rel="prefetch" href="/my-blog/assets/js/88.9a4e0ef6.js"><link rel="prefetch" href="/my-blog/assets/js/89.b7bca56b.js"><link rel="prefetch" href="/my-blog/assets/js/9.7463f385.js"><link rel="prefetch" href="/my-blog/assets/js/90.49ec4345.js"><link rel="prefetch" href="/my-blog/assets/js/91.84cb7a66.js"><link rel="prefetch" href="/my-blog/assets/js/92.cb5ea946.js"><link rel="prefetch" href="/my-blog/assets/js/93.05e2ac79.js"><link rel="prefetch" href="/my-blog/assets/js/94.e60969c0.js"><link rel="prefetch" href="/my-blog/assets/js/95.688af442.js"><link rel="prefetch" href="/my-blog/assets/js/96.aba3a873.js"><link rel="prefetch" href="/my-blog/assets/js/97.ca8196eb.js"><link rel="prefetch" href="/my-blog/assets/js/99.eca50447.js">
    <link rel="stylesheet" href="/my-blog/assets/css/0.styles.67b6080f.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/my-blog/" class="home-link router-link-active"><!----> <span class="site-name">林山夕风</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/my-blog/" class="nav-link">
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="基础教程" class="dropdown-title"><span class="title">基础教程</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/my-blog/frontend/" class="nav-link">
  前端
</a></li><li class="dropdown-item"><!----> <a href="/my-blog/backend/" class="nav-link">
  后端
</a></li><li class="dropdown-item"><!----> <a href="/my-blog/enjoy3/" class="nav-link">
  进阶
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据结构与算法" class="dropdown-title"><span class="title">数据结构与算法</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/my-blog/structure/" class="nav-link">
  数据结构
</a></li><li class="dropdown-item"><!----> <a href="/my-blog/algorithm/" class="nav-link">
  算法
</a></li></ul></div></div><div class="nav-item"><a href="/my-blog/leetcode/" class="nav-link">
  LeetCode题解
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="设计思想" class="dropdown-title"><span class="title">设计思想</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/my-blog/principle/" class="nav-link">
  设计原则
</a></li><li class="dropdown-item"><!----> <a href="/my-blog/pattern/" class="nav-link">
  设计模式
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="读书笔记" class="dropdown-title"><span class="title">读书笔记</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/my-blog/thinking_in_java/" class="nav-link">
  Java编程思想
</a></li><li class="dropdown-item"><!----> <a href="/my-blog/refactoring_improving_the_design_of_existing_code/" class="nav-link router-link-active">
  重构改善既有代码的设计
</a></li></ul></div></div><div class="nav-item"><a href="/my-blog/project/" class="nav-link">
  项目实战
</a></div><div class="nav-item"><a href="/my-blog/article/" class="nav-link">
  零散文章
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="代码管理" class="dropdown-title"><span class="title">代码管理</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://gitee.com/doomthr" target="_blank" rel="noopener noreferrer" class="nav-link external">
  码云
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://github.com/TanHaoran" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/my-blog/" class="nav-link">
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="基础教程" class="dropdown-title"><span class="title">基础教程</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/my-blog/frontend/" class="nav-link">
  前端
</a></li><li class="dropdown-item"><!----> <a href="/my-blog/backend/" class="nav-link">
  后端
</a></li><li class="dropdown-item"><!----> <a href="/my-blog/enjoy3/" class="nav-link">
  进阶
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据结构与算法" class="dropdown-title"><span class="title">数据结构与算法</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/my-blog/structure/" class="nav-link">
  数据结构
</a></li><li class="dropdown-item"><!----> <a href="/my-blog/algorithm/" class="nav-link">
  算法
</a></li></ul></div></div><div class="nav-item"><a href="/my-blog/leetcode/" class="nav-link">
  LeetCode题解
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="设计思想" class="dropdown-title"><span class="title">设计思想</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/my-blog/principle/" class="nav-link">
  设计原则
</a></li><li class="dropdown-item"><!----> <a href="/my-blog/pattern/" class="nav-link">
  设计模式
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="读书笔记" class="dropdown-title"><span class="title">读书笔记</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/my-blog/thinking_in_java/" class="nav-link">
  Java编程思想
</a></li><li class="dropdown-item"><!----> <a href="/my-blog/refactoring_improving_the_design_of_existing_code/" class="nav-link router-link-active">
  重构改善既有代码的设计
</a></li></ul></div></div><div class="nav-item"><a href="/my-blog/project/" class="nav-link">
  项目实战
</a></div><div class="nav-item"><a href="/my-blog/article/" class="nav-link">
  零散文章
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="代码管理" class="dropdown-title"><span class="title">代码管理</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://gitee.com/doomthr" target="_blank" rel="noopener noreferrer" class="nav-link external">
  码云
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://github.com/TanHaoran" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>重构改善既有代码的设计</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/my-blog/refactoring_improving_the_design_of_existing_code/第1章：重构，第一个案例.html" class="active sidebar-link">第1章：重构，第一个案例</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/my-blog/refactoring_improving_the_design_of_existing_code/第1章：重构，第一个案例.html#一、起点" class="sidebar-link">一、起点</a></li><li class="sidebar-sub-header"><a href="/my-blog/refactoring_improving_the_design_of_existing_code/第1章：重构，第一个案例.html#二、重构的第一步" class="sidebar-link">二、重构的第一步</a></li><li class="sidebar-sub-header"><a href="/my-blog/refactoring_improving_the_design_of_existing_code/第1章：重构，第一个案例.html#三、分解并重组-statement" class="sidebar-link">三、分解并重组 statement()</a></li><li class="sidebar-sub-header"><a href="/my-blog/refactoring_improving_the_design_of_existing_code/第1章：重构，第一个案例.html#四、运用多态取代与价格相关的条件逻辑" class="sidebar-link">四、运用多态取代与价格相关的条件逻辑</a></li></ul></li><li><a href="/my-blog/refactoring_improving_the_design_of_existing_code/第2章：重构原则.html" class="sidebar-link">第2章：重构原则</a></li><li><a href="/my-blog/refactoring_improving_the_design_of_existing_code/第3章：代码的坏味道.html" class="sidebar-link">第3章：代码的坏味道</a></li><li><a href="/my-blog/refactoring_improving_the_design_of_existing_code/第4章：构筑测试体系.html" class="sidebar-link">第4章：构筑测试体系</a></li><li><a href="/my-blog/refactoring_improving_the_design_of_existing_code/第5章：重构列表.html" class="sidebar-link">第5章：重构列表</a></li><li><a href="/my-blog/refactoring_improving_the_design_of_existing_code/第6章：重新组织函数.html" class="sidebar-link">第6章：重新组织函数</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="第1章：重构，第一个案例"><a href="#第1章：重构，第一个案例" class="header-anchor">#</a> 第1章：重构，第一个案例</h1> <div><span id="/my-blog/refactoring_improving_the_design_of_existing_code/第1章：重构，第一个案例.html" data-flag-title="第1章：重构，第一个案例" class="leancloud_visitors read-count"><em class="post-meta-item-text">阅读量 </em> <i class="leancloud-visitors-count">loading</i></span> <div class="clear-both"></div></div> <h2 id="一、起点"><a href="#一、起点" class="header-anchor">#</a> 一、起点</h2> <p>一个影片出租店的应用程序，根据顾客组的影片，计算消费金额。</p> <p>影片类：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Movie</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> CHILDRENS <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> REGULAR <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> NEW_RELEASE <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> _title<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> _priceCode<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">Movie</span><span class="token punctuation">(</span><span class="token class-name">String</span> title<span class="token punctuation">,</span> <span class="token keyword">int</span> priceCode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        _title <span class="token operator">=</span> title<span class="token punctuation">;</span>
        _priceCode <span class="token operator">=</span> priceCode<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getPriceCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> _priceCode<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setPriceCode</span><span class="token punctuation">(</span><span class="token keyword">int</span> priceCode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        _priceCode <span class="token operator">=</span> priceCode<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getTitle</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> _title<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><p>租赁类：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Rental</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">Movie</span> _movie<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> _daysRented<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">Rental</span><span class="token punctuation">(</span><span class="token class-name">Movie</span> movie<span class="token punctuation">,</span> <span class="token keyword">int</span> daysRented<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        _movie <span class="token operator">=</span> movie<span class="token punctuation">;</span>
        _daysRented <span class="token operator">=</span> daysRented<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getDaysRented</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> _daysRented<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">Movie</span> <span class="token function">getMovie</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> _movie<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>顾客类：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Customer</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> _name<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Vector</span> _rentals <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">Customer</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        _name <span class="token operator">=</span> name<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addRental</span><span class="token punctuation">(</span><span class="token class-name">Rental</span> arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        _rentals<span class="token punctuation">.</span><span class="token function">addElement</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> _name<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 生成详单
     *
     * @return
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">statement</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">double</span> totalAmount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> frequentRenterPoints <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token class-name">Enumeration</span> rentals <span class="token operator">=</span> _rentals<span class="token punctuation">.</span><span class="token function">elements</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> result <span class="token operator">=</span> <span class="token string">&quot;Rental Record for &quot;</span> <span class="token operator">+</span> <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;\n&quot;</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>rentals<span class="token punctuation">.</span><span class="token function">hasMoreElements</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">double</span> thisAmount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token class-name">Rental</span> each <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Rental</span><span class="token punctuation">)</span> rentals<span class="token punctuation">.</span><span class="token function">nextElement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// determine amounts for each line</span>
            <span class="token keyword">switch</span> <span class="token punctuation">(</span>each<span class="token punctuation">.</span><span class="token function">getMovie</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPriceCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">case</span> <span class="token class-name">Movie</span><span class="token punctuation">.</span>REGULAR<span class="token operator">:</span>
                    thisAmount <span class="token operator">+=</span> <span class="token number">2</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>each<span class="token punctuation">.</span><span class="token function">getDaysRented</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">2</span><span class="token punctuation">)</span>
                        thisAmount <span class="token operator">+=</span> <span class="token punctuation">(</span>each<span class="token punctuation">.</span><span class="token function">getDaysRented</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1.5</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token keyword">case</span> <span class="token class-name">Movie</span><span class="token punctuation">.</span>NEW_RELEASE<span class="token operator">:</span>
                    thisAmount <span class="token operator">+=</span> each<span class="token punctuation">.</span><span class="token function">getDaysRented</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token keyword">case</span> <span class="token class-name">Movie</span><span class="token punctuation">.</span>CHILDRENS<span class="token operator">:</span>
                    thisAmount <span class="token operator">+=</span> <span class="token number">1.5</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>each<span class="token punctuation">.</span><span class="token function">getDaysRented</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">3</span><span class="token punctuation">)</span>
                        thisAmount <span class="token operator">+=</span> <span class="token punctuation">(</span>each<span class="token punctuation">.</span><span class="token function">getDaysRented</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1.5</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// add frequent renter points</span>
            frequentRenterPoints<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token comment">// add bonus for a two day new release rental</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>each<span class="token punctuation">.</span><span class="token function">getMovie</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPriceCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">Movie</span><span class="token punctuation">.</span>NEW_RELEASE<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> each<span class="token punctuation">.</span><span class="token function">getDaysRented</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span>
                frequentRenterPoints<span class="token operator">++</span><span class="token punctuation">;</span>

            <span class="token comment">// show figures for this rental</span>
            result <span class="token operator">+=</span> <span class="token string">&quot;\t&quot;</span> <span class="token operator">+</span> each<span class="token punctuation">.</span><span class="token function">getMovie</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTitle</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;\t&quot;</span> <span class="token operator">+</span> thisAmount <span class="token operator">+</span> <span class="token string">&quot;\n&quot;</span><span class="token punctuation">;</span>
            totalAmount <span class="token operator">+=</span> thisAmount<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// add footer lines</span>
        result <span class="token operator">+=</span> <span class="token string">&quot;Amount owed is &quot;</span> <span class="token operator">+</span> totalAmount <span class="token operator">+</span> <span class="token string">&quot;\n&quot;</span><span class="token punctuation">;</span>
        result <span class="token operator">+=</span> <span class="token string">&quot;You earned &quot;</span> <span class="token operator">+</span> frequentRenterPoints <span class="token operator">+</span> <span class="token string">&quot; frequent renter points&quot;</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br></div></div><p>在上面的 <code>statement()</code> 方法中做了很多很多了逻辑，有的其实并不属于这个类应该处理的。加入后期需要让这个方法返回一个 <code>html</code> 格式的详单，那么修改这个方法是不可能的了，肯定要单独写一个返回 <code>html</code> 输出的方法，那么其中的计费标准如果有变动的话，那么 <code>statement()</code> 和 新写的这个方法都会要改动，以后就得维护两个地方，改的越多越容易出错。</p> <p><strong>如果你发现自己需要为程序添加一个特性，而代码结构是你无法很方便地打成目的，那就先重构那个程序，使特性的添加比较容易进行，然后再添加特性</strong></p> <h2 id="二、重构的第一步"><a href="#二、重构的第一步" class="header-anchor">#</a> 二、重构的第一步</h2> <p>由于 <code>statement()</code> 的运作结果是个字符串，所以先假设一些顾客租赁不同的影片，产生报表字符串，然后用这个字符串和重构后产生的字符串进行对比，看是否一致。</p> <p><strong>重构之前，首先检查自己是否有一套可靠的测试机制。这些测试必须有自我检验能力</strong></p> <p>下面是我的测试类：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ShopTest</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Customer</span> customer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Customer</span><span class="token punctuation">(</span><span class="token string">&quot;jerry&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Movie</span> movie1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Movie</span><span class="token punctuation">(</span><span class="token string">&quot;爱乐之城&quot;</span><span class="token punctuation">,</span> <span class="token class-name">Movie</span><span class="token punctuation">.</span>REGULAR<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Rental</span> rental1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Rental</span><span class="token punctuation">(</span>movie1<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Movie</span> movie2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Movie</span><span class="token punctuation">(</span><span class="token string">&quot;千与千寻&quot;</span><span class="token punctuation">,</span> <span class="token class-name">Movie</span><span class="token punctuation">.</span>CHILDRENS<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Rental</span> rental2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Rental</span><span class="token punctuation">(</span>movie2<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        customer<span class="token punctuation">.</span><span class="token function">addRental</span><span class="token punctuation">(</span>rental1<span class="token punctuation">)</span><span class="token punctuation">;</span>
        customer<span class="token punctuation">.</span><span class="token function">addRental</span><span class="token punctuation">(</span>rental2<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>customer<span class="token punctuation">.</span><span class="token function">statement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>执行结果：</p> <div class="language-console line-numbers-mode"><pre class="language-text"><code>Rental Record for jerry
	爱乐之城	5.0
	千与千寻	1.5
Amount owed is 6.5
You earned 2 frequent renter points
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h2 id="三、分解并重组-statement"><a href="#三、分解并重组-statement" class="header-anchor">#</a> 三、分解并重组 statement()</h2> <p>将长的离谱的方法进行拆分。代码块俞小，代码的功能就俞容易管理，代码的处理和移动也就俞轻松。</p> <p>首先，在方法内找到局部变量和参数，<code>each</code> 和 <code>thisAmount</code>，前者违背修改，后者会被修改，任何不会被修改的变量都可以被当成参数传入新的方法中，至于会被修改的变量就需格外小心。如果只有一个变量会被修改，可以当做返回值。<code>thisAmount</code> 是个临时变量，其值在每次循环起始处被设置0，并在 <code>switch</code> 语句之前不会被改变，所以可以直接把新方法的返回值赋给它。</p> <p>重构后的代码：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Customer</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> _name<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Vector</span> _rentals <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">Customer</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        _name <span class="token operator">=</span> name<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addRental</span><span class="token punctuation">(</span><span class="token class-name">Rental</span> arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        _rentals<span class="token punctuation">.</span><span class="token function">addElement</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> _name<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 生成详单
     *
     * @return
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">statement</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">double</span> totalAmount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> frequentRenterPoints <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token class-name">Enumeration</span> rentals <span class="token operator">=</span> _rentals<span class="token punctuation">.</span><span class="token function">elements</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> result <span class="token operator">=</span> <span class="token string">&quot;Rental Record for &quot;</span> <span class="token operator">+</span> <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;\n&quot;</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>rentals<span class="token punctuation">.</span><span class="token function">hasMoreElements</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">double</span> thisAmount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token class-name">Rental</span> each <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Rental</span><span class="token punctuation">)</span> rentals<span class="token punctuation">.</span><span class="token function">nextElement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            thisAmount <span class="token operator">=</span> <span class="token function">amountFor</span><span class="token punctuation">(</span>each<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// add frequent renter points</span>
            frequentRenterPoints<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token comment">// add bonus for a two day new release rental</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>each<span class="token punctuation">.</span><span class="token function">getMovie</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPriceCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">Movie</span><span class="token punctuation">.</span>NEW_RELEASE<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> each<span class="token punctuation">.</span><span class="token function">getDaysRented</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span>
                frequentRenterPoints<span class="token operator">++</span><span class="token punctuation">;</span>

            <span class="token comment">// show figures for this rental</span>
            result <span class="token operator">+=</span> <span class="token string">&quot;\t&quot;</span> <span class="token operator">+</span> each<span class="token punctuation">.</span><span class="token function">getMovie</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTitle</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;\t&quot;</span> <span class="token operator">+</span> thisAmount <span class="token operator">+</span> <span class="token string">&quot;\n&quot;</span><span class="token punctuation">;</span>
            totalAmount <span class="token operator">+=</span> thisAmount<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// add footer lines</span>
        result <span class="token operator">+=</span> <span class="token string">&quot;Amount owed is &quot;</span> <span class="token operator">+</span> totalAmount <span class="token operator">+</span> <span class="token string">&quot;\n&quot;</span><span class="token punctuation">;</span>
        result <span class="token operator">+=</span> <span class="token string">&quot;You earned &quot;</span> <span class="token operator">+</span> frequentRenterPoints <span class="token operator">+</span> <span class="token string">&quot; frequent renter points&quot;</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">double</span> <span class="token function">amountFor</span><span class="token punctuation">(</span><span class="token class-name">Rental</span> each<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">double</span> thisAmount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token comment">// determine amounts for each line</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>each<span class="token punctuation">.</span><span class="token function">getMovie</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPriceCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">case</span> <span class="token class-name">Movie</span><span class="token punctuation">.</span>REGULAR<span class="token operator">:</span>
                thisAmount <span class="token operator">+=</span> <span class="token number">2</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>each<span class="token punctuation">.</span><span class="token function">getDaysRented</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">2</span><span class="token punctuation">)</span>
                    thisAmount <span class="token operator">+=</span> <span class="token punctuation">(</span>each<span class="token punctuation">.</span><span class="token function">getDaysRented</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1.5</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token class-name">Movie</span><span class="token punctuation">.</span>NEW_RELEASE<span class="token operator">:</span>
                thisAmount <span class="token operator">+=</span> each<span class="token punctuation">.</span><span class="token function">getDaysRented</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token class-name">Movie</span><span class="token punctuation">.</span>CHILDRENS<span class="token operator">:</span>
                thisAmount <span class="token operator">+=</span> <span class="token number">1.5</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>each<span class="token punctuation">.</span><span class="token function">getDaysRented</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">3</span><span class="token punctuation">)</span>
                    thisAmount <span class="token operator">+=</span> <span class="token punctuation">(</span>each<span class="token punctuation">.</span><span class="token function">getDaysRented</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1.5</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> thisAmount<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br></div></div><p>注意这里重构的时候可能会将 <code>amountFor()</code> 返回值定义成 <code>int</code>，那么就会出错，实际上应当是 <code>double</code>，做好测试后就会发现这个问题。</p> <p><strong>重构技术就是以微笑的步伐修改程序。如果你犯下错误，很容易便可发现它。</strong></p> <p>对于 <code>amountFor()</code> 方法中的变量名还不是很满意，于是对于 <code>amountFor()</code> 方法继续重构：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token keyword">private</span> <span class="token keyword">double</span> <span class="token function">amountFor</span><span class="token punctuation">(</span><span class="token class-name">Rental</span> aRental<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">double</span> result <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token comment">// determine amounts for aRental line</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>aRental<span class="token punctuation">.</span><span class="token function">getMovie</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPriceCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">case</span> <span class="token class-name">Movie</span><span class="token punctuation">.</span>REGULAR<span class="token operator">:</span>
                result <span class="token operator">+=</span> <span class="token number">2</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>aRental<span class="token punctuation">.</span><span class="token function">getDaysRented</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">2</span><span class="token punctuation">)</span>
                    result <span class="token operator">+=</span> <span class="token punctuation">(</span>aRental<span class="token punctuation">.</span><span class="token function">getDaysRented</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1.5</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token class-name">Movie</span><span class="token punctuation">.</span>NEW_RELEASE<span class="token operator">:</span>
                result <span class="token operator">+=</span> aRental<span class="token punctuation">.</span><span class="token function">getDaysRented</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token class-name">Movie</span><span class="token punctuation">.</span>CHILDRENS<span class="token operator">:</span>
                result <span class="token operator">+=</span> <span class="token number">1.5</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>aRental<span class="token punctuation">.</span><span class="token function">getDaysRented</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">3</span><span class="token punctuation">)</span>
                    result <span class="token operator">+=</span> <span class="token punctuation">(</span>aRental<span class="token punctuation">.</span><span class="token function">getDaysRented</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1.5</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p><strong>任何一个傻瓜都能写出计算机可以理解的代码。唯有写出人类容易理解的代码，才是优秀的程序员。</strong></p> <p>继续观察发现 <code>amountFor()</code> 方法使用了来自 <code>Rental</code> 类的信息，却没有使用来自 <code>Customer</code> 类的信息，所以这个方法应当已到 <code>Rental</code> 类中：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Rental</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">Movie</span> _movie<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> _daysRented<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">Rental</span><span class="token punctuation">(</span><span class="token class-name">Movie</span> movie<span class="token punctuation">,</span> <span class="token keyword">int</span> daysRented<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        _movie <span class="token operator">=</span> movie<span class="token punctuation">;</span>
        _daysRented <span class="token operator">=</span> daysRented<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getDaysRented</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> _daysRented<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">Movie</span> <span class="token function">getMovie</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> _movie<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">double</span> <span class="token function">getCharge</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">double</span> result <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token comment">// determine amounts for aRental line</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span><span class="token function">getMovie</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPriceCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">case</span> <span class="token class-name">Movie</span><span class="token punctuation">.</span>REGULAR<span class="token operator">:</span>
                result <span class="token operator">+=</span> <span class="token number">2</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getDaysRented</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">2</span><span class="token punctuation">)</span>
                    result <span class="token operator">+=</span> <span class="token punctuation">(</span><span class="token function">getDaysRented</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1.5</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token class-name">Movie</span><span class="token punctuation">.</span>NEW_RELEASE<span class="token operator">:</span>
                result <span class="token operator">+=</span> <span class="token function">getDaysRented</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token class-name">Movie</span><span class="token punctuation">.</span>CHILDRENS<span class="token operator">:</span>
                result <span class="token operator">+=</span> <span class="token number">1.5</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getDaysRented</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">3</span><span class="token punctuation">)</span>
                    result <span class="token operator">+=</span> <span class="token punctuation">(</span><span class="token function">getDaysRented</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1.5</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br></div></div><p>现在就可以去掉 <code>Customer</code> 类中的 <code>amountFor()</code> 方法，直接采用 <code>Rental</code> 类的 <code>getCharge()</code> 方法了。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">statement</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">double</span> totalAmount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> frequentRenterPoints <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token class-name">Enumeration</span> rentals <span class="token operator">=</span> _rentals<span class="token punctuation">.</span><span class="token function">elements</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> result <span class="token operator">=</span> <span class="token string">&quot;Rental Record for &quot;</span> <span class="token operator">+</span> <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;\n&quot;</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>rentals<span class="token punctuation">.</span><span class="token function">hasMoreElements</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">double</span> thisAmount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token class-name">Rental</span> each <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Rental</span><span class="token punctuation">)</span> rentals<span class="token punctuation">.</span><span class="token function">nextElement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            thisAmount <span class="token operator">=</span> each<span class="token punctuation">.</span><span class="token function">getCharge</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// add frequent renter points</span>
            frequentRenterPoints<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token comment">// add bonus for a two day new release rental</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>each<span class="token punctuation">.</span><span class="token function">getMovie</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPriceCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">Movie</span><span class="token punctuation">.</span>NEW_RELEASE<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> each<span class="token punctuation">.</span><span class="token function">getDaysRented</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span>
                frequentRenterPoints<span class="token operator">++</span><span class="token punctuation">;</span>

            <span class="token comment">// show figures for this rental</span>
            result <span class="token operator">+=</span> <span class="token string">&quot;\t&quot;</span> <span class="token operator">+</span> each<span class="token punctuation">.</span><span class="token function">getMovie</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTitle</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;\t&quot;</span> <span class="token operator">+</span> thisAmount <span class="token operator">+</span> <span class="token string">&quot;\n&quot;</span><span class="token punctuation">;</span>
            totalAmount <span class="token operator">+=</span> thisAmount<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// add footer lines</span>
        result <span class="token operator">+=</span> <span class="token string">&quot;Amount owed is &quot;</span> <span class="token operator">+</span> totalAmount <span class="token operator">+</span> <span class="token string">&quot;\n&quot;</span><span class="token punctuation">;</span>
        result <span class="token operator">+=</span> <span class="token string">&quot;You earned &quot;</span> <span class="token operator">+</span> frequentRenterPoints <span class="token operator">+</span> <span class="token string">&quot; frequent renter points&quot;</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><p>下一步，其实发现 <code>statement()</code> 方法中的 <code>thisAmount</code> 可以直接使用 <code>each.getCharge()</code> 来替换就可以了：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">statement</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">double</span> totalAmount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> frequentRenterPoints <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token class-name">Enumeration</span> rentals <span class="token operator">=</span> _rentals<span class="token punctuation">.</span><span class="token function">elements</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> result <span class="token operator">=</span> <span class="token string">&quot;Rental Record for &quot;</span> <span class="token operator">+</span> <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;\n&quot;</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>rentals<span class="token punctuation">.</span><span class="token function">hasMoreElements</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Rental</span> each <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Rental</span><span class="token punctuation">)</span> rentals<span class="token punctuation">.</span><span class="token function">nextElement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// add frequent renter points</span>
            frequentRenterPoints<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token comment">// add bonus for a two day new release rental</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>each<span class="token punctuation">.</span><span class="token function">getMovie</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPriceCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">Movie</span><span class="token punctuation">.</span>NEW_RELEASE<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> each<span class="token punctuation">.</span><span class="token function">getDaysRented</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span>
                frequentRenterPoints<span class="token operator">++</span><span class="token punctuation">;</span>

            <span class="token comment">// show figures for this rental</span>
            result <span class="token operator">+=</span> <span class="token string">&quot;\t&quot;</span> <span class="token operator">+</span> each<span class="token punctuation">.</span><span class="token function">getMovie</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTitle</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;\t&quot;</span> <span class="token operator">+</span> each<span class="token punctuation">.</span><span class="token function">getCharge</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;\n&quot;</span><span class="token punctuation">;</span>
            totalAmount <span class="token operator">+=</span> each<span class="token punctuation">.</span><span class="token function">getCharge</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// add footer lines</span>
        result <span class="token operator">+=</span> <span class="token string">&quot;Amount owed is &quot;</span> <span class="token operator">+</span> totalAmount <span class="token operator">+</span> <span class="token string">&quot;\n&quot;</span><span class="token punctuation">;</span>
        result <span class="token operator">+=</span> <span class="token string">&quot;You earned &quot;</span> <span class="token operator">+</span> frequentRenterPoints <span class="token operator">+</span> <span class="token string">&quot; frequent renter points&quot;</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>虽然这么做会在 <code>getCharse()</code> 中进行两次计算，但是这个计算可以在 <code>Rental</code> 类中进行优化。</p> <p>接下来开始优化计算常客积分的这部分代码。</p> <p>依旧是在 <code>Rental</code> 类中新增一个方法：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token keyword">int</span> <span class="token function">getFrequentRenterPoints</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> frequentRenterPoints <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token comment">// add frequent renter points</span>
        frequentRenterPoints<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token comment">// add bonus for a two day new release rental</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">getMovie</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPriceCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">Movie</span><span class="token punctuation">.</span>NEW_RELEASE<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">getDaysRented</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span>
            frequentRenterPoints<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> frequentRenterPoints<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>用于替换在 <code>Customer</code> 类中计算常客积分部分代码：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">statement</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">double</span> totalAmount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> frequentRenterPoints <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token class-name">Enumeration</span> rentals <span class="token operator">=</span> _rentals<span class="token punctuation">.</span><span class="token function">elements</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> result <span class="token operator">=</span> <span class="token string">&quot;Rental Record for &quot;</span> <span class="token operator">+</span> <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;\n&quot;</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>rentals<span class="token punctuation">.</span><span class="token function">hasMoreElements</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Rental</span> each <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Rental</span><span class="token punctuation">)</span> rentals<span class="token punctuation">.</span><span class="token function">nextElement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            frequentRenterPoints <span class="token operator">+=</span> each<span class="token punctuation">.</span><span class="token function">getFrequentRenterPoints</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// show figures for this rental</span>
            result <span class="token operator">+=</span> <span class="token string">&quot;\t&quot;</span> <span class="token operator">+</span> each<span class="token punctuation">.</span><span class="token function">getMovie</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTitle</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;\t&quot;</span> <span class="token operator">+</span> each<span class="token punctuation">.</span><span class="token function">getCharge</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;\n&quot;</span><span class="token punctuation">;</span>
            totalAmount <span class="token operator">+=</span> each<span class="token punctuation">.</span><span class="token function">getCharge</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// add footer lines</span>
        result <span class="token operator">+=</span> <span class="token string">&quot;Amount owed is &quot;</span> <span class="token operator">+</span> totalAmount <span class="token operator">+</span> <span class="token string">&quot;\n&quot;</span><span class="token punctuation">;</span>
        result <span class="token operator">+=</span> <span class="token string">&quot;You earned &quot;</span> <span class="token operator">+</span> frequentRenterPoints <span class="token operator">+</span> <span class="token string">&quot; frequent renter points&quot;</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>接下来处理临时变量的问题，在 <code>statement()</code> 方法中还存在两个临时变量 <code>totalAmount</code> 和 <code>frequentRenterPoints</code> ，首先用 <code>getTotalCharge()</code> 取代 <code>totalAmount</code>：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">statement</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> frequentRenterPoints <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token class-name">Enumeration</span> rentals <span class="token operator">=</span> _rentals<span class="token punctuation">.</span><span class="token function">elements</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> result <span class="token operator">=</span> <span class="token string">&quot;Rental Record for &quot;</span> <span class="token operator">+</span> <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;\n&quot;</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>rentals<span class="token punctuation">.</span><span class="token function">hasMoreElements</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Rental</span> each <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Rental</span><span class="token punctuation">)</span> rentals<span class="token punctuation">.</span><span class="token function">nextElement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            frequentRenterPoints <span class="token operator">+=</span> each<span class="token punctuation">.</span><span class="token function">getFrequentRenterPoints</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// show figures for this rental</span>
            result <span class="token operator">+=</span> <span class="token string">&quot;\t&quot;</span> <span class="token operator">+</span> each<span class="token punctuation">.</span><span class="token function">getMovie</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTitle</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;\t&quot;</span> <span class="token operator">+</span> each<span class="token punctuation">.</span><span class="token function">getCharge</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;\n&quot;</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// add footer lines</span>
        result <span class="token operator">+=</span> <span class="token string">&quot;Amount owed is &quot;</span> <span class="token operator">+</span> <span class="token function">getTotalCharge</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;\n&quot;</span><span class="token punctuation">;</span>
        result <span class="token operator">+=</span> <span class="token string">&quot;You earned &quot;</span> <span class="token operator">+</span> frequentRenterPoints <span class="token operator">+</span> <span class="token string">&quot; frequent renter points&quot;</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">double</span> <span class="token function">getTotalCharge</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">double</span> result <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token class-name">Enumeration</span> rentals <span class="token operator">=</span> _rentals<span class="token punctuation">.</span><span class="token function">elements</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>rentals<span class="token punctuation">.</span><span class="token function">hasMoreElements</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Rental</span> each <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Rental</span><span class="token punctuation">)</span> rentals<span class="token punctuation">.</span><span class="token function">nextElement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            result <span class="token operator">+=</span> each<span class="token punctuation">.</span><span class="token function">getCharge</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><p>然后以同样的方法处理 <code>frequentRenterPoints</code>：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">statement</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Enumeration</span> rentals <span class="token operator">=</span> _rentals<span class="token punctuation">.</span><span class="token function">elements</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> result <span class="token operator">=</span> <span class="token string">&quot;Rental Record for &quot;</span> <span class="token operator">+</span> <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;\n&quot;</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>rentals<span class="token punctuation">.</span><span class="token function">hasMoreElements</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Rental</span> each <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Rental</span><span class="token punctuation">)</span> rentals<span class="token punctuation">.</span><span class="token function">nextElement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// show figures for this rental</span>
            result <span class="token operator">+=</span> <span class="token string">&quot;\t&quot;</span> <span class="token operator">+</span> each<span class="token punctuation">.</span><span class="token function">getMovie</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTitle</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;\t&quot;</span> <span class="token operator">+</span> each<span class="token punctuation">.</span><span class="token function">getCharge</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;\n&quot;</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// add footer lines</span>
        result <span class="token operator">+=</span> <span class="token string">&quot;Amount owed is &quot;</span> <span class="token operator">+</span> <span class="token function">getTotalCharge</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;\n&quot;</span><span class="token punctuation">;</span>
        result <span class="token operator">+=</span> <span class="token string">&quot;You earned &quot;</span> <span class="token operator">+</span> <span class="token function">getTotalFrequentRenterPoints</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; frequent renter points&quot;</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">int</span> <span class="token function">getTotalFrequentRenterPoints</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> result <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token class-name">Enumeration</span> rentals <span class="token operator">=</span> _rentals<span class="token punctuation">.</span><span class="token function">elements</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>rentals<span class="token punctuation">.</span><span class="token function">hasMoreElements</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Rental</span> each <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Rental</span><span class="token punctuation">)</span> rentals<span class="token punctuation">.</span><span class="token function">nextElement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            result <span class="token operator">+=</span> each<span class="token punctuation">.</span><span class="token function">getFrequentRenterPoints</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>现在利用现有的这些方法，可以轻松的实现一个 <code>htmlStatement()</code> 方法出来，并且如果计算规则发生改变，只需要在程序中做一处修改。</p> <h2 id="四、运用多态取代与价格相关的条件逻辑"><a href="#四、运用多态取代与价格相关的条件逻辑" class="header-anchor">#</a> 四、运用多态取代与价格相关的条件逻辑</h2> <p>现在在 <code>Rental</code> 类的 <code>getCharge()</code> 方法中还有一部分 <code>switch</code> 语句：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token keyword">double</span> <span class="token function">getCharge</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">double</span> result <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token comment">// determine amounts for aRental line</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span><span class="token function">getMovie</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPriceCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">case</span> <span class="token class-name">Movie</span><span class="token punctuation">.</span>REGULAR<span class="token operator">:</span>
                result <span class="token operator">+=</span> <span class="token number">2</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getDaysRented</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">2</span><span class="token punctuation">)</span>
                    result <span class="token operator">+=</span> <span class="token punctuation">(</span><span class="token function">getDaysRented</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1.5</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token class-name">Movie</span><span class="token punctuation">.</span>NEW_RELEASE<span class="token operator">:</span>
                result <span class="token operator">+=</span> <span class="token function">getDaysRented</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token class-name">Movie</span><span class="token punctuation">.</span>CHILDRENS<span class="token operator">:</span>
                result <span class="token operator">+=</span> <span class="token number">1.5</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getDaysRented</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">3</span><span class="token punctuation">)</span>
                    result <span class="token operator">+=</span> <span class="token punctuation">(</span><span class="token function">getDaysRented</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1.5</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>最好不要再另一个对象的属性基础上运用 <code>switch</code> 语句。如果不得不使用，，也应该在对象自己的数据上使用，而不是在别人的数据上使用。也就是说这部分 <code>switch</code> 语句应当移动到 <code>Movie</code> 类中，若如此，就得将 <code>getDaysRented()</code> 作为一个参数传递到 <code>Movie</code> 类中将要创建的方法中去。先看 <code>Movie</code> 新增的方法：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token keyword">double</span> <span class="token function">getCharge</span><span class="token punctuation">(</span><span class="token keyword">int</span> daysRented<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">double</span> result <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token comment">// determine amounts for aRental line</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span><span class="token function">getPriceCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">case</span> <span class="token class-name">Movie</span><span class="token punctuation">.</span>REGULAR<span class="token operator">:</span>
                result <span class="token operator">+=</span> <span class="token number">2</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>daysRented <span class="token operator">&gt;</span> <span class="token number">2</span><span class="token punctuation">)</span>
                    result <span class="token operator">+=</span> <span class="token punctuation">(</span>daysRented <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1.5</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token class-name">Movie</span><span class="token punctuation">.</span>NEW_RELEASE<span class="token operator">:</span>
                result <span class="token operator">+=</span> daysRented <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token class-name">Movie</span><span class="token punctuation">.</span>CHILDRENS<span class="token operator">:</span>
                result <span class="token operator">+=</span> <span class="token number">1.5</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>daysRented <span class="token operator">&gt;</span> <span class="token number">3</span><span class="token punctuation">)</span>
                    result <span class="token operator">+=</span> <span class="token punctuation">(</span>daysRented <span class="token operator">-</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1.5</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>计算费用时需要两项数据：租期长度和影片类型，一种方式是将租期长度传递给 <code>Movie</code> 计算，另一种方式是将影片类型传递给 <code>Rental</code> 计算，这里为什么要将租期作为参数传递给 <code>Movie</code> 类呢？因为系统后期可能会增加新的影片类型，这种变化带有不稳定倾向，所以选择在 <code>Movie</code> 对象内计算费用。</p> <p><code>Rental</code> 的计算方法简化为：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token keyword">double</span> <span class="token function">getCharge</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> _movie<span class="token punctuation">.</span><span class="token function">getCharge</span><span class="token punctuation">(</span>_daysRented<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>同样的方式处理常客积分，在 <code>Movie</code> 类中新增方法：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token keyword">int</span> <span class="token function">getFrequentRenterPoints</span><span class="token punctuation">(</span><span class="token keyword">int</span> daysRented<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">getPriceCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">Movie</span><span class="token punctuation">.</span>NEW_RELEASE<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> daysRented <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token number">2</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span>
            <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p><code>Rental</code> 的计算方法简化为：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token keyword">int</span> <span class="token function">getFrequentRenterPoints</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> _movie<span class="token punctuation">.</span><span class="token function">getFrequentRenterPoints</span><span class="token punctuation">(</span>_daysRented<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>我们有数种影片类型，它们以不同的方式回答相同的问题。这听起来像子类的工作。可以建立 <code>Movie</code> 的三个子类，每个都有自己的计费方法。这样一来就可以使用多态来取代 <code>switch</code> 语句了，这里有个问题：一部影片可以在声明周期内修改自己的分类，一个对象却不能在生命周期内修改自己所属的类。这里就可以使用设计模式中的状态模式，新建一个抽象类 <code>Price</code>，让几种不同的计费规则继承这个类。</p> <p>先将与类型相关的行为搬移到状态模式中，然后将 <code>switch</code> 语句移动到 <code>Price</code> 类中，最后去掉 <code>switch</code>。</p> <p><code>Movie</code> 的构造方法修改为：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token keyword">public</span> <span class="token class-name">Movie</span><span class="token punctuation">(</span><span class="token class-name">String</span> title<span class="token punctuation">,</span> <span class="token keyword">int</span> priceCode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        _title <span class="token operator">=</span> title<span class="token punctuation">;</span>
        <span class="token function">setPriceCode</span><span class="token punctuation">(</span>priceCode<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>新建 <code>Price</code> 类：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">Price</span> <span class="token punctuation">{</span>

    <span class="token keyword">abstract</span> <span class="token keyword">int</span> <span class="token function">getPriceCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>在创建3个类，继承自 <code>Price</code>，每个类中都提供类型相关的行为：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ChildrensPrice</span> <span class="token keyword">extends</span> <span class="token class-name">Price</span><span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">int</span> <span class="token function">getPriceCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">Movie</span><span class="token punctuation">.</span>CHILDRENS<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">NewReleasePrice</span> <span class="token keyword">extends</span> <span class="token class-name">Price</span><span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">int</span> <span class="token function">getPriceCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">Movie</span><span class="token punctuation">.</span>NEW_RELEASE<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RegularPrice</span> <span class="token keyword">extends</span> <span class="token class-name">Price</span><span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">int</span> <span class="token function">getPriceCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">Movie</span><span class="token punctuation">.</span>REGULAR<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>现在修改 <code>Movie</code> 类中访问价格代号的方法，使用新创建的类，此时 <code>Movie</code> 类还得新增一个 <code>Price</code> 对象：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token keyword">private</span> <span class="token class-name">Price</span> _price<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">Movie</span><span class="token punctuation">(</span><span class="token class-name">String</span> title<span class="token punctuation">,</span> <span class="token keyword">int</span> priceCode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        _title <span class="token operator">=</span> title<span class="token punctuation">;</span>
        <span class="token function">setPriceCode</span><span class="token punctuation">(</span>priceCode<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getPriceCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> _price<span class="token punctuation">.</span><span class="token function">getPriceCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setPriceCode</span><span class="token punctuation">(</span><span class="token keyword">int</span> priceCode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>priceCode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">case</span> REGULAR<span class="token operator">:</span>
                _price <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RegularPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> CHILDRENS<span class="token operator">:</span>
                _price <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ChildrensPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> NEW_RELEASE<span class="token operator">:</span>
                _price <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NewReleasePrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">default</span><span class="token operator">:</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">&quot;Incorrect Price Code&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><p>在 <code>Price</code> 类新增一个实现好的方法：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token keyword">double</span> <span class="token function">getCharge</span><span class="token punctuation">(</span><span class="token keyword">int</span> daysRented<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">double</span> result <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token comment">// determine amounts for aRental line</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span><span class="token function">getPriceCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">case</span> <span class="token class-name">Movie</span><span class="token punctuation">.</span>REGULAR<span class="token operator">:</span>
                result <span class="token operator">+=</span> <span class="token number">2</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>daysRented <span class="token operator">&gt;</span> <span class="token number">2</span><span class="token punctuation">)</span>
                    result <span class="token operator">+=</span> <span class="token punctuation">(</span>daysRented <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1.5</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token class-name">Movie</span><span class="token punctuation">.</span>NEW_RELEASE<span class="token operator">:</span>
                result <span class="token operator">+=</span> daysRented <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token class-name">Movie</span><span class="token punctuation">.</span>CHILDRENS<span class="token operator">:</span>
                result <span class="token operator">+=</span> <span class="token number">1.5</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>daysRented <span class="token operator">&gt;</span> <span class="token number">3</span><span class="token punctuation">)</span>
                    result <span class="token operator">+=</span> <span class="token punctuation">(</span>daysRented <span class="token operator">-</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1.5</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>这样 <code>Movie</code> 中的 <code>getCharge()</code> 方法就可以直接引用 <code>Price</code> 的 <code>getCharge()</code> 方法了：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token keyword">double</span> <span class="token function">getCharge</span><span class="token punctuation">(</span><span class="token keyword">int</span> daysRented<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">return</span> _price<span class="token punctuation">.</span><span class="token function">getCharge</span><span class="token punctuation">(</span>daysRented<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>又因为每个 <code>Price</code> 的子类实现计费的方法还是放在各自类中比较合理，所以将 <code>Price</code> 的 <code>getCharge()</code> 方法分发到各自子类中去吧：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RegularPrice</span> <span class="token keyword">extends</span> <span class="token class-name">Price</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">int</span> <span class="token function">getPriceCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">Movie</span><span class="token punctuation">.</span>REGULAR<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">double</span> <span class="token function">getCharge</span><span class="token punctuation">(</span><span class="token keyword">int</span> daysRented<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">double</span> result <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>daysRented <span class="token operator">&gt;</span> <span class="token number">2</span><span class="token punctuation">)</span>
            result <span class="token operator">+=</span> <span class="token punctuation">(</span>daysRented <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1.5</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">NewReleasePrice</span> <span class="token keyword">extends</span> <span class="token class-name">Price</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">int</span> <span class="token function">getPriceCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">Movie</span><span class="token punctuation">.</span>NEW_RELEASE<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">double</span> <span class="token function">getCharge</span><span class="token punctuation">(</span><span class="token keyword">int</span> daysRented<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> daysRented <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ChildrensPrice</span> <span class="token keyword">extends</span> <span class="token class-name">Price</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">int</span> <span class="token function">getPriceCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">Movie</span><span class="token punctuation">.</span>CHILDRENS<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">double</span> <span class="token function">getCharge</span><span class="token punctuation">(</span><span class="token keyword">int</span> daysRented<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">double</span> result <span class="token operator">=</span> <span class="token number">1.5</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>daysRented <span class="token operator">&gt;</span> <span class="token number">3</span><span class="token punctuation">)</span>
            result <span class="token operator">+=</span> <span class="token punctuation">(</span>daysRented <span class="token operator">-</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1.5</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>替换完所有的子类之后，就可以将 <code>Price</code> 中的 <code>getCharge()</code> 方法声明为抽象的了：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">Price</span> <span class="token punctuation">{</span>
    
    <span class="token keyword">abstract</span> <span class="token keyword">int</span> <span class="token function">getPriceCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">abstract</span> <span class="token keyword">double</span> <span class="token function">getCharge</span><span class="token punctuation">(</span><span class="token keyword">int</span> daysRented<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>同样的手法处理 <code>Movie</code> 中的 <code>getFrequentRenterPoints()</code> 方法吧。在 <code>Price</code> 类中新增 <code>getFrequentRenterPoints()</code> 方法：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token keyword">int</span> <span class="token function">getFrequentRenterPoints</span><span class="token punctuation">(</span><span class="token keyword">int</span> daysRented<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">getPriceCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">Movie</span><span class="token punctuation">.</span>NEW_RELEASE<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> daysRented <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token number">2</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span>
            <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p><code>Movie</code> 中就可以直接调用这个方法：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token keyword">int</span> <span class="token function">getFrequentRenterPoints</span><span class="token punctuation">(</span><span class="token keyword">int</span> daysRented<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> _price<span class="token punctuation">.</span><span class="token function">getFrequentRenterPoints</span><span class="token punctuation">(</span>daysRented<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>因为 <code>getFrequentRenterPoints()</code> 方法中只对类型是 <code>Movie.NEW_RELEASE</code> 的有特殊处理，所以这次决定在 <code>Price</code> 类中保留一个默认实现，然后让 <code>NewReleasePrice</code> 类覆盖这个方法，实现它自己的逻辑即可。</p> <p><code>Movie</code> 类中的默认实现：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">Price</span> <span class="token punctuation">{</span>

    <span class="token keyword">abstract</span> <span class="token keyword">int</span> <span class="token function">getPriceCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">abstract</span> <span class="token keyword">double</span> <span class="token function">getCharge</span><span class="token punctuation">(</span><span class="token keyword">int</span> daysRented<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> <span class="token function">getFrequentRenterPoints</span><span class="token punctuation">(</span><span class="token keyword">int</span> daysRented<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p><code>NewReleasePrice</code> 类覆盖 <code>getFrequentRenterPoints()</code> 方法：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">NewReleasePrice</span> <span class="token keyword">extends</span> <span class="token class-name">Price</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">int</span> <span class="token function">getPriceCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">Movie</span><span class="token punctuation">.</span>NEW_RELEASE<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">double</span> <span class="token function">getCharge</span><span class="token punctuation">(</span><span class="token keyword">int</span> daysRented<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> daysRented <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">int</span> <span class="token function">getFrequentRenterPoints</span><span class="token punctuation">(</span><span class="token keyword">int</span> daysRented<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> daysRented <span class="token operator">&gt;</span> <span class="token number">1</span> <span class="token operator">?</span> <span class="token number">2</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>这下，如果需要修改任何与价格有关的行为，或者是添加新的计费规则，或者是加入其它决定价格的行为，程序的修改都会容易的多。</p> <div><br> <div id="vcomments"></div></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2020-08-21 09:02:51（10 小时前）</span></div></footer> <div class="page-nav"><p class="inner"><!----> <span class="next"><a href="/my-blog/refactoring_improving_the_design_of_existing_code/第2章：重构原则.html">
        第2章：重构原则
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/my-blog/assets/js/app.11c55fdf.js" defer></script><script src="/my-blog/assets/js/2.f643b0a2.js" defer></script><script src="/my-blog/assets/js/98.071b3a0f.js" defer></script><script src="/my-blog/assets/js/4.fd36f240.js" defer></script><script src="/my-blog/assets/js/5.628d6842.js" defer></script>
  </body>
</html>
